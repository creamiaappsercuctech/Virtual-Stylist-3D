<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</title>
  <meta name="theme-color" content="#0b0b12" />
  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a; --ok:#9ef7b7; --bad:#ff8a8a; --cyan:#6ee0ff;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--txt); -webkit-tap-highlight-color: transparent; }
    header{
      position:sticky; top:0; z-index:20;
      background:rgba(11,11,18,.86); backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{ background:rgba(255,213,106,.12); border-color:rgba(255,213,106,.25); }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .card .body{ padding:12px 14px; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{ background:rgba(255,213,106,.14); border-color:rgba(255,213,106,.25); }
    .btn.good{ background:rgba(158,247,183,.10); border-color:rgba(158,247,183,.25); }
    .btn.bad{ background:rgba(255,138,138,.10); border-color:rgba(255,138,138,.25); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="text"], select, textarea{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }
    textarea{ min-height:70px; resize:vertical; }
    input[type="range"]{ width:100%; }
    .miniBtns{ display:flex; gap:8px; flex-wrap:wrap; }

    /* Stage (persona + outfit) */
    .stageWrap{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background:#070710;
      border-radius:18px;
      overflow:hidden;
      width:100%;
      aspect-ratio: 3/4;
      touch-action: pan-y; /* scroll verticale ok */
    }
    @media(max-width:980px){ .stageWrap{ aspect-ratio: 9/16; } }
    .stage{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .stageInner{ position:relative; width:100%; height:100%; overflow:hidden; }
    .personLayer, .garmentLayer{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .personImg{ max-width:100%; max-height:100%; object-fit:contain; user-select:none; pointer-events:none; -webkit-user-drag:none; }

    .garment{
      position:absolute;
      border:1px dashed rgba(255,213,106,.35);
      border-radius:12px;
      background:rgba(255,255,255,.01);
      touch-action:none;
    }
    .garment.selected{ outline:2px solid rgba(255,213,106,.55); }
    .garment img{ width:100%; height:100%; object-fit:contain; display:block; pointer-events:none; user-select:none; -webkit-user-drag:none; }
    .h{
      width:18px;height:18px;border-radius:999px;
      background:rgba(110,220,255,.92);
      position:absolute;
      border:2px solid rgba(0,0,0,.35);
      box-shadow: 0 6px 18px rgba(0,0,0,.35);
      touch-action:none;
    }
    .h.tl{ left:-9px; top:-9px; }
    .h.tr{ right:-9px; top:-9px; }
    .h.bl{ left:-9px; bottom:-9px; }
    .h.br{ right:-9px; bottom:-9px; }

    .toolbar{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:10px; }
    .toolbox{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media(max-width:520px){ .toolbox{ grid-template-columns:1fr; } }

    /* Wardrobe */
    .filters{ display:flex; gap:10px; flex-wrap:wrap; }
    .chip{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:13px;
    }
    .chip.active{ background:rgba(255,213,106,.12); border-color:rgba(255,213,106,.25); }
    .wardGrid{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .wardGrid{ grid-template-columns:1fr; } }
    .wCard{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
    }
    .wThumb{
      width:92px; height:92px; border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      overflow:hidden;
      flex:0 0 auto;
      display:grid; place-items:center;
      color:var(--muted); font-size:12px;
    }
    .wThumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .wMeta{ flex:1 1 auto; min-width:0; }
    .wTitle{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .wSub{ font-size:12px; color:var(--muted); margin-top:2px; }
    .wBtns{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.55);
      display:none; align-items:center; justify-content:center;
      padding:14px;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width:min(980px, 100%);
      max-height: min(92vh, 980px);
      overflow:auto;  /* ‚úÖ scorrevole */
      -webkit-overflow-scrolling: touch;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(12,12,20,.96);
      backdrop-filter: blur(10px);
      box-shadow: 0 24px 80px rgba(0,0,0,.55);
    }
    .modalHead{
      position:sticky; top:0; z-index:2;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(12,12,20,.96);
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .xBtn{
      width:44px;height:44px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);
      cursor:pointer;
    }
    .modalBody{ padding:12px 14px 24px; } /* ‚úÖ padding basso per vedere maniglie */

    /* Crop PRO */
    .cropWrap{
      border:1px solid rgba(255,255,255,.10);
      background:#070710;
      border-radius:18px;
      overflow:hidden;
      width:100%;
      aspect-ratio: 9/16;
      position:relative;
      touch-action: pan-y;
    }
    .cropStage{ position:absolute; inset:0; }
    .cropCanvas{
      position:absolute; inset:0;
      width:100%; height:100%;
      display:block;
      background: radial-gradient(circle at 30% 20%, rgba(255,213,106,.06), transparent 45%),
                  radial-gradient(circle at 70% 70%, rgba(110,255,168,.05), transparent 50%);
      touch-action: pan-y;
    }
    .cropRect{
      position:absolute;
      border:2px solid rgba(110,224,255,.85);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.35); /* oscuramento fuori */
      border-radius:14px;
      touch-action:none;
    }
    .cropHandle{
      width:22px;height:22px;border-radius:999px;
      background:rgba(110,224,255,.95);
      position:absolute;
      border:2px solid rgba(0,0,0,.35);
      box-shadow: 0 8px 22px rgba(0,0,0,.35);
      touch-action:none;
    }
    .cropHandle.tl{ left:-11px; top:-11px; }
    .cropHandle.tr{ right:-11px; top:-11px; }
    .cropHandle.bl{ left:-11px; bottom:-11px; }
    .cropHandle.br{ right:-11px; bottom:-11px; }

    #errBox, #okBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      border-radius:14px; padding:10px 12px; display:none;
      white-space:pre-wrap; font-size:12px;
    }
    #errBox{ border:1px solid rgba(255,110,110,.35); background:rgba(255,110,110,.08); }
    #okBox{ border:1px solid rgba(158,247,183,.35); background:rgba(158,247,183,.08); }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Persona 4 viste + Guardaroba + Ritaglio PRO + Rotazione 360 + Fullscreen + OCR (opzionale)</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">OK</b></span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="studio" class="section active">
    <div class="grid">
      <div class="card">
        <h2>
          <span>Persona vestita + Rotazione</span>
          <span class="sub">fronte ‚Üí fianco dx ‚Üí retro ‚Üí fianco sx</span>
        </h2>
        <div class="body">
          <div class="stageWrap" id="stageWrap">
            <div class="stage">
              <div class="stageInner" id="stageInner">
                <div class="personLayer">
                  <img id="personImg" class="personImg" alt="persona" />
                </div>
                <div class="garmentLayer" id="garmentLayer"></div>
              </div>
            </div>
          </div>

          <div class="toolbar">
            <button class="btn primary" id="btnLoadPerson">üì∑ Carica persona (4 viste)</button>
            <button class="btn" id="btnFullscreen">‚õ∂ Fullscreen (in/out)</button>
            <span class="pill">Vista: <b id="viewLabel">FRONTE</b></span>
            <span class="pill">Auto-gira: <b id="spinLabel">OFF</b></span>
          </div>

          <div class="toolbox" style="margin-top:10px">
            <div>
              <label>Rotazione</label>
              <div class="row">
                <button class="btn" id="btnPrev">‚óÄÔ∏é Indietro</button>
                <button class="btn" id="btnNext">Avanti ‚ñ∂Ô∏é</button>
                <button class="btn good" id="btnSpin">‚ü≤ Auto-gira</button>
              </div>
            </div>
            <div>
              <label>Outfit</label>
              <div class="row">
                <button class="btn" id="btnClearOutfit">üßº Togli capi</button>
                <button class="btn" id="btnResetFit">‚Ü©Ô∏è Reset posizioni</button>
              </div>
            </div>
          </div>

          <label style="margin-top:10px">Sfoca persona (nasconde vestiti originali)</label>
          <input id="blurPerson" type="range" min="0" max="12" step="1" value="0" />
        </div>
      </div>

      <div class="card">
        <h2><span>Azioni rapide</span><span class="sub">click capo ‚Üí va addosso</span></h2>
        <div class="body">
          <div class="row">
            <button class="btn primary" id="btnAddGarment">üëó Aggiungi capo (ritaglio PRO)</button>
            <button class="btn" id="btnGoWardrobe">üß• Vai al guardaroba</button>
          </div>

          <label style="margin-top:10px">Scala generale capi</label>
          <input id="globalScale" type="range" min="60" max="140" step="1" value="100" />
          <span class="pill">Scala: <b id="globalScaleVal">100%</b></span>

          <label style="margin-top:10px">Selezione capo in scena</label>
          <div class="row">
            <button class="btn" id="btnBringFront">‚¨ÜÔ∏è Porta davanti</button>
            <button class="btn" id="btnSendBack">‚¨áÔ∏è Porta dietro</button>
            <button class="btn bad" id="btnDeleteSelected">üóëÔ∏è Elimina</button>
          </div>

          <div style="height:12px"></div>
          <div class="sub">Tip: trascina il capo e usa le 4 maniglie per ridimensionare. (Android OK)</div>
        </div>
      </div>
    </div>
  </section>

  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba</span><span class="sub">salva capi puliti (ritaglio)</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnAddGarment2">üëó Aggiungi capo</button>
          <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
          <button class="btn bad" id="btnClearWardrobe">üßπ Svuota</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:10px"></div>
        <div class="filters">
          <div class="chip active" data-filter="all">Tutti</div>
          <div class="chip" data-filter="top">Sopra</div>
          <div class="chip" data-filter="bottom">Sotto</div>
          <div class="chip" data-filter="dress">Intero</div>
          <div class="chip" data-filter="shoes">Scarpe</div>
          <div class="chip" data-filter="accessory">Accessori</div>
        </div>

        <div style="height:12px"></div>
        <div class="wardGrid" id="wardGrid"></div>
      </div>
    </div>
  </section>

  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida</span><span class="sub">passi</span></h2>
      <div class="body">
        <div class="sub" style="font-size:13px; line-height:1.55">
          1) Studio ‚Üí ‚ÄúCarica persona (4 viste)‚Äù<br/>
          2) Guardaroba ‚Üí ‚ÄúAggiungi capo‚Äù ‚Üí fai ritaglio PRO e salva (senza barra Amazon)<br/>
          3) Guardaroba ‚Üí ‚ÄúMetti addosso‚Äù (auto-fit) ‚Üí se serve trascina / maniglie<br/>
          4) Rotazione: avanti/indietro o auto-gira
        </div>
      </div>
    </div>
  </section>
</main>

<div id="errBox"></div>
<div id="okBox"></div>

<!-- PERSON MODAL -->
<div class="modal" id="personModal">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Carica persona (4 viste)</div>
        <div class="sub">FRONTE / FIANCO DX / RETRO / FIANCO SX (anche solo FRONTE va bene)</div>
      </div>
      <button class="xBtn" id="closePersonModal">‚úï</button>
    </div>
    <div class="modalBody">
      <label>FRONTE</label><input type="file" accept="image/*" id="personFront" />
      <label>FIANCO DX</label><input type="file" accept="image/*" id="personRight" />
      <label>RETRO</label><input type="file" accept="image/*" id="personBack" />
      <label>FIANCO SX</label><input type="file" accept="image/*" id="personLeft" />
      <div class="row" style="margin-top:10px">
        <button class="btn primary" id="btnSavePerson">Salva persona</button>
        <button class="btn bad" id="btnClearPerson">Rimuovi</button>
      </div>
    </div>
  </div>
</div>

<!-- GARMENT MODAL (CROP PRO + OCR) -->
<div class="modal" id="garmentModal">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Aggiungi/Modifica capo</div>
        <div class="sub">Ritaglio PRO (maniglie) + ‚Äútogli bianco‚Äù + OCR opzionale</div>
      </div>
      <button class="xBtn" id="closeGarmentModal">‚úï</button>
    </div>

    <div class="modalBody">
      <label>Seleziona immagine (screenshot Amazon ok)</label>
      <input type="file" accept="image/*" id="garmentFile" />

      <div style="height:10px"></div>
      <div class="cropWrap" id="cropWrap">
        <div class="cropStage" id="cropStage">
          <canvas class="cropCanvas" id="cropCanvas"></canvas>
          <div class="cropRect" id="cropRect" style="display:none">
            <div class="cropHandle tl" data-h="tl"></div>
            <div class="cropHandle tr" data-h="tr"></div>
            <div class="cropHandle bl" data-h="bl"></div>
            <div class="cropHandle br" data-h="br"></div>
          </div>
        </div>
      </div>

      <div class="toolbox" style="margin-top:12px">
        <div>
          <label>Zoom immagine</label>
          <input id="zoom" type="range" min="50" max="220" step="1" value="100" />
          <span class="pill">Zoom: <b id="zoomVal">100%</b></span>
        </div>
        <div>
          <label>Soglia ‚Äútogli bianco‚Äù (bordi bianchi ‚Üí trasparente)</label>
          <input id="whiteKey" type="range" min="0" max="80" step="1" value="18" />
          <span class="pill">Bianco: <b id="whiteKeyVal">18</b></span>
        </div>
      </div>

      <div class="row" style="margin-top:10px">
        <button class="btn" id="btnFitCrop">üîé Adatta capo</button>
        <button class="btn" id="btnNewCrop">üß© Nuovo ritaglio</button>
        <button class="btn" id="btnResetCrop">‚Ü©Ô∏è Reset</button>
      </div>

      <label style="margin-top:12px">Testo (Nome capo) + bottoni seleziona/copia/incolla</label>
      <div class="miniBtns">
        <button class="btn" id="btnSelectText">Seleziona</button>
        <button class="btn" id="btnCopyText">Copia</button>
        <button class="btn" id="btnPasteText">Incolla</button>
        <button class="btn good" id="btnOCR" title="Legge testo dal ritaglio (internet necessario)">OCR dal ritaglio</button>
      </div>
      <input id="gName" type="text" placeholder="es. Vestito casual (puoi incollare da OCR)" />

      <label>Tipo capo</label>
      <select id="gType">
        <option value="top">Camicia / Maglia (TOP)</option>
        <option value="bottom">Pantalone / Gonna (BOTTOM)</option>
        <option value="dress">Abito intero (DRESS)</option>
        <option value="shoes">Scarpe (SHOES)</option>
        <option value="accessory">Accessorio (ACCESSORY)</option>
      </select>

      <label>Vista che stai salvando</label>
      <select id="gView">
        <option value="front">FRONTE</option>
        <option value="right">FIANCO DX</option>
        <option value="back">RETRO</option>
        <option value="left">FIANCO SX</option>
      </select>

      <div class="row" style="justify-content:space-between; margin-top:12px">
        <span class="sub">Salva SOLO la zona ritagliata (pulita) nel guardaroba</span>
        <button class="btn primary" id="btnSaveGarment">Salva nel guardaroba</button>
      </div>

      <div class="sub" style="margin-top:10px">
        Tip: fai screenshot Amazon ‚Üí qui ritagli SOLO il capo (senza barra/telefono). Poi ‚ÄúMetti addosso‚Äù.
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");
  const okBox  = document.getElementById("okBox");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    setTimeout(()=> errBox.style.display = "none", 6500);
    status.textContent = "Errore";
  }
  function showOk(msg){
    okBox.style.display = "block";
    okBox.textContent = msg;
    setTimeout(()=> okBox.style.display = "none", 2200);
    status.textContent = "OK";
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida"),
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
    window.scrollTo({top:0, behavior:"instant"});
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // Storage
  const KEY = "sercuctech_vs2d_pro_final_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.person ??= { front:null, right:null, back:null, left:null };
  state.wardrobe ??= [];
  state.scene ??= { applied: [], currentView:"front", blurPerson:0, globalScale:100 };
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // Views
  const VIEWS = ["front","right","back","left"];
  const VIEW_LABEL = {front:"FRONTE", right:"FIANCO DX", back:"RETRO", left:"FIANCO SX"};
  let currentView = state.scene.currentView || "front";
  let spinning = false;
  let spinTimer = null;
  const viewLabel = document.getElementById("viewLabel");
  const spinLabel = document.getElementById("spinLabel");

  function setView(v){
    currentView = v;
    state.scene.currentView = v;
    save();
    viewLabel.textContent = VIEW_LABEL[v] || "FRONTE";
    renderPerson();
    renderApplied();
  }
  document.getElementById("btnPrev").addEventListener("click", ()=>{
    const idx = VIEWS.indexOf(currentView);
    setView(VIEWS[(idx - 1 + VIEWS.length) % VIEWS.length]);
  });
  document.getElementById("btnNext").addEventListener("click", ()=>{
    const idx = VIEWS.indexOf(currentView);
    setView(VIEWS[(idx + 1) % VIEWS.length]);
  });
  function stopSpin(){
    spinning = false;
    spinLabel.textContent = "OFF";
    if(spinTimer) clearInterval(spinTimer);
    spinTimer = null;
  }
  function startSpin(){
    stopSpin();
    spinning = true;
    spinLabel.textContent = "ON";
    spinTimer = setInterval(()=>{
      const idx = VIEWS.indexOf(currentView);
      setView(VIEWS[(idx + 1) % VIEWS.length]);
    }, 900);
  }
  document.getElementById("btnSpin").addEventListener("click", ()=>{
    if(spinning) stopSpin(); else startSpin();
  });

  // Fullscreen
  const btnFullscreen = document.getElementById("btnFullscreen");
  const stageWrap = document.getElementById("stageWrap");
  function isFs(){ return document.fullscreenElement || document.webkitFullscreenElement; }
  async function toggleFs(){
    try{
      if(!isFs()){
        await (stageWrap.requestFullscreen?.() || stageWrap.webkitRequestFullscreen?.());
      }else{
        await (document.exitFullscreen?.() || document.webkitExitFullscreen?.());
      }
    }catch(e){ showErr("Fullscreen non disponibile: " + e); }
  }
  btnFullscreen.addEventListener("click", toggleFs);

  // Person
  const personImg = document.getElementById("personImg");
  function pickPersonForView(v){
    const p = state.person || {};
    return p[v] || p.front || null;
  }
  function renderPerson(){
    const src = pickPersonForView(currentView);
    if(!src){
      personImg.removeAttribute("src");
      personImg.style.opacity = "0";
      status.textContent = "OK (carica persona)";
      return;
    }
    personImg.src = src;
    personImg.style.opacity = "1";
    status.textContent = "OK";
  }

  // Blur
  const blurPerson = document.getElementById("blurPerson");
  blurPerson.value = String(state.scene.blurPerson ?? 0);
  function applyBlur(){
    const v = Number(blurPerson.value);
    state.scene.blurPerson = v;
    save();
    personImg.style.filter = v ? `blur(${v}px)` : "none";
  }
  blurPerson.addEventListener("input", applyBlur);
  applyBlur();

  // Scene
  const garmentLayer = document.getElementById("garmentLayer");
  const stageInner = document.getElementById("stageInner");
  let selectedOverlayId = null;

  function uid(){ return Math.random().toString(16).slice(2) + Date.now().toString(16); }
  function stageRect(){ return stageInner.getBoundingClientRect(); }
  function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

  const FIT_PRESET = {
    top:     { x:.22, y:.18, w:.56, h:.42 },
    bottom:  { x:.23, y:.50, w:.54, h:.46 },
    dress:   { x:.20, y:.16, w:.60, h:.74 },
    shoes:   { x:.28, y:.80, w:.44, h:.20 },
    accessory:{x:.35, y:.12, w:.30, h:.22 },
  };

  function normToPxRect(n){
    const r = stageRect();
    return { x:n.x*r.width, y:n.y*r.height, w:n.w*r.width, h:n.h*r.height };
  }
  function pxToNormRect(px){
    const r = stageRect();
    return {
      x: clamp(px.x / r.width, 0, 1),
      y: clamp(px.y / r.height, 0, 1),
      w: clamp(px.w / r.width, 0.05, 1),
      h: clamp(px.h / r.height, 0.05, 1),
    };
  }

  function overlayImageFor(item, view){
    return item.views?.[view] || item.views?.front || null;
  }

  // global scale
  const globalScale = document.getElementById("globalScale");
  const globalScaleVal = document.getElementById("globalScaleVal");
  globalScale.value = String(state.scene.globalScale ?? 100);
  function applyGlobalScale(){
    state.scene.globalScale = Number(globalScale.value);
    globalScaleVal.textContent = `${globalScale.value}%`;
    save();
    renderApplied();
  }
  globalScale.addEventListener("input", applyGlobalScale);
  applyGlobalScale();

  function applyItemToScene(itemId){
    const item = state.wardrobe.find(x => x.id === itemId);
    if(!item){ showErr("Capo non trovato."); return; }
    const imgSrc = overlayImageFor(item, currentView);
    if(!imgSrc){ showErr("Questo capo non ha immagine per questa vista. Salva anche la vista " + VIEW_LABEL[currentView] + "."); return; }

    if(item.type === "dress"){
      state.scene.applied = state.scene.applied.filter(o => !["top","bottom"].includes(o.type));
    } else if(item.type === "top" || item.type === "bottom"){
      state.scene.applied = state.scene.applied.filter(o => o.type !== "dress");
    }
    state.scene.applied = state.scene.applied.filter(o => o.type !== item.type);

    const preset = FIT_PRESET[item.type] || FIT_PRESET.top;
    const scale = (state.scene.globalScale || 100) / 100;
    const rect = { ...preset };
    const cx = rect.x + rect.w/2, cy = rect.y + rect.h/2;
    rect.w *= scale; rect.h *= scale;
    rect.x = cx - rect.w/2; rect.y = cy - rect.h/2;

    state.scene.applied.push({
      id: uid(),
      itemId: item.id,
      type: item.type,
      z: Date.now(),
      rect
    });
    save();
    renderApplied();
    setTab("studio");
    showOk(`‚úÖ "${item.name || "Capo"}" messo addosso`);
  }

  function renderApplied(){
    garmentLayer.innerHTML = "";
    const applied = [...(state.scene.applied || [])].sort((a,b)=> (a.z||0)-(b.z||0));

    applied.forEach(o=>{
      const item = state.wardrobe.find(x => x.id === o.itemId);
      if(!item) return;
      const imgSrc = overlayImageFor(item, currentView);
      if(!imgSrc) return;

      const el = document.createElement("div");
      el.className = "garment" + (o.id === selectedOverlayId ? " selected" : "");
      el.dataset.id = o.id;

      const px = normToPxRect(o.rect);
      el.style.left = px.x + "px";
      el.style.top  = px.y + "px";
      el.style.width  = px.w + "px";
      el.style.height = px.h + "px";

      const img = document.createElement("img");
      img.src = imgSrc;
      img.alt = item.name || "capo";
      el.appendChild(img);

      const handles = document.createElement("div");
      ["tl","tr","bl","br"].forEach(c=>{
        const h = document.createElement("div");
        h.className = "h " + c;
        h.dataset.handle = c;
        handles.appendChild(h);
      });
      el.appendChild(handles);

      el.addEventListener("pointerdown", (e)=>{
        selectedOverlayId = o.id;
        save();
        renderApplied();
        e.stopPropagation();
      }, {passive:true});

      makeDragResizeStable(el, o.id);
      garmentLayer.appendChild(el);
    });
  }

  // ‚úÖ Drag/resize stabile Android (scroll bloccato SOLO mentre trascini)
  function makeDragResizeStable(el, overlayId){
    let mode = null;
    let handle = null;
    let startX=0, startY=0;
    let startRect=null;
    let dragging = false;

    function getOverlay(){ return state.scene.applied.find(x=> x.id === overlayId); }

    function onDown(e){
      const o = getOverlay();
      if(!o) return;

      const h = e.target?.dataset?.handle;
      mode = h ? "resize" : "move";
      handle = h || null;

      startX = e.clientX;
      startY = e.clientY;
      startRect = normToPxRect(o.rect);
      dragging = true;

      e.preventDefault();

      window.addEventListener("pointermove", onMove, {passive:false});
      window.addEventListener("pointerup", onUp, {passive:false});
      window.addEventListener("pointercancel", onUp, {passive:false});
    }

    function onMove(e){
      if(!dragging || !mode || !startRect) return;
      const o = getOverlay(); if(!o) return;

      const dx = e.clientX - startX;
      const dy = e.clientY - startY;

      let px = {...startRect};
      if(mode==="move"){
        px.x += dx; px.y += dy;
      }else{
        const minSize = 40;
        if(handle==="tl"){ px.x += dx; px.y += dy; px.w -= dx; px.h -= dy; }
        else if(handle==="tr"){ px.y += dy; px.w += dx; px.h -= dy; }
        else if(handle==="bl"){ px.x += dx; px.w -= dx; px.h += dy; }
        else if(handle==="br"){ px.w += dx; px.h += dy; }
        px.w = Math.max(minSize, px.w);
        px.h = Math.max(minSize, px.h);
      }

      const r = stageRect();
      px.x = clamp(px.x, 0, r.width - px.w);
      px.y = clamp(px.y, 0, r.height - px.h);

      o.rect = pxToNormRect(px);
      save();

      el.style.left = px.x + "px";
      el.style.top  = px.y + "px";
      el.style.width  = px.w + "px";
      el.style.height = px.h + "px";

      e.preventDefault();
    }

    function onUp(e){
      dragging = false; mode=null; handle=null; startRect=null;
      window.removeEventListener("pointermove", onMove);
      window.removeEventListener("pointerup", onUp);
      window.removeEventListener("pointercancel", onUp);
      renderApplied();
      e.preventDefault?.();
    }

    el.addEventListener("pointerdown", onDown, {passive:false});
  }

  // Buttons
  document.getElementById("btnClearOutfit").addEventListener("click", ()=>{
    state.scene.applied = []; selectedOverlayId = null; save(); renderApplied();
  });
  document.getElementById("btnResetFit").addEventListener("click", ()=>{
    state.scene.applied.forEach(o=>{ o.rect = {...(FIT_PRESET[o.type] || FIT_PRESET.top)}; });
    save(); renderApplied(); showOk("‚Ü©Ô∏è Posizioni ripristinate");
  });
  document.getElementById("btnBringFront").addEventListener("click", ()=>{
    const o = state.scene.applied.find(x=> x.id === selectedOverlayId);
    if(!o) return; o.z = Date.now(); save(); renderApplied();
  });
  document.getElementById("btnSendBack").addEventListener("click", ()=>{
    const o = state.scene.applied.find(x=> x.id === selectedOverlayId);
    if(!o) return; o.z = 1; save(); renderApplied();
  });
  document.getElementById("btnDeleteSelected").addEventListener("click", ()=>{
    if(!selectedOverlayId) return;
    state.scene.applied = state.scene.applied.filter(x => x.id !== selectedOverlayId);
    selectedOverlayId = null; save(); renderApplied();
  });
  stageInner.addEventListener("pointerdown", ()=>{
    selectedOverlayId = null; save(); renderApplied();
  }, {passive:true});

  // Wardrobe
  const wardGrid = document.getElementById("wardGrid");
  const wardCount = document.getElementById("wardCount");
  let wardFilter = "all";

  function typeLabel(t){
    return t==="top"?"Sopra":t==="bottom"?"Sotto":t==="dress"?"Intero":t==="shoes"?"Scarpe":"Accessori";
  }
  function countViews(it){
    const v = it.views || {};
    return ["front","right","back","left"].filter(k => !!v[k]).length;
  }
  function renderWardrobe(){
    wardGrid.innerHTML = "";
    wardCount.textContent = String(state.wardrobe.length);

    const list = state.wardrobe.filter(it => wardFilter==="all" ? true : it.type===wardFilter);
    if(list.length === 0){
      const empty = document.createElement("div");
      empty.className = "sub";
      empty.textContent = "Nessun capo. Premi ‚ÄúAggiungi capo‚Äù.";
      wardGrid.appendChild(empty);
      return;
    }

    list.sort((a,b)=> (b.createdAt||0)-(a.createdAt||0)).forEach(it=>{
      const card = document.createElement("div");
      card.className = "wCard";

      const thumb = document.createElement("div");
      thumb.className = "wThumb";
      const timg = document.createElement("img");
      const src = it.views?.front || it.views?.right || it.views?.back || it.views?.left || "";
      if(src){ timg.src = src; thumb.appendChild(timg); }
      else thumb.textContent = "NO IMG";

      const meta = document.createElement("div");
      meta.className = "wMeta";

      const title = document.createElement("div");
      title.className = "wTitle";
      title.textContent = it.name || "Capo";

      const sub = document.createElement("div");
      sub.className = "wSub";
      sub.textContent = `${typeLabel(it.type)} ‚Ä¢ viste: ${countViews(it)}/4`;

      const btns = document.createElement("div");
      btns.className = "wBtns";

      const wear = document.createElement("button");
      wear.className = "btn primary";
      wear.textContent = "Metti addosso";
      wear.addEventListener("click", ()=> applyItemToScene(it.id));

      const del = document.createElement("button");
      del.className = "btn bad";
      del.textContent = "Elimina";
      del.addEventListener("click", ()=>{
        state.wardrobe = state.wardrobe.filter(x => x.id !== it.id);
        state.scene.applied = state.scene.applied.filter(o => o.itemId !== it.id);
        save(); renderWardrobe(); renderApplied();
      });

      btns.appendChild(wear);
      btns.appendChild(del);

      meta.appendChild(title);
      meta.appendChild(sub);
      meta.appendChild(btns);

      card.appendChild(thumb);
      card.appendChild(meta);
      wardGrid.appendChild(card);
    });
  }

  // filters
  const chips = [...document.querySelectorAll(".chip")];
  chips.forEach(c=>{
    c.addEventListener("click", ()=>{
      chips.forEach(x=> x.classList.toggle("active", x===c));
      wardFilter = c.dataset.filter;
      renderWardrobe();
    });
  });

  // Demo
  function svgData(label){
    const s = encodeURIComponent(`
      <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
        <rect width="100%" height="100%" fill="#0b0b12"/>
        <rect x="32" y="32" width="448" height="448" rx="40" fill="rgba(255,213,106,.12)" stroke="rgba(255,255,255,.12)"/>
        <text x="50%" y="50%" fill="rgba(255,255,255,.85)" font-family="system-ui" font-size="44" text-anchor="middle" dominant-baseline="middle" font-weight="800">${label}</text>
      </svg>
    `);
    return `data:image/svg+xml;charset=utf-8,${s}`;
  }
  document.getElementById("btnLoadDemo").addEventListener("click", ()=>{
    state.wardrobe = [
      {id:uid(), name:"T-shirt basic (demo)", type:"top", createdAt:Date.now(), views:{front:svgData("TOP")}},
      {id:uid(), name:"Jeans (demo)", type:"bottom", createdAt:Date.now()-1, views:{front:svgData("PANT")}},
      {id:uid(), name:"Vestito (demo)", type:"dress", createdAt:Date.now()-2, views:{front:svgData("DRESS")}}
    ];
    save(); renderWardrobe(); showOk("üì¶ Demo caricata");
  });
  document.getElementById("btnClearWardrobe").addEventListener("click", ()=>{
    state.wardrobe = []; state.scene.applied = []; save(); renderWardrobe(); renderApplied();
  });

  // Modals
  const personModal = document.getElementById("personModal");
  document.getElementById("btnLoadPerson").addEventListener("click", ()=> personModal.classList.add("open"));
  document.getElementById("closePersonModal").addEventListener("click", ()=> personModal.classList.remove("open"));
  personModal.addEventListener("click", (e)=>{ if(e.target===personModal) personModal.classList.remove("open"); });

  const garmentModal = document.getElementById("garmentModal");
  function openGarmentModal(){ garmentModal.classList.add("open"); }
  document.getElementById("btnAddGarment").addEventListener("click", openGarmentModal);
  document.getElementById("btnAddGarment2").addEventListener("click", openGarmentModal);
  document.getElementById("closeGarmentModal").addEventListener("click", ()=> garmentModal.classList.remove("open"));
  garmentModal.addEventListener("click", (e)=>{ if(e.target===garmentModal) garmentModal.classList.remove("open"); });
  document.getElementById("btnGoWardrobe").addEventListener("click", ()=> setTab("guardaroba"));

  // Helpers
  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(fr.result);
      fr.onerror = reject;
      fr.readAsDataURL(file);
    });
  }
  async function dataURLToImage(dataURL){
    return new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=> resolve(img);
      img.onerror = reject;
      img.src = dataURL;
    });
  }

  // Save person
  document.getElementById("btnSavePerson").addEventListener("click", async ()=>{
    try{
      const f = document.getElementById("personFront").files[0];
      const r = document.getElementById("personRight").files[0];
      const b = document.getElementById("personBack").files[0];
      const l = document.getElementById("personLeft").files[0];

      if(!f && !state.person.front){ showErr("Carica almeno FRONTE."); return; }

      if(f) state.person.front = await fileToDataURL(f);
      if(r) state.person.right = await fileToDataURL(r);
      if(b) state.person.back  = await fileToDataURL(b);
      if(l) state.person.left  = await fileToDataURL(l);

      save();
      personModal.classList.remove("open");
      renderPerson();
      showOk("‚úÖ Persona salvata");
    }catch(e){ showErr("Errore persona: " + e); }
  });
  document.getElementById("btnClearPerson").addEventListener("click", ()=>{
    state.person = {front:null,right:null,back:null,left:null};
    save(); renderPerson(); showOk("üßº Persona rimossa");
  });

  // ===== CROP PRO + OCR =====
  const garmentFile = document.getElementById("garmentFile");
  const cropCanvas = document.getElementById("cropCanvas");
  const cropWrap   = document.getElementById("cropWrap");
  const cropRectEl = document.getElementById("cropRect");
  const zoom = document.getElementById("zoom");
  const zoomVal = document.getElementById("zoomVal");
  const whiteKey = document.getElementById("whiteKey");
  const whiteKeyVal = document.getElementById("whiteKeyVal");

  let srcImg = null;       // Image()
  let srcW=0, srcH=0;      // px
  let imgX=0, imgY=0;      // canvas coords
  let scale=1;             // zoom scale
  let crop = {x:80,y:120,w:220,h:360}; // canvas coords
  let draggingMode=null;   // "img" | "crop" | "handle"
  let dragHandle=null;
  let start = {x:0,y:0, imgX:0, imgY:0, crop:null};

  function resizeCropCanvas(){
    const r = cropWrap.getBoundingClientRect();
    const dpr = Math.max(1, Math.min(2, window.devicePixelRatio||1));
    cropCanvas.width  = Math.floor(r.width * dpr);
    cropCanvas.height = Math.floor(r.height * dpr);
    cropCanvas.style.width = r.width + "px";
    cropCanvas.style.height = r.height + "px";
    drawCrop();
    placeCropRect();
  }

  function drawCrop(){
    const ctx = cropCanvas.getContext("2d");
    const W = cropCanvas.width, H = cropCanvas.height;
    ctx.clearRect(0,0,W,H);

    // background grid
    ctx.save();
    ctx.globalAlpha = 0.25;
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.lineWidth = 1;
    const step = 40;
    for(let x=0;x<W;x+=step){ ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,H); ctx.stroke(); }
    for(let y=0;y<H;y+=step){ ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(W,y); ctx.stroke(); }
    ctx.restore();

    if(!srcImg) return;

    // draw image
    ctx.save();
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(srcImg, imgX, imgY, srcW*scale, srcH*scale);
    ctx.restore();
  }

  function placeCropRect(){
    const r = cropWrap.getBoundingClientRect();
    if(!srcImg){
      cropRectEl.style.display = "none";
      return;
    }
    cropRectEl.style.display = "block";

    // convert from canvas pixel to css pixel
    const dpr = cropCanvas.width / r.width;
    const cssX = crop.x / dpr;
    const cssY = crop.y / dpr;
    const cssW = crop.w / dpr;
    const cssH = crop.h / dpr;

    cropRectEl.style.left = cssX + "px";
    cropRectEl.style.top  = cssY + "px";
    cropRectEl.style.width  = cssW + "px";
    cropRectEl.style.height = cssH + "px";
  }

  function clampCrop(){
    const r = cropWrap.getBoundingClientRect();
    const dpr = cropCanvas.width / r.width;
    const W = cropCanvas.width, H = cropCanvas.height;
    const min = 80*dpr;

    crop.w = Math.max(min, crop.w);
    crop.h = Math.max(min, crop.h);

    crop.x = clamp(crop.x, 0, W - crop.w);
    crop.y = clamp(crop.y, 0, H - crop.h);
  }

  function fitCropToCenter(){
    const W = cropCanvas.width, H = cropCanvas.height;
    const dpr = cropCanvas.width / cropWrap.getBoundingClientRect().width;
    crop = { x: W*0.18, y: H*0.12, w: W*0.64, h: H*0.76 };
    clampCrop();
    drawCrop(); placeCropRect();
  }

  function resetCropAll(){
    if(!srcImg) return;
    const r = cropWrap.getBoundingClientRect();
    const dpr = cropCanvas.width / r.width;

    // center image with "contain"
    const W = cropCanvas.width, H = cropCanvas.height;
    const s1 = W / srcW;
    const s2 = H / srcH;
    scale = Math.min(s1, s2) * (Number(zoom.value)/100);

    const drawW = srcW*scale;
    const drawH = srcH*scale;
    imgX = (W - drawW)/2;
    imgY = (H - drawH)/2;

    fitCropToCenter();
  }

  function setZoom(z){
    zoom.value = String(z);
    zoomVal.textContent = `${z}%`;
    if(!srcImg) return;
    resetCropAll(); // stabile: ricalcola posizione
  }

  zoom.addEventListener("input", ()=>{
    zoomVal.textContent = `${zoom.value}%`;
    if(!srcImg) return;
    // non resettiamo crop, aggiorniamo solo scale mantenendo centro
    const r = cropWrap.getBoundingClientRect();
    const W = cropCanvas.width, H = cropCanvas.height;

    const newScaleFactor = (Number(zoom.value)/100);
    // base contain scale
    const s1 = W / srcW;
    const s2 = H / srcH;
    const base = Math.min(s1, s2);
    const newScale = base * newScaleFactor;

    // mantieni centro immagine
    const oldDrawW = srcW*scale, oldDrawH = srcH*scale;
    const cx = imgX + oldDrawW/2;
    const cy = imgY + oldDrawH/2;

    scale = newScale;
    const drawW = srcW*scale, drawH = srcH*scale;
    imgX = cx - drawW/2;
    imgY = cy - drawH/2;

    drawCrop();
    placeCropRect();
  });

  whiteKey.addEventListener("input", ()=>{
    whiteKeyVal.textContent = String(whiteKey.value);
  });

  document.getElementById("btnFitCrop").addEventListener("click", ()=>{
    if(!srcImg) return;
    fitCropToCenter();
    showOk("üîé Ritaglio adattato");
  });
  document.getElementById("btnNewCrop").addEventListener("click", ()=>{
    if(!srcImg) return;
    fitCropToCenter();
    showOk("üß© Nuovo ritaglio");
  });
  document.getElementById("btnResetCrop").addEventListener("click", ()=>{
    if(!srcImg) return;
    setZoom(100);
    whiteKey.value = "18"; whiteKeyVal.textContent = "18";
    resetCropAll();
    showOk("‚Ü©Ô∏è Reset");
  });

  function eventToCanvasXY(e){
    const r = cropWrap.getBoundingClientRect();
    const dpr = cropCanvas.width / r.width;
    const x = (e.clientX - r.left) * dpr;
    const y = (e.clientY - r.top) * dpr;
    return {x,y};
  }

  // Drag immagine (tocchi sul canvas fuori dal crop) + drag crop rect + resize handles
  cropCanvas.addEventListener("pointerdown", (e)=>{
    if(!srcImg) return;
    const p = eventToCanvasXY(e);

    // se dentro crop => muove crop
    const insideCrop = (p.x>=crop.x && p.x<=crop.x+crop.w && p.y>=crop.y && p.y<=crop.y+crop.h);
    draggingMode = insideCrop ? "crop" : "img";
    start = {x:p.x,y:p.y,imgX, imgY, crop:{...crop}};
    e.preventDefault();

    window.addEventListener("pointermove", onCropMove, {passive:false});
    window.addEventListener("pointerup", onCropUp, {passive:false});
    window.addEventListener("pointercancel", onCropUp, {passive:false});
  }, {passive:false});

  // handles
  cropRectEl.addEventListener("pointerdown", (e)=>{
    if(!srcImg) return;
    const h = e.target?.dataset?.h;
    if(!h) return; // click sul bordo -> gestito dal canvas
    const p = eventToCanvasXY(e);
    draggingMode = "handle";
    dragHandle = h;
    start = {x:p.x,y:p.y,imgX, imgY, crop:{...crop}};
    e.preventDefault();

    window.addEventListener("pointermove", onCropMove, {passive:false});
    window.addEventListener("pointerup", onCropUp, {passive:false});
    window.addEventListener("pointercancel", onCropUp, {passive:false});
  }, {passive:false});

  function onCropMove(e){
    if(!srcImg || !draggingMode) return;
    const p = eventToCanvasXY(e);
    const dx = p.x - start.x;
    const dy = p.y - start.y;

    if(draggingMode==="img"){
      imgX = start.imgX + dx;
      imgY = start.imgY + dy;
      drawCrop(); // cropRect non cambia
      placeCropRect();
    }
    else if(draggingMode==="crop"){
      crop.x = start.crop.x + dx;
      crop.y = start.crop.y + dy;
      clampCrop();
      drawCrop(); placeCropRect();
    }
    else if(draggingMode==="handle"){
      const c = {...start.crop};
      const min = 80 * (cropCanvas.width / cropWrap.getBoundingClientRect().width);
      if(dragHandle==="tl"){ c.x += dx; c.y += dy; c.w -= dx; c.h -= dy; }
      if(dragHandle==="tr"){ c.y += dy; c.w += dx; c.h -= dy; }
      if(dragHandle==="bl"){ c.x += dx; c.w -= dx; c.h += dy; }
      if(dragHandle==="br"){ c.w += dx; c.h += dy; }

      c.w = Math.max(min, c.w);
      c.h = Math.max(min, c.h);

      crop = c;
      clampCrop();
      drawCrop(); placeCropRect();
    }

    e.preventDefault();
  }

  function onCropUp(e){
    draggingMode=null;
    dragHandle=null;
    window.removeEventListener("pointermove", onCropMove);
    window.removeEventListener("pointerup", onCropUp);
    window.removeEventListener("pointercancel", onCropUp);
    e.preventDefault?.();
  }

  // Load garment image
  garmentFile.addEventListener("change", async ()=>{
    try{
      const f = garmentFile.files[0];
      if(!f) return;
      const data = await fileToDataURL(f);
      srcImg = await dataURLToImage(data);
      srcW = srcImg.naturalWidth;
      srcH = srcImg.naturalHeight;
      await new Promise(r=>setTimeout(r,10));
      resizeCropCanvas();
      setZoom(100);
      resetCropAll();
      showOk("‚úÖ Immagine caricata: fai ritaglio");
    }catch(e){
      showErr("Errore caricamento immagine: " + e);
    }
  });

  // OCR buttons (Seleziona/Copia/Incolla)
  const gName = document.getElementById("gName");
  document.getElementById("btnSelectText").addEventListener("click", ()=>{
    gName.focus();
    gName.select();
  });
  document.getElementById("btnCopyText").addEventListener("click", async ()=>{
    try{
      await navigator.clipboard.writeText(gName.value || "");
      showOk("üìã Copiato");
    }catch(e){
      // fallback
      gName.focus(); gName.select();
      document.execCommand("copy");
      showOk("üìã Copiato");
    }
  });
  document.getElementById("btnPasteText").addEventListener("click", async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      gName.value = t || "";
      showOk("üì• Incollato");
    }catch(e){
      showErr("Incolla non permesso dal browser. Usa pressione lunga ‚Üí Incolla.");
    }
  });

  // OCR on crop
  let tesseractLoaded = false;
  async function loadTesseract(){
    if(tesseractLoaded) return;
    // carica tesseract da CDN (solo quando serve)
    await new Promise((resolve, reject)=>{
      const s = document.createElement("script");
      s.src = "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
      s.onload = ()=> resolve();
      s.onerror = ()=> reject("Impossibile caricare OCR (internet?)");
      document.head.appendChild(s);
    });
    tesseractLoaded = true;
  }

  function exportCroppedDataURL(){
    if(!srcImg) throw new Error("Prima carica un'immagine.");

    // crop dal canvas "virtuale": creiamo output in pixels reali della sorgente
    // 1) trasformiamo il cropRect (canvas coords) in coords sulla sorgente
    const dprScale = cropCanvas.width / cropWrap.getBoundingClientRect().width;

    // dove sta l'immagine disegnata sul canvas
    const drawW = srcW * scale;
    const drawH = srcH * scale;

    // crop (canvas coords) -> relativo all'immagine disegnata
    const rx = (crop.x - imgX);
    const ry = (crop.y - imgY);
    const rw = crop.w;
    const rh = crop.h;

    // converti in sorgente px
    const sx = rx / scale;
    const sy = ry / scale;
    const sw = rw / scale;
    const sh = rh / scale;

    // limita a bounds sorgente
    const sx2 = clamp(sx, 0, srcW-1);
    const sy2 = clamp(sy, 0, srcH-1);
    const sw2 = clamp(sw, 1, srcW - sx2);
    const sh2 = clamp(sh, 1, srcH - sy2);

    // output canvas
    const out = document.createElement("canvas");
    out.width = Math.floor(sw2);
    out.height = Math.floor(sh2);
    const ctx = out.getContext("2d");
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = "high";
    ctx.drawImage(srcImg, sx2, sy2, sw2, sh2, 0, 0, out.width, out.height);

    // togli bianco -> trasparente
    const key = Number(whiteKey.value || 0);
    if(key > 0){
      const imgd = ctx.getImageData(0,0,out.width,out.height);
      const d = imgd.data;
      for(let i=0;i<d.length;i+=4){
        const r=d[i], g=d[i+1], b=d[i+2];
        // near-white: distanza da 255
        const dist = (255-r) + (255-g) + (255-b);
        if(dist < key*3){
          d[i+3] = 0;
        }
      }
      ctx.putImageData(imgd,0,0);
    }

    return out.toDataURL("image/png"); // PNG trasparente
  }

  document.getElementById("btnOCR").addEventListener("click", async ()=>{
    try{
      if(!srcImg){ showErr("Carica prima un'immagine."); return; }
      showOk("OCR‚Ä¶ (attendi)");
      await loadTesseract();
      const dataUrl = exportCroppedDataURL();
      const { data } = await Tesseract.recognize(dataUrl, "ita+eng");
      const txt = (data?.text || "").trim();
      if(!txt){ showErr("OCR: nessun testo trovato. Prova a includere il nome nella zona ritaglio."); return; }
      gName.value = txt.replace(/\s+/g," ").slice(0,120);
      showOk("‚úÖ OCR copiato nel nome capo");
    }catch(e){
      showErr("OCR fallito: " + e);
    }
  });

  // Save garment: salva SOLO ritaglio pulito
  document.getElementById("btnSaveGarment").addEventListener("click", async ()=>{
    try{
      if(!srcImg){ showErr("Carica un'immagine capo e fai il ritaglio."); return; }
      const name = (gName.value || "").trim() || "Capo";
      const type = document.getElementById("gType").value;
      const view = document.getElementById("gView").value;

      const pngData = exportCroppedDataURL();

      let item = state.wardrobe.find(x => x.name === name && x.type === type);
      if(!item){
        item = { id: uid(), name, type, createdAt: Date.now(), views:{front:null,right:null,back:null,left:null} };
        state.wardrobe.unshift(item);
      }
      item.views[view] = pngData;

      save();
      renderWardrobe();
      garmentModal.classList.remove("open");
      showOk(`‚úÖ Salvato: ${name} (${VIEW_LABEL[view]})`);
    }catch(e){
      showErr("Errore salvataggio capo: " + e);
    }
  });

  // Open garment modal resets UI a little
  garmentModal.addEventListener("transitionend", ()=>{});
  garmentModal.addEventListener("click", ()=>{});

  // globalScale label
  globalScaleVal.textContent = `${globalScale.value}%`;

  // go wardrobe
  document.getElementById("btnGoWardrobe").addEventListener("click", ()=> setTab("guardaroba"));

  // init
  renderWardrobe();
  renderPerson();
  setView(state.scene.currentView || "front");
  renderApplied();
  status.textContent = "OK";

  // resize crop canvas on orientation change
  window.addEventListener("resize", ()=> {
    if(srcImg) {
      resizeCropCanvas();
      drawCrop();
      placeCropRect();
    }
  });

})();
</script>
</body>
</html>
