<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO (Upload + Crop + AutoFit)</title>
  <meta name="theme-color" content="#0b0b12" />
  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,213,106,.12);
      border-color:rgba(255,213,106,.25);
    }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
    }
    .card .body{ padding:12px 14px; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }
    .btn.danger{
      background:rgba(255,110,110,.10);
      border-color:rgba(255,110,110,.25);
    }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    select, input[type="range"], input[type="number"], input[type="text"]{
      width:100%; box-sizing:border-box;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    /* STAGE */
    .stageWrap{
      border:1px solid rgba(255,255,255,.10);
      background:#090912;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      height:560px;
    }
    @media(max-width:980px){ .stageWrap{ height:480px; } }

    .canvasArea{
      position:absolute; inset:0;
      display:grid; place-items:center;
      padding:16px;
      touch-action:none;
    }
    #stageFrame{
      position:relative;
      width:min(420px, 92vw);
      height:min(520px, 120vw);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      touch-action:none;
    }

    /* Fullscreen */
    #stageFrame.fullscreen{
      width:100vw; height:100vh; border-radius:0; border:none; background:#06060c;
    }
    .stageWrap.fullscreen{ height: calc(100vh - 0px); border-radius:0; }
    body.fullscreen header{ display:none; }
    body.fullscreen main.wrap{ max-width:none; padding:0; }
    body.fullscreen .stageWrap{ border:none; }
    body.fullscreen .canvasArea{ padding:0; }

    /* COMPOSITE */
    #composite{ position:absolute; inset:0; transform-origin:center center; will-change:transform; }

    /* PERSONA NATURALE */
    #modelImg{
      position:absolute; inset:10px;
      width:calc(100% - 20px); height:calc(100% - 20px);
      object-fit:contain; object-position:center;
      pointer-events:none; z-index:1;
    }

    /* VEIL */
    #veilLayer{
      position:absolute; inset:10px; width:calc(100% - 20px); height:calc(100% - 20px);
      z-index:2; pointer-events:none;
    }
    .veilRect{
      position:absolute; border-radius:22px;
      background:rgba(0,0,0,.35);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      opacity:0;
      transition:opacity .12s linear;
      filter:saturate(0.5);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
    }

    /* OUTFIT */
    #outfitGroup{ position:absolute; inset:0; z-index:3; pointer-events:none; }
    .cloth{
      position:absolute; left:50%;
      transform:translateX(-50%);
      transform-origin:center center;
      pointer-events:none;
      opacity:0.92;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
      will-change:transform;
      mix-blend-mode: multiply;
    }
    .pos-top    { top:33%; }
    .pos-jacket { top:33%; }
    .pos-bottom { top:60%; }
    .pos-skirt  { top:58%; }
    .pos-dress  { top:47%; }
    .pos-shoes  { top:84%; }

    .placeholderCloth{ opacity:0.25 !important; filter:none !important; mix-blend-mode: normal !important; }

    .hint{
      position:absolute; left:12px; top:12px; z-index:5;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.9);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      backdrop-filter: blur(8px);
    }

    .mini{
      font-size:12px; color:var(--muted);
      border:1px dashed rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      padding:10px;
      border-radius:14px;
    }

    /* Wardrobe */
    .wardbar{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .wardcats{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .chip{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:8px 12px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
      font-size:12px;
    }
    .chip.active{ background:rgba(255,213,106,.12); border-color:rgba(255,213,106,.25); }
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
      align-items:center;
    }
    .thumb{
      width:70px; height:70px; border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      flex:0 0 auto;
      font-size:12px; color:var(--muted);
      text-align:center;
      padding:6px;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; opacity:.95; border-radius:12px; }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }
    .meta .p{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    /* Crop modal */
    .modal{
      position:fixed; inset:0; z-index:9998;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width:min(720px, 100%);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,11,18,.96);
      border-radius:18px;
      overflow:hidden;
    }
    .modalHead{
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .modalBody{ padding:12px 14px; }
    .cropWrap{
      display:grid; grid-template-columns: 1fr 1fr; gap:12px;
    }
    @media(max-width:820px){ .cropWrap{ grid-template-columns:1fr; } }
    .cropStage{
      border:1px solid rgba(255,255,255,.10);
      background:#070710;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      height:360px;
    }
    canvas{ display:block; width:100%; height:100%; }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .kpi{
      display:flex; gap:8px; flex-wrap:wrap;
      color:var(--muted); font-size:12px;
    }

    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.08);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Upload capi + ritaglio ‚Ä¢ Click capo ‚Üí auto-fit subito ‚Ä¢ Tutto schermo</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">OK</b></span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">

      <div class="card">
        <h2><span>Persona + Outfit</span><span class="sub" id="viewLabel">Vista: FRONTE</span></h2>
        <div class="body">
          <div class="stageWrap" id="stageWrap">
            <div class="canvasArea">
              <div id="stageFrame">
                <div class="hint" id="hintText">1) Carica persona 2) Guardaroba 3) Metti addosso</div>

                <div id="composite">
                  <img id="modelImg" alt="modello" />

                  <div id="veilLayer">
                    <div id="veilTorso" class="veilRect"></div>
                    <div id="veilLegs"  class="veilRect"></div>
                    <div id="veilFeet"  class="veilRect"></div>
                  </div>

                  <div id="outfitGroup">
                    <img id="layerTop"    class="cloth pos-top"    alt="top" />
                    <img id="layerJacket" class="cloth pos-jacket" alt="jacket" />
                    <img id="layerBottom" class="cloth pos-bottom" alt="bottom" />
                    <img id="layerSkirt"  class="cloth pos-skirt"  alt="skirt" />
                    <img id="layerDress"  class="cloth pos-dress"  alt="dress" />
                    <img id="layerShoes"  class="cloth pos-shoes"  alt="shoes" />
                  </div>
                </div>

              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="btnUploadFront">üì∑ Persona FRONTE</button>
            <button class="btn" id="btnUploadRight">üì∑ Fianco DX</button>
            <button class="btn" id="btnUploadBack">üì∑ RETRO</button>
            <button class="btn" id="btnUploadLeft">üì∑ Fianco SX</button>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="btnTurntable">üîÑ Ruota viste: OFF</button>
            <button class="btn" id="btnFullscreen">‚õ∂ Tutto schermo</button>
            <button class="btn" id="btnClearOutfit">üßΩ Svuota outfit</button>
            <button class="btn danger" id="btnResetAll">üß® Reset TUTTO</button>
          </div>

          <div style="height:12px"></div>

          <div class="card" style="border-radius:16px">
            <h2><span>Sostituisci vestiti originali</span><span class="sub">copertura (demo)</span></h2>
            <div class="body">
              <div class="row">
                <button class="btn primary" id="btnReplaceToggle">üëï Sostituzione: OFF</button>
                <span class="pill">Overlay capi: <b id="ovLabel">85%</b></span>
              </div>

              <label>Copertura vestiti originali (0‚Äì100)</label>
              <input id="slReplace" type="range" min="0" max="100" value="70" />

              <label>Blur copertura (0‚Äì18)</label>
              <input id="slBlur" type="range" min="0" max="18" value="10" />

              <label>Opacit√† capi (30‚Äì100)</label>
              <input id="slOverlay" type="range" min="30" max="100" value="85" />
            </div>
          </div>

        </div>
      </div>

      <div class="card">
        <h2><span>Profilo + Auto-Fit</span><span class="sub">scala + vestibilit√†</span></h2>
        <div class="body">
          <label>Profilo</label>
          <select id="profile">
            <option value="uomo">Uomo</option>
            <option value="donna">Donna</option>
            <option value="bambino">Bambino</option>
            <option value="bambina">Bambina</option>
          </select>

          <label>Altezza (cm)</label>
          <input id="heightCm" type="number" min="80" max="220" value="175" />

          <div style="height:10px"></div>
          <div class="row">
            <button class="btn primary" id="btnApplyScale">‚úÖ Applica Auto-Fit</button>
            <span class="pill">Scala: <b id="scaleLabel">1.00√ó</b></span>
          </div>

          <div style="height:12px"></div>
          <div class="mini">
            Auto-Fit √® una stima. Se vuoi precisione ‚Äúvera‚Äù serve calibrazione + segmentazione (ML).
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba</span><span class="sub">Upload + Crop ‚Ä¢ poi ‚ÄúMetti addosso‚Äù</span></h2>
      <div class="body">
        <div class="wardbar">
          <button class="btn primary" id="btnAddGarment">‚ûï Aggiungi capo</button>
          <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
          <button class="btn" id="btnClearWardrobe">üßΩ Svuota</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:8px"></div>
        <div class="mini">
          Consiglio: usa immagini capo su sfondo semplice o PNG trasparente.
          Puoi caricare solo FRONT, oppure 4 viste.
        </div>

        <div class="wardcats" id="catChips"></div>
        <div class="cards" id="wardList"></div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida</span><span class="sub">uso rapido</span></h2>
      <div class="body">
        <div class="mini">
          1) Studio ‚Üí carica persona (almeno FRONTE).<br/>
          2) Guardaroba ‚Üí ‚ÄúAggiungi capo‚Äù ‚Üí scegli tipo + nome ‚Üí carica FRONT (poi DX/RETRO/SX se vuoi).<br/>
          3) Nel crop: regola zoom e trascina per centrare, poi ‚ÄúSalva‚Äù.<br/>
          4) Clic ‚ÄúMetti addosso‚Äù ‚Üí torna in Studio gi√† vestito.
        </div>
      </div>
    </div>
  </section>

</main>

<!-- hidden inputs -->
<input id="filePerson" type="file" accept="image/*" style="display:none" />
<input id="fileGarment" type="file" accept="image/*" style="display:none" />

<!-- Crop modal -->
<div class="modal" id="cropModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHead">
      <div style="font-weight:900">Ritaglio capo (prima di salvarlo)</div>
      <button class="btn" id="btnCropClose">‚úñ</button>
    </div>
    <div class="modalBody">
      <div class="cropWrap">
        <div>
          <div class="sub">Trascina per spostare ‚Ä¢ Zoom per ingrandire</div>
          <div style="height:8px"></div>
          <div class="cropStage">
            <canvas id="cropCanvas"></canvas>
          </div>
          <label>Zoom</label>
          <input id="cropZoom" type="range" min="1" max="3" value="1.2" step="0.01" />
        </div>
        <div>
          <div class="sub">Dati capo</div>
          <label>Nome capo</label>
          <input id="garName" type="text" placeholder="es. Camicia blu" />
          <label>Tipo capo</label>
          <select id="garType">
            <option value="top">Camicia / Maglia (TOP)</option>
            <option value="jacket">Giacca / Cappotto (JACKET)</option>
            <option value="bottom">Pantaloni (BOTTOM)</option>
            <option value="skirt">Gonna (SKIRT)</option>
            <option value="dress">Abito intero (DRESS)</option>
            <option value="shoes">Scarpe (SHOES)</option>
          </select>
          <label>Vista che stai caricando</label>
          <select id="garView">
            <option value="front">FRONTE</option>
            <option value="right">FIANCO DX</option>
            <option value="back">RETRO</option>
            <option value="left">FIANCO SX</option>
          </select>

          <div style="height:10px"></div>
          <div class="mini">
            Se carichi solo FRONT, le altre viste useranno FRONT come fallback.
          </div>
        </div>
      </div>
    </div>
    <div class="modalFoot">
      <div class="kpi" id="cropInfo"></div>
      <button class="btn" id="btnCropAgain">üîÅ Cambia immagine</button>
      <button class="btn primary" id="btnCropSave">üíæ Salva nel guardaroba</button>
    </div>
  </div>
</div>

<div id="errBox"></div>

<script>
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
  }
  function clearErr(){
    errBox.style.display = "none";
    errBox.textContent = "";
    status.textContent = "OK";
  }

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida")
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // Storage
  const KEY = "sercuctech_vs2d_upload_crop_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");

  // person
  state.personViews ??= { front:"", right:"", back:"", left:"" };

  // outfit + transforms
  const TYPES = ["top","jacket","bottom","skirt","dress","shoes"];
  const VIEWS = ["front","right","back","left"];

  state.outfit ??= {};
  state.fit ??= {}; // per-type fit scale/offset
  TYPES.forEach(t=>{
    state.outfit[t] ??= { front:"", right:"", back:"", left:"" };
    VIEWS.forEach(v=> state.outfit[t][v] ??= "");
    state.fit[t] ??= { scale:1, yPct:0 };
  });

  // replace
  state.replaceOn ??= false;
  state.replaceIntensity ??= 70;
  state.replaceBlur ??= 10;
  state.overlayOpacity ??= 85;

  // scale/profile
  state.profile ??= "uomo";
  state.heightCm ??= 175;
  state.scale ??= 1.0;

  // wardrobe
  state.wardrobe ??= [];

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result));
      r.onerror = ()=> reject(r.error);
      r.readAsDataURL(file);
    });
  }

  function svgData(label){
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="700" height="900">
        <rect width="700" height="900" rx="40" fill="rgba(255,255,255,0.06)"/>
        <rect x="26" y="26" width="648" height="848" rx="34" fill="rgba(0,0,0,0.12)" stroke="rgba(255,255,255,0.14)" stroke-width="3"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="54" fill="#ffd56a" font-weight="900">${label}</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  function uid(){ return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16); }

  // Elements
  const modelImg = document.getElementById("modelImg");
  const viewLabel = document.getElementById("viewLabel");
  const composite = document.getElementById("composite");
  const layers = {
    top: document.getElementById("layerTop"),
    jacket: document.getElementById("layerJacket"),
    bottom: document.getElementById("layerBottom"),
    skirt: document.getElementById("layerSkirt"),
    dress: document.getElementById("layerDress"),
    shoes: document.getElementById("layerShoes")
  };

  // Veil
  const veilTorso = document.getElementById("veilTorso");
  const veilLegs  = document.getElementById("veilLegs");
  const veilFeet  = document.getElementById("veilFeet");

  function applyOverlayOpacity(){
    const op = Math.max(0.3, Math.min(1, (state.overlayOpacity||85)/100));
    document.getElementById("ovLabel").textContent = Math.round(op*100) + "%";
    Object.values(layers).forEach(img => img.style.opacity = String(op));
  }

  function applyVeilStyles(){
    const a = Math.max(0, Math.min(1, (state.replaceIntensity||70)/100));
    const blur = Math.max(0, Math.min(18, state.replaceBlur||10));
    const on = !!state.replaceOn;
    const targetOpacity = on ? a : 0;

    [veilTorso, veilLegs, veilFeet].forEach(v=>{
      v.style.opacity = String(targetOpacity);
      v.style.backdropFilter = `blur(${blur}px)`;
      v.style.webkitBackdropFilter = `blur(${blur}px)`;
      v.style.background = `rgba(0,0,0,${0.18 + 0.40*a})`;
      v.style.filter = `saturate(${0.85 - 0.50*a})`;
    });
  }

  function layoutVeil(){
    veilTorso.style.left = "18%";  veilTorso.style.top = "22%";
    veilTorso.style.width = "64%"; veilTorso.style.height = "30%";
    veilLegs.style.left = "22%";   veilLegs.style.top = "52%";
    veilLegs.style.width = "56%";  veilLegs.style.height = "30%";
    veilFeet.style.left = "28%";   veilFeet.style.top = "83%";
    veilFeet.style.width = "44%";  veilFeet.style.height = "12%";
  }

  // Stage fullscreen
  const stageWrap = document.getElementById("stageWrap");
  const stageFrame = document.getElementById("stageFrame");
  const btnFullscreen = document.getElementById("btnFullscreen");
  function setFullscreen(on){
    document.body.classList.toggle("fullscreen", on);
    stageWrap.classList.toggle("fullscreen", on);
    stageFrame.classList.toggle("fullscreen", on);
    btnFullscreen.textContent = on ? "‚õ∂ Esci schermo" : "‚õ∂ Tutto schermo";
    layoutVeil();
  }
  btnFullscreen.addEventListener("click", ()=>{
    clearErr();
    setFullscreen(!document.body.classList.contains("fullscreen"));
  });
  window.addEventListener("keydown", (e)=>{
    if(e.key === "Escape" && document.body.classList.contains("fullscreen")) setFullscreen(false);
  });

  // Views + turntable
  const ORDER = ["front","right","back","left"];
  const LABELS = { front:"FRONTE", right:"FIANCO DX", back:"RETRO", left:"FIANCO SX" };
  let curIdx = 0, spinning=false, timer=null;

  function normalizeViews(v){
    return {
      front: v.front || "",
      right: v.right || v.front || "",
      back:  v.back  || v.front || "",
      left:  v.left  || v.front || ""
    };
  }

  function getPersonViewSrc(key){
    const src = state.personViews[key] || state.personViews.front;
    return src || svgData("PERSONA");
  }
  function getOutfitViewSrc(type, key){
    const src = state.outfit[type]?.[key] || state.outfit[type]?.front;
    return src || svgData(type.toUpperCase());
  }

  // AUTO FIT
  function computeScaleFromProfileHeight(){
    const prof = state.profile || "uomo";
    const h = Number(state.heightCm) || 175;
    const baseH = (prof==="uomo") ? 175 : (prof==="donna") ? 165 : 120;
    let s = h / baseH;
    s = Math.max(0.70, Math.min(1.35, s));
    return s;
  }
  function computeFit(type){
    const prof = state.profile || "uomo";
    const s = computeScaleFromProfileHeight();
    let baseScale = 1.0, yPct = 0;

    if(type==="top"){ baseScale = 1.05; yPct = 0; }
    if(type==="jacket"){ baseScale = 1.10; yPct = -1; }
    if(type==="bottom"){ baseScale = 1.10; yPct = 2; }
    if(type==="skirt"){ baseScale = 1.10; yPct = 2; }
    if(type==="dress"){ baseScale = 1.15; yPct = 0; }
    if(type==="shoes"){ baseScale = 1.05; yPct = 4; }

    if(prof==="donna"){
      if(type==="top") baseScale *= 1.02;
      if(type==="bottom") baseScale *= 1.02;
      if(type==="dress") baseScale *= 1.03;
    }
    if(prof==="bambino" || prof==="bambina"){
      baseScale *= 0.92;
      if(type==="shoes") baseScale *= 0.95;
      yPct *= 0.8;
    }
    const finalScale = baseScale * s;
    return { scale: finalScale, yPct };
  }
  function applyAutoFitAll(){
    TYPES.forEach(t => state.fit[t] = computeFit(t));
    save();
    applyFitToDOM();
  }
  function applyFitToDOM(){
    const frame = stageFrame.getBoundingClientRect();
    const H = frame.height || 520;
    TYPES.forEach(t=>{
      const el = layers[t];
      const fit = state.fit[t] || { scale:1, yPct:0 };
      const yPx = (fit.yPct/100) * H;
      el.style.transform = `translateX(-50%) translateY(${yPx.toFixed(1)}px) scale(${fit.scale.toFixed(3)})`;
    });
  }

  window.addEventListener("resize", ()=>{
    layoutVeil();
    applyFitToDOM();
  });

  function setView(idx){
    curIdx = (idx + ORDER.length) % ORDER.length;
    const key = ORDER[curIdx];

    modelImg.src = getPersonViewSrc(key);
    viewLabel.textContent = "Vista: " + (LABELS[key] || key);

    TYPES.forEach(type=>{
      const el = layers[type];
      el.src = getOutfitViewSrc(type, key);
      const isPlaceholder = !(state.outfit[type]?.front);
      el.classList.toggle("placeholderCloth", isPlaceholder);
    });

    applyVeilStyles();
    applyOverlayOpacity();
    layoutVeil();
    applyFitToDOM();
  }

  function startSpin(){
    if(spinning) return;
    spinning = true;
    document.getElementById("btnTurntable").textContent = "üîÑ Ruota viste: ON";
    timer = setInterval(()=> setView(curIdx + 1), 900);
  }
  function stopSpin(){
    spinning = false;
    document.getElementById("btnTurntable").textContent = "üîÑ Ruota viste: OFF";
    if(timer){ clearInterval(timer); timer=null; }
  }

  document.getElementById("btnTurntable").addEventListener("click", ()=>{
    clearErr();
    if(!state.personViews.front) return showErr("Carica almeno la vista FRONTE della persona.");
    spinning ? stopSpin() : startSpin();
  });

  // Person upload
  const filePerson = document.getElementById("filePerson");
  let pendingPersonView = "front";
  function pickPersonView(key){
    pendingPersonView = key;
    filePerson.value = "";
    filePerson.click();
  }
  document.getElementById("btnUploadFront").addEventListener("click", ()=> pickPersonView("front"));
  document.getElementById("btnUploadRight").addEventListener("click", ()=> pickPersonView("right"));
  document.getElementById("btnUploadBack").addEventListener("click", ()=> pickPersonView("back"));
  document.getElementById("btnUploadLeft").addEventListener("click", ()=> pickPersonView("left"));

  filePerson.addEventListener("change", async ()=>{
    try{
      clearErr();
      const f = filePerson.files && filePerson.files[0];
      if(!f) return;
      const dataUrl = await fileToDataURL(f);
      state.personViews[pendingPersonView] = dataUrl;
      save();
      setView(ORDER.indexOf(pendingPersonView));
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Replace UI
  const btnReplaceToggle = document.getElementById("btnReplaceToggle");
  const slReplace = document.getElementById("slReplace");
  const slBlur = document.getElementById("slBlur");
  const slOverlay = document.getElementById("slOverlay");

  function refreshReplaceUI(){
    btnReplaceToggle.textContent = state.replaceOn ? "üëï Sostituzione: ON" : "üëï Sostituzione: OFF";
    slReplace.value = String(state.replaceIntensity ?? 70);
    slBlur.value = String(state.replaceBlur ?? 10);
    slOverlay.value = String(state.overlayOpacity ?? 85);
    applyVeilStyles();
    applyOverlayOpacity();
  }
  btnReplaceToggle.addEventListener("click", ()=>{
    state.replaceOn = !state.replaceOn;
    save();
    refreshReplaceUI();
  });
  slReplace.addEventListener("input", ()=>{
    state.replaceIntensity = Number(slReplace.value);
    save();
    applyVeilStyles();
  });
  slBlur.addEventListener("input", ()=>{
    state.replaceBlur = Number(slBlur.value);
    save();
    applyVeilStyles();
  });
  slOverlay.addEventListener("input", ()=>{
    state.overlayOpacity = Number(slOverlay.value);
    save();
    applyOverlayOpacity();
  });

  // Auto-fit UI
  const profile = document.getElementById("profile");
  const heightCm = document.getElementById("heightCm");
  const scaleLabel = document.getElementById("scaleLabel");
  profile.value = state.profile;
  heightCm.value = state.heightCm;

  function applyAutoFit(){
    clearErr();
    state.profile = profile.value;
    state.heightCm = Number(heightCm.value) || 175;
    state.scale = computeScaleFromProfileHeight();
    composite.style.transform = `scale(${state.scale})`;
    scaleLabel.textContent = state.scale.toFixed(2) + "√ó";
    save();
    applyAutoFitAll();
  }
  document.getElementById("btnApplyScale").addEventListener("click", applyAutoFit);

  document.getElementById("btnClearOutfit").addEventListener("click", ()=>{
    clearErr();
    TYPES.forEach(t=> state.outfit[t] = { front:"", right:"", back:"", left:"" });
    save();
    setView(curIdx);
  });

  document.getElementById("btnResetAll").addEventListener("click", ()=>{
    clearErr();
    stopSpin();
    localStorage.removeItem(KEY);
    location.reload();
  });

  // Wardrobe
  const wardCount = document.getElementById("wardCount");
  const wardList = document.getElementById("wardList");
  const catChips = document.getElementById("catChips");
  let activeCat = localStorage.getItem("vs2d_cat") || "Tutti";

  function categoryFromType(type){
    if(type==="top" || type==="jacket") return "Sopra";
    if(type==="bottom" || type==="skirt") return "Sotto";
    if(type==="dress") return "Intero";
    return "Accessori";
  }
  function getCategories(){
    const base = ["Tutti", "Sopra", "Sotto", "Intero", "Accessori"];
    const extra = [...new Set(state.wardrobe.map(i => i.category).filter(Boolean))];
    extra.forEach(c=>{ if(!base.includes(c)) base.push(c); });
    return base;
  }
  function renderChips(){
    const cats = getCategories();
    catChips.innerHTML = "";
    cats.forEach(c=>{
      const el = document.createElement("div");
      el.className = "chip" + (c===activeCat ? " active" : "");
      el.textContent = c;
      el.addEventListener("click", ()=>{
        activeCat = c;
        localStorage.setItem("vs2d_cat", activeCat);
        renderChips();
        renderWardrobe();
      });
      catChips.appendChild(el);
    });
  }

  // Click capo = indossa
  function applyWardrobeItem(item){
    const type = item.type;
    state.outfit[type] = normalizeViews(item.views || {});
    applyAutoFitAll();
    save();
    setView(curIdx);
    setTab("studio");
  }

  function renderWardrobe(){
    wardCount.textContent = String(state.wardrobe.length);
    wardList.innerHTML = "";
    const items = state.wardrobe.filter(it => activeCat==="Tutti" ? true : (it.category===activeCat));

    if(items.length===0){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "Guardaroba vuoto. Premi ‚ÄúAggiungi capo‚Äù oppure ‚ÄúCarica demo‚Äù.";
      wardList.appendChild(empty);
      return;
    }

    items.forEach(it=>{
      const card = document.createElement("div");
      card.className = "item";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if(it.views?.front){
        const im = document.createElement("img");
        im.src = it.views.front;
        thumb.appendChild(im);
      } else {
        thumb.textContent = (it.type || "capo").toUpperCase();
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const t = document.createElement("div");
      t.className = "t";
      t.textContent = it.name || "Capo";

      const s = document.createElement("div");
      s.className = "s";
      const v = it.views || {};
      const has4 = !!(v.front && v.right && v.back && v.left);
      s.textContent = `${it.category || "Categoria"} ‚Ä¢ ${has4 ? "4 viste" : "fallback da FRONT"}`;

      const p = document.createElement("div");
      p.className = "p";

      const wear = document.createElement("button");
      wear.className = "btn primary";
      wear.textContent = "Metti addosso";
      wear.addEventListener("click", ()=> applyWardrobeItem(it));

      const del = document.createElement("button");
      del.className = "btn";
      del.textContent = "Elimina";
      del.addEventListener("click", ()=>{
        state.wardrobe = state.wardrobe.filter(x => x.id !== it.id);
        save();
        renderWardrobe();
        renderChips();
      });

      p.appendChild(wear);
      p.appendChild(del);

      meta.appendChild(t);
      meta.appendChild(s);
      meta.appendChild(p);

      card.appendChild(thumb);
      card.appendChild(meta);
      wardList.appendChild(card);
    });
  }

  // Demo wardrobe
  function makeDemoItem(type, name){
    const views = {
      front: svgData(`${type.toUpperCase()} FRONT`),
      right: svgData(`${type.toUpperCase()} DX`),
      back:  svgData(`${type.toUpperCase()} BACK`),
      left:  svgData(`${type.toUpperCase()} SX`)
    };
    return { id: uid(), name, type, category: categoryFromType(type), views };
  }
  document.getElementById("btnLoadDemo").addEventListener("click", ()=>{
    clearErr();
    state.wardrobe = [
      makeDemoItem("top","T-shirt basic (demo)"),
      makeDemoItem("jacket","Giacca (demo)"),
      makeDemoItem("bottom","Jeans (demo)"),
      makeDemoItem("skirt","Gonna (demo)"),
      makeDemoItem("dress","Abito (demo)"),
      makeDemoItem("shoes","Sneakers (demo)")
    ];
    save();
    renderChips();
    renderWardrobe();
    setTab("guardaroba");
  });
  document.getElementById("btnClearWardrobe").addEventListener("click", ()=>{
    clearErr();
    state.wardrobe = [];
    save();
    renderChips();
    renderWardrobe();
  });

  // ===== UPLOAD + CROP CAPO =====
  const btnAddGarment = document.getElementById("btnAddGarment");
  const fileGarment = document.getElementById("fileGarment");

  // modal controls
  const cropModal = document.getElementById("cropModal");
  const cropCanvas = document.getElementById("cropCanvas");
  const cropZoom = document.getElementById("cropZoom");
  const cropInfo = document.getElementById("cropInfo");
  const garName = document.getElementById("garName");
  const garType = document.getElementById("garType");
  const garView = document.getElementById("garView");

  const btnCropClose = document.getElementById("btnCropClose");
  const btnCropAgain = document.getElementById("btnCropAgain");
  const btnCropSave = document.getElementById("btnCropSave");

  let cropImg = new Image();
  let cropImgLoaded = false;
  let cropState = { zoom:1.2, cx:0, cy:0, down:false, lastX:0, lastY:0 };
  let pendingGarment = { id:null, name:"", type:"top", view:"front" };

  function openCropModal(){
    cropModal.classList.add("open");
    cropModal.setAttribute("aria-hidden","false");
    document.body.style.overflow="hidden";
    resizeCropCanvas();
    drawCrop();
  }
  function closeCropModal(){
    cropModal.classList.remove("open");
    cropModal.setAttribute("aria-hidden","true");
    document.body.style.overflow="";
  }

  function resizeCropCanvas(){
    const rect = cropCanvas.getBoundingClientRect();
    // set internal resolution proportional (sharp)
    const dpr = Math.min(2, window.devicePixelRatio||1);
    cropCanvas.width = Math.max(300, Math.floor(rect.width * dpr));
    cropCanvas.height = Math.max(300, Math.floor(rect.height * dpr));
  }

  function drawCrop(){
    const ctx = cropCanvas.getContext("2d");
    const w = cropCanvas.width, h = cropCanvas.height;
    ctx.clearRect(0,0,w,h);

    // background
    ctx.fillStyle = "rgba(255,255,255,0.02)";
    ctx.fillRect(0,0,w,h);

    if(!cropImgLoaded){
      ctx.fillStyle="rgba(255,255,255,0.55)";
      ctx.font = `${Math.floor(w/18)}px system-ui`;
      ctx.textAlign="center";
      ctx.fillText("Carica immagine‚Ä¶", w/2, h/2);
      return;
    }

    const zoom = cropState.zoom;
    const imgW = cropImg.naturalWidth;
    const imgH = cropImg.naturalHeight;

    // Fit image to canvas then zoom
    const fit = Math.min(w / imgW, h / imgH) * zoom;
    const drawW = imgW * fit;
    const drawH = imgH * fit;

    // center + offset
    const x = (w - drawW)/2 + cropState.cx;
    const y = (h - drawH)/2 + cropState.cy;

    ctx.drawImage(cropImg, x, y, drawW, drawH);

    // Crop guide (central rounded rectangle)
    const pad = Math.min(w,h) * 0.12;
    const cw = w - pad*2;
    const ch = h - pad*2;

    ctx.save();
    // darken outside
    ctx.fillStyle = "rgba(0,0,0,0.40)";
    ctx.beginPath();
    ctx.rect(0,0,w,h);
    ctx.roundRect(pad, pad, cw, ch, 18);
    ctx.fill("evenodd");

    // border
    ctx.strokeStyle = "rgba(255,213,106,0.75)";
    ctx.lineWidth = Math.max(2, Math.floor(w/250));
    ctx.beginPath();
    ctx.roundRect(pad, pad, cw, ch, 18);
    ctx.stroke();
    ctx.restore();

    cropInfo.textContent = `Zoom ${zoom.toFixed(2)} ‚Ä¢ Tipo ${garType.value.toUpperCase()} ‚Ä¢ Vista ${garView.value.toUpperCase()}`;
  }

  // roundRect polyfill for older
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+rr,y);
      this.arcTo(x+w,y,x+w,y+h,rr);
      this.arcTo(x+w,y+h,x,y+h,rr);
      this.arcTo(x,y+h,x,y,rr);
      this.arcTo(x,y,x+w,y,rr);
      this.closePath();
      return this;
    }
  }

  function pickGarment(){
    fileGarment.value="";
    fileGarment.click();
  }

  btnAddGarment.addEventListener("click", ()=>{
    clearErr();
    // default values
    garName.value = "";
    garType.value = "top";
    garView.value = "front";
    cropZoom.value = "1.2";
    cropState = { zoom:1.2, cx:0, cy:0, down:false, lastX:0, lastY:0 };
    pendingGarment = { id:uid(), name:"", type:"top", view:"front" };
    pickGarment();
  });

  fileGarment.addEventListener("change", async ()=>{
    try{
      clearErr();
      const f = fileGarment.files && fileGarment.files[0];
      if(!f) return;

      const dataUrl = await fileToDataURL(f);
      cropImgLoaded = false;
      cropImg = new Image();
      cropImg.onload = ()=>{
        cropImgLoaded = true;
        openCropModal();
        drawCrop();
      };
      cropImg.onerror = ()=> showErr("Immagine capo non valida.");
      cropImg.src = dataUrl;
    }catch(e){ showErr(e.message || String(e)); }
  });

  cropZoom.addEventListener("input", ()=>{
    cropState.zoom = Number(cropZoom.value);
    drawCrop();
  });

  window.addEventListener("resize", ()=>{
    if(cropModal.classList.contains("open")){
      resizeCropCanvas();
      drawCrop();
    }
  });

  // drag on crop canvas
  cropCanvas.addEventListener("pointerdown", (e)=>{
    cropState.down = true;
    cropState.lastX = e.clientX;
    cropState.lastY = e.clientY;
    cropCanvas.setPointerCapture(e.pointerId);
  });
  cropCanvas.addEventListener("pointerup", ()=>{ cropState.down = false; });
  cropCanvas.addEventListener("pointermove", (e)=>{
    if(!cropState.down) return;
    const dx = e.clientX - cropState.lastX;
    const dy = e.clientY - cropState.lastY;
    cropState.lastX = e.clientX;
    cropState.lastY = e.clientY;

    // scale movement by DPR ratio
    const rect = cropCanvas.getBoundingClientRect();
    const dpr = cropCanvas.width / rect.width;
    cropState.cx += dx * dpr;
    cropState.cy += dy * dpr;
    drawCrop();
  });

  btnCropClose.addEventListener("click", ()=> closeCropModal());
  cropModal.addEventListener("click", (e)=>{
    if(e.target === cropModal) closeCropModal();
  });

  btnCropAgain.addEventListener("click", ()=>{
    clearErr();
    pickGarment();
  });

  btnCropSave.addEventListener("click", ()=>{
    try{
      clearErr();
      if(!cropImgLoaded) return showErr("Prima carica l'immagine del capo.");

      const name = garName.value.trim() || "Capo";
      const type = garType.value;
      const view = garView.value;

      // export crop area to PNG
      const out = document.createElement("canvas");
      const outSize = 1024; // good quality
      out.width = outSize;
      out.height = outSize;
      const ctx = out.getContext("2d");

      // compute current draw transform (same as drawCrop)
      const w = cropCanvas.width, h = cropCanvas.height;
      const zoom = cropState.zoom;
      const imgW = cropImg.naturalWidth, imgH = cropImg.naturalHeight;
      const fit = Math.min(w / imgW, h / imgH) * zoom;
      const drawW = imgW * fit;
      const drawH = imgH * fit;
      const x = (w - drawW)/2 + cropState.cx;
      const y = (h - drawH)/2 + cropState.cy;

      // crop guide rect
      const pad = Math.min(w,h) * 0.12;
      const cx = pad, cy = pad, cw = w - pad*2, ch = h - pad*2;

      // Map crop rect area from cropCanvas to source image via current transform.
      // We'll render by drawing the cropCanvas visible image into output by reverse mapping.
      // Approach: draw whole image into an intermediate at same transform, then sample.
      const tmp = document.createElement("canvas");
      tmp.width = w; tmp.height = h;
      const tctx = tmp.getContext("2d");
      tctx.clearRect(0,0,w,h);
      tctx.drawImage(cropImg, x, y, drawW, drawH);

      // draw crop area into output, scaled to 1024
      ctx.clearRect(0,0,outSize,outSize);
      ctx.drawImage(tmp, cx, cy, cw, ch, 0, 0, outSize, outSize);

      const png = out.toDataURL("image/png", 0.92);

      // upsert item in wardrobe by id
      let item = state.wardrobe.find(i => i.id === pendingGarment.id);
      if(!item){
        item = { id: pendingGarment.id, name, type, category: categoryFromType(type), views: { front:"", right:"", back:"", left:"" } };
        state.wardrobe.unshift(item);
      } else {
        item.name = name;
        item.type = type;
        item.category = categoryFromType(type);
        item.views ??= { front:"", right:"", back:"", left:"" };
      }

      item.views[view] = png;

      // if only front exists, keep others fallback later (normalizeViews handles it)
      save();
      closeCropModal();
      renderChips();
      renderWardrobe();
      setTab("guardaroba");
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Init studio
  function refreshReplaceUI(){
    btnReplaceToggle.textContent = state.replaceOn ? "üëï Sostituzione: ON" : "üëï Sostituzione: OFF";
    slReplace.value = String(state.replaceIntensity ?? 70);
    slBlur.value = String(state.replaceBlur ?? 10);
    slOverlay.value = String(state.overlayOpacity ?? 85);
    applyVeilStyles();
    applyOverlayOpacity();
  }

  function applyAutoFit(){
    clearErr();
    state.profile = profile.value;
    state.heightCm = Number(heightCm.value) || 175;
    state.scale = computeScaleFromProfileHeight();
    composite.style.transform = `scale(${state.scale})`;
    scaleLabel.textContent = state.scale.toFixed(2) + "√ó";
    save();
    applyAutoFitAll();
  }

  function applyAutoFitAll(){
    TYPES.forEach(t => state.fit[t] = computeFit(t));
    save();
    applyFitToDOM();
  }

  // Apply ward item
  function applyWardrobeItem(item){
    const type = item.type;
    state.outfit[type] = normalizeViews(item.views || {});
    applyAutoFitAll();
    save();
    setView(curIdx);
    setTab("studio");
  }

  // Bind replace listeners after functions exist
  refreshReplaceUI();
  applyAutoFit();
  renderChips();
  renderWardrobe();
  setView(0);
</script>
</body>
</html>
