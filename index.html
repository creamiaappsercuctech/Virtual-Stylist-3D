<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</title>
  <meta name="theme-color" content="#0b0b12" />
  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a; --ok:#7CFFB2; --bad:#ff6b6b;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%, rgba(255,213,106,.08), transparent 55%),
                     radial-gradient(900px 600px at 80% 20%, rgba(110,255,168,.06), transparent 55%),
                     var(--bg);
         color:var(--txt);}
    header{
      position:sticky;top:0;z-index:20;
      background:rgba(11,11,18,.86);backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .brand{
      width:44px;height:44px;border-radius:18px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
      flex:0 0 auto;
    }
    .title{font-weight:900;font-size:18px;line-height:1.1}
    .sub{color:var(--muted);font-size:12px;line-height:1.35}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);background:var(--card);color:var(--muted);font-size:12px}
    .pill b{color:var(--txt)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .tab{
      border:1px solid var(--line);background:var(--card2);color:var(--txt);
      padding:10px 14px;border-radius:999px;cursor:pointer;user-select:none;
    }
    .tab.active{background:rgba(255,213,106,.12);border-color:rgba(255,213,106,.25)}
    .grid{display:grid;grid-template-columns:1.15fr .85fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);background:rgba(255,255,255,.02);
      border-radius:18px;overflow:hidden;
      box-shadow: 0 12px 40px rgba(0,0,0,.35);
    }
    .card h2{
      margin:0;font-size:14px;padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;justify-content:space-between;align-items:center;gap:10px
    }
    .card .body{padding:12px 14px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;border-radius:14px;cursor:pointer;
    }
    .btn.primary{background:rgba(255,213,106,.14);border-color:rgba(255,213,106,.28)}
    .btn.good{background:rgba(124,255,178,.10);border-color:rgba(124,255,178,.24)}
    .btn.bad{background:rgba(255,107,107,.10);border-color:rgba(255,107,107,.25)}
    .btn:active{transform:translateY(1px)}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], select, input[type="range"], textarea{
      width:100%;padding:10px;border-radius:12px;border:1px solid var(--line);
      background:rgba(255,255,255,.03);color:var(--txt);outline:none
    }
    textarea{min-height:76px;resize:vertical}
    .section{display:none}
    .section.active{display:block}

    /* Studio canvas (persona+outfit) */
    #stage{
      width:100%;
      aspect-ratio: 9/16;
      max-height: 76vh;
      background: #080812;
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      touch-action:none;
    }
    @media(max-width:980px){
      #stage{max-height: 70vh;}
    }

    .hint{
      position:absolute;left:10px;top:10px;right:10px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;border-radius:14px;
      font-size:12px;
      z-index:6;
      backdrop-filter: blur(8px);
    }
    .stageBar{
      position:absolute;left:10px;right:10px;bottom:10px;
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;
      z-index:6;
    }
    .stageBar .group{display:flex;gap:8px;flex-wrap:wrap}

    /* Wardrobe list */
    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--txt);
      padding:10px 12px;border-radius:999px;cursor:pointer;user-select:none;
    }
    .chip.active{background:rgba(255,213,106,.12);border-color:rgba(255,213,106,.25)}
    .ward{
      display:grid;
      grid-template-columns:repeat(2,1fr);
      gap:12px;
      margin-top:12px;
    }
    @media(max-width:680px){.ward{grid-template-columns:1fr}}
    .item{
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      overflow:hidden;
      display:flex;gap:12px;padding:12px;
      align-items:center;
    }
    .thumb{
      width:84px;height:84px;border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid;place-items:center;
      overflow:hidden;
      flex:0 0 auto;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1 1 auto;min-width:0}
    .meta .t{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .s{color:var(--muted);font-size:12px;margin-top:2px}
    .meta .p{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

    /* Modal */
    .modal{
      position:fixed;inset:0;z-index:100;
      display:none;
      background:rgba(0,0,0,.55);
      backdrop-filter: blur(8px);
      padding:14px;
    }
    .modal.open{display:flex;align-items:flex-start;justify-content:center}
    .modalCard{
      width:min(980px,100%);
      max-height: calc(100vh - 28px);
      overflow:auto; /* IMPORTANTISSIMO: scorrevole */
      border:1px solid rgba(255,255,255,.12);
      background:rgba(12,12,18,.92);
      border-radius:18px;
      box-shadow:0 24px 80px rgba(0,0,0,.55);
    }
    .modalHead{
      position:sticky;top:0;z-index:2;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:rgba(12,12,18,.96);
      backdrop-filter: blur(8px);
    }
    .modalHead .h{font-weight:900}
    .modalHead .x{
      width:42px;height:42px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
      color:var(--txt);cursor:pointer;
    }
    .modalBody{padding:12px 14px}
    .split{display:grid;grid-template-columns:1.1fr .9fr;gap:14px}
    @media(max-width:980px){.split{grid-template-columns:1fr}}

    /* Crop editor */
    #cropWrap{
      width:100%;
      background:#080812;
      border:1px solid rgba(255,255,255,.10);
      border-radius:16px;
      overflow:hidden;
      position:relative;
      min-height: 380px;
      touch-action:none;
    }
    #cropCanvas{
      width:100%;
      height:auto;
      display:block;
    }
    .cropOverlay{
      position:absolute;inset:0;pointer-events:none;
    }
    .cropBox{
      position:absolute;
      border:2px solid rgba(124,255,178,.95);
      box-shadow: 0 0 0 2000px rgba(0,0,0,.35) inset;
      border-radius:8px;
      pointer-events:none;
    }
    .handle{
      width:22px;height:22px;border-radius:999px;
      background:rgba(90,220,255,.95);
      border:2px solid rgba(0,0,0,.25);
      position:absolute;
      transform:translate(-50%,-50%);
      pointer-events:none;
    }
    .cropHint{
      position:absolute;left:10px;top:10px;right:10px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      color:rgba(255,255,255,.92);
      padding:10px 12px;border-radius:14px;
      font-size:12px;
      z-index:1;
      backdrop-filter: blur(8px);
      pointer-events:none;
    }

    /* Error bar */
    #errBox{
      position:fixed;left:10px;right:10px;bottom:10px;z-index:200;
      border:1px solid rgba(255,107,107,.35);
      background:rgba(255,107,107,.10);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }

    /* Fullscreen mode */
    body.fs header{display:none}
    body.fs .wrap{max-width:none;padding:0}
    body.fs #stage{border-radius:0;max-height:none;height:100vh;aspect-ratio:auto}
  </style>
</head>
<body>

<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div class="title">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Persona 4 viste ‚Ä¢ Guardaroba ‚Ä¢ Ritaglio PRO ‚Ä¢ Rotazione ‚Ä¢ Fullscreen ‚Ä¢ OCR (opzionale)</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">Avvio‚Ä¶</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">

      <div class="card">
        <h2><span>Persona vestita + Rotazione</span><span class="sub">drag = sposta/scala ultimo capo</span></h2>
        <div class="body">
          <div id="stage">
            <div class="hint" id="stageHint">
              1) Carica FRONTE/DX/RETRO/SX ‚Ä¢ 2) Vai su Guardaroba ‚Ä¢ 3) ‚ÄúMetti addosso‚Äù
            </div>

            <div class="stageBar">
              <div class="group">
                <button class="btn primary" id="btnUploadPerson">üì∏ Carica persona (4 viste)</button>
                <button class="btn" id="btnRotate">üîÑ Rotazione (fronte‚Üídx‚Üíretro‚Üísx)</button>
                <button class="btn" id="btnAutoRotate">‚ñ∂Ô∏è Auto</button>
                <button class="btn" id="btnStopRotate">‚èπÔ∏è Stop</button>
              </div>
              <div class="group">
                <button class="btn" id="btnFullscreen">‚õ∂ Fullscreen</button>
                <button class="btn bad" id="btnClearScene">üßπ Pulisci capi</button>
              </div>
            </div>
          </div>

          <label>Scala generale capi</label>
          <input id="globalScale" type="range" min="50" max="160" value="100" />
          <span class="pill">Scala: <b id="globalScaleVal">100%</b></span>

          <div style="height:10px"></div>

          <div class="row" style="justify-content:space-between">
            <span class="pill">Vista attuale: <b id="viewNow">FRONTE</b></span>
            <span class="pill">Capi in scena: <b id="sceneCount">0</b></span>
            <span class="pill">Selezione: <b id="selName">‚Äî</b></span>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn" id="btnBringFront">‚¨ÜÔ∏è Porta davanti</button>
            <button class="btn" id="btnSendBack">‚¨áÔ∏è Porta dietro</button>
            <button class="btn bad" id="btnDeleteSel">üóëÔ∏è Elimina selezionato</button>
          </div>

          <div class="sub" style="margin-top:10px">
            Tip: trascina il capo per spostarlo. Pinch/zoom non lo uso (troppi bug su Android) ‚Üí per scalare usa le maniglie.
          </div>
        </div>
      </div>

      <div class="card">
        <h2><span>Caricamento viste persona</span><span class="sub">naturale (niente schiacciamento)</span></h2>
        <div class="body">
          <div class="sub">
            Carica 4 foto (stessa distanza/luce). L‚Äôapp le mostra sempre con proporzioni naturali (contain).
          </div>

          <div class="row" style="margin-top:10px">
            <button class="btn primary" id="btnPickFront">‚¨ÜÔ∏è FRONTE</button>
            <button class="btn primary" id="btnPickRight">‚¨ÜÔ∏è FIANC0 DX</button>
            <button class="btn primary" id="btnPickBack">‚¨ÜÔ∏è RETRO</button>
            <button class="btn primary" id="btnPickLeft">‚¨ÜÔ∏è FIANC0 SX</button>
          </div>

          <div class="row" style="margin-top:10px">
            <span class="pill">Front: <b id="hasFront">NO</b></span>
            <span class="pill">Dx: <b id="hasRight">NO</b></span>
            <span class="pill">Retro: <b id="hasBack">NO</b></span>
            <span class="pill">Sx: <b id="hasLeft">NO</b></span>
          </div>

          <div style="height:10px"></div>
          <button class="btn bad" id="btnClearPerson">üßº Svuota viste persona</button>

          <div class="sub" style="margin-top:10px">
            Nota: ‚Äútogli vestiti originali‚Äù in modo perfetto richiede modelli ML (pesanti). Qui facciamo un try-on 2D pratico: sovrapponi capi ritagliati e li sistemi con maniglie.
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba</span><span class="sub">Aggiungi capi (ritaglio PRO) e mettili addosso</span></h2>
      <div class="body">

        <div class="row" style="justify-content:space-between">
          <div class="row">
            <button class="btn primary" id="btnAddGarment">üëó Aggiungi capo</button>
            <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
            <button class="btn bad" id="btnClearWard">üßπ Svuota guardaroba</button>
          </div>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:10px"></div>

        <div class="filters">
          <div class="chip active" data-filter="all">Tutti</div>
          <div class="chip" data-filter="top">Sopra</div>
          <div class="chip" data-filter="bottom">Sotto</div>
          <div class="chip" data-filter="dress">Intero</div>
          <div class="chip" data-filter="acc">Accessori</div>
        </div>

        <div class="ward" id="ward"></div>

        <div class="sub" style="margin-top:12px">
          Suggerimento: per risultati migliori usa immagini/screenshot con capo ben centrato. Se ci sono bordi bianchi: nel ritaglio stringi e usa ‚ÄúAdatta‚Äù.
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida rapida</span><span class="sub">2 minuti</span></h2>
      <div class="body">
        <div class="sub">
          <b>1) Studio ‚Üí Carica persona (4 viste)</b><br/>
          Premi FRONTE, DX, RETRO, SX e carica 4 foto.<br/><br/>
          <b>2) Guardaroba ‚Üí Aggiungi capo</b><br/>
          Carica immagine capo (meglio screenshot). Regola ritaglio con maniglie. Salva.<br/><br/>
          <b>3) Metti addosso</b><br/>
          Premi ‚ÄúMetti addosso‚Äù: il capo va in scena e prova auto-fit. Se serve, trascina e ridimensiona (maniglie).<br/><br/>
          <b>4) Rotazione</b><br/>
          In Studio premi ‚ÄúRotazione‚Äù o ‚ÄúAuto‚Äù per ciclare le viste (FRONTE‚ÜíDX‚ÜíRETRO‚ÜíSX).<br/><br/>
          <b>OCR</b> (opzionale): nell‚Äôeditor premi ‚ÄúOCR‚Äù per leggere testo dallo screenshot e incollarlo nel nome capo.
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Hidden file inputs -->
<input id="fileFront" type="file" accept="image/*" hidden>
<input id="fileRight" type="file" accept="image/*" hidden>
<input id="fileBack" type="file" accept="image/*" hidden>
<input id="fileLeft" type="file" accept="image/*" hidden>

<input id="garmentFile" type="file" accept="image/*" hidden>

<!-- Modal: Garment Editor -->
<div class="modal" id="garmentModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div class="h">Seleziona tu la parte</div>
        <div class="sub">Carica immagine ‚Üí regola rettangolo (maniglie) ‚Üí salva (zona pulita).</div>
      </div>
      <button class="x" id="garmentClose">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="split">

        <div>
          <div class="row">
            <button class="btn primary" id="btnPickGarmentImg">üì∏ Scegli immagine</button>
            <button class="btn" id="btnFitCrop">üîé Adatta</button>
            <button class="btn good" id="btnNewCrop">üß© Nuovo ritaglio</button>
            <button class="btn bad" id="btnResetCrop">‚Ü©Ô∏è Reset</button>
          </div>

          <div style="height:10px"></div>

          <div id="cropWrap">
            <div class="cropHint">Drag = sposta rettangolo ‚Ä¢ Maniglie = ridimensiona ‚Ä¢ Zoom = ingrandisci immagine</div>
            <canvas id="cropCanvas"></canvas>
            <div class="cropOverlay" id="cropOverlay">
              <div class="cropBox" id="cropBox"></div>
              <div class="handle" id="hTL"></div>
              <div class="handle" id="hTR"></div>
              <div class="handle" id="hBL"></div>
              <div class="handle" id="hBR"></div>
            </div>
          </div>

          <label>Zoom immagine</label>
          <input id="imgZoom" type="range" min="50" max="220" value="100">
          <span class="pill">Zoom: <b id="zoomVal">100%</b></span>

          <div class="sub" style="margin-top:10px">
            Tip: se le maniglie ‚Äúsotto‚Äù non si vedono, scorri: il box resta sempre dentro l‚Äôarea.
          </div>
        </div>

        <div>
          <div class="card" style="border-radius:16px">
            <h2><span>Dati capo</span><span class="sub">OCR opzionale</span></h2>
            <div class="body">

              <label>Nome capo</label>
              <div class="row">
                <input id="garmentName" type="text" placeholder="es. Vestito casual">
                <button class="btn" id="btnSelectName">Seleziona</button>
                <button class="btn" id="btnCopyName">Copia</button>
                <button class="btn" id="btnPasteName">Incolla</button>
              </div>

              <label>Tipo capo</label>
              <select id="garmentType">
                <option value="top">Camicia / Maglia (TOP)</option>
                <option value="bottom">Pantalone / Gonna (BOTTOM)</option>
                <option value="dress">Abito intero (DRESS)</option>
                <option value="acc">Accessorio</option>
              </select>

              <label>Vista che stai caricando</label>
              <select id="garmentView">
                <option value="front">FRONTE</option>
                <option value="right">FIANCO DX</option>
                <option value="back">RETRO</option>
                <option value="left">FIANCO SX</option>
              </select>

              <label>Testo OCR (se vuoi)</label>
              <textarea id="ocrText" placeholder="Premi OCR per leggere testo dallo screenshot‚Ä¶"></textarea>

              <div class="row" style="margin-top:10px">
                <button class="btn" id="btnOCR">üß† OCR</button>
                <span class="pill">OCR: <b id="ocrState">OFF</b></span>
              </div>

              <div style="height:12px"></div>
              <button class="btn primary" id="btnSaveGarment">üíæ Salva nel guardaroba</button>

              <div class="sub" style="margin-top:10px">
                Importante: salva immagini ‚Äúpulite‚Äù (ritaglio stretto) ‚Üí in scena vedrai meno bordi bianchi.
              </div>

            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>

<div id="errBox"></div>

<script>
/* =========================
   Stato + Errori
========================= */
const statusEl = document.getElementById("status");
const errBox = document.getElementById("errBox");
function setStatusOk(){ statusEl.textContent="OK"; statusEl.style.color=""; }
function showErr(msg){
  errBox.style.display="block";
  errBox.textContent="ERRORE:\n"+msg;
  statusEl.textContent="Errore";
  statusEl.style.color="var(--bad)";
}
window.addEventListener("error", (e)=>showErr(e.message||String(e.error||e)));
window.addEventListener("unhandledrejection", (e)=>showErr(String(e.reason||e)));

/* =========================
   Tabs
========================= */
const tabs=[...document.querySelectorAll(".tab")];
const sections={
  studio:document.getElementById("studio"),
  guardaroba:document.getElementById("guardaroba"),
  guida:document.getElementById("guida"),
};
function setTab(name){
  tabs.forEach(t=>t.classList.toggle("active", t.dataset.tab===name));
  Object.entries(sections).forEach(([k,el])=>el.classList.toggle("active", k===name));
  localStorage.setItem("vs2d_tab", name);
}
tabs.forEach(t=>t.addEventListener("click", ()=>setTab(t.dataset.tab)));
setTab(localStorage.getItem("vs2d_tab") || "studio");

/* =========================
   Storage
========================= */
const KEY="sercuctech_vs2d_pro_v1";
const state = JSON.parse(localStorage.getItem(KEY) || "{}");
state.person ??= { front:null, right:null, back:null, left:null, current:"front" };
state.wardrobe ??= []; // {id,name,type,view,dataUrl,w,h,createdAt}
state.scene ??= [];    // {id, garmentId, x,y,w,h, rot, z}
state.globalScale ??= 1.0;
function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* =========================
   Stage rendering
========================= */
const stage = document.getElementById("stage");
const stageHint = document.getElementById("stageHint");
const viewNow = document.getElementById("viewNow");
const sceneCount = document.getElementById("sceneCount");
const selName = document.getElementById("selName");

const globalScale = document.getElementById("globalScale");
const globalScaleVal = document.getElementById("globalScaleVal");
globalScale.value = String(Math.round((state.globalScale||1)*100));
globalScaleVal.textContent = `${globalScale.value}%`;
globalScale.addEventListener("input", ()=>{
  state.globalScale = Number(globalScale.value)/100;
  globalScaleVal.textContent = `${globalScale.value}%`;
  save();
  renderStage();
});

/* Create layers */
const personImg = document.createElement("img");
personImg.alt="persona";
personImg.style.position="absolute";
personImg.style.inset="0";
personImg.style.width="100%";
personImg.style.height="100%";
personImg.style.objectFit="contain";      // NATURALE (non schiacciata)
personImg.style.objectPosition="center";
personImg.style.zIndex="1";
personImg.draggable=false;
stage.appendChild(personImg);

const sceneLayer = document.createElement("div");
sceneLayer.style.position="absolute";
sceneLayer.style.inset="0";
sceneLayer.style.zIndex="3";
sceneLayer.style.pointerEvents="auto";
stage.appendChild(sceneLayer);

function personLabel(v){
  if(v==="front") return "FRONTE";
  if(v==="right") return "FIANCO DX";
  if(v==="back") return "RETRO";
  if(v==="left") return "FIANCO SX";
  return "FRONTE";
}

function getPersonDataUrl(view){
  return state.person?.[view] || null;
}

function setPersonView(view){
  state.person.current = view;
  save();
  renderStage();
}

function renderStage(){
  const v = state.person.current || "front";
  viewNow.textContent = personLabel(v);

  const p = getPersonDataUrl(v);
  if(p){
    personImg.src = p;
  }else{
    personImg.removeAttribute("src");
  }

  // hint
  const hasAny = !!(state.person.front || state.person.right || state.person.back || state.person.left);
  stageHint.style.display = hasAny ? "none" : "block";

  // render garments in scene
  sceneLayer.innerHTML = "";
  const items = [...(state.scene||[])].sort((a,b)=>(a.z||0)-(b.z||0));
  sceneCount.textContent = String(items.length);

  const gById = Object.fromEntries((state.wardrobe||[]).map(g=>[g.id,g]));
  items.forEach(item=>{
    const g = gById[item.garmentId];
    if(!g) return;

    const wrap = document.createElement("div");
    wrap.dataset.sceneId = item.id;
    wrap.style.position="absolute";
    wrap.style.left = item.x+"px";
    wrap.style.top  = item.y+"px";
    wrap.style.width = item.w+"px";
    wrap.style.height= item.h+"px";
    wrap.style.transformOrigin="center center";
    wrap.style.zIndex = String(item.z||10);
    wrap.style.touchAction="none";

    const img = document.createElement("img");
    img.src = g.dataUrl;
    img.alt = g.name || "capo";
    img.style.width="100%";
    img.style.height="100%";
    img.style.objectFit="contain";
    img.style.userSelect="none";
    img.style.pointerEvents="none";
    img.draggable=false;

    // outline only if selected
    const outline = document.createElement("div");
    outline.style.position="absolute";
    outline.style.inset="0";
    outline.style.border = (state._selectedSceneId===item.id) ? "2px dashed rgba(255,213,106,.95)" : "0";
    outline.style.borderRadius="10px";
    outline.style.pointerEvents="none";

    // 4 resize handles on scene item (always visible when selected)
    const handles = ["tl","tr","bl","br"].map(pos=>{
      const h = document.createElement("div");
      h.dataset.handle = pos;
      h.style.position="absolute";
      h.style.width="18px"; h.style.height="18px";
      h.style.borderRadius="999px";
      h.style.background="rgba(90,220,255,.95)";
      h.style.border="2px solid rgba(0,0,0,.25)";
      h.style.display = (state._selectedSceneId===item.id) ? "block" : "none";
      h.style.left = (pos.includes("l")? "0%":"100%");
      h.style.top  = (pos.includes("t")? "0%":"100%");
      h.style.transform="translate(-50%,-50%)";
      h.style.pointerEvents="auto";
      return h;
    });

    wrap.appendChild(img);
    wrap.appendChild(outline);
    handles.forEach(h=>wrap.appendChild(h));
    sceneLayer.appendChild(wrap);
  });

  // selected label
  const sel = (state.scene||[]).find(s=>s.id===state._selectedSceneId);
  if(sel){
    const g = (state.wardrobe||[]).find(x=>x.id===sel.garmentId);
    selName.textContent = g?.name || "Capo";
  }else{
    selName.textContent = "‚Äî";
  }
}

function stageRect(){ return stage.getBoundingClientRect(); }

function ensureSceneSelection(sceneId){
  state._selectedSceneId = sceneId;
  save();
  renderStage();
}

// Scene interactions: drag move + resize handles
let drag = null;
sceneLayer.addEventListener("pointerdown", (e)=>{
  const target = e.target;
  const wrap = target.closest?.("div[data-scene-id]");
  if(!wrap) return;

  const sceneId = wrap.dataset.sceneId;
  ensureSceneSelection(sceneId);

  const item = (state.scene||[]).find(s=>s.id===sceneId);
  if(!item) return;

  const r = stageRect();
  const sx = e.clientX - r.left;
  const sy = e.clientY - r.top;

  const handle = target.dataset.handle || null;

  drag = {
    sceneId,
    mode: handle ? "resize" : "move",
    handle,
    startX:sx, startY:sy,
    ox:item.x, oy:item.y,
    ow:item.w, oh:item.h
  };

  e.preventDefault();
});

window.addEventListener("pointermove", (e)=>{
  if(!drag) return;
  const r = stageRect();
  const x = e.clientX - r.left;
  const y = e.clientY - r.top;
  const dx = x - drag.startX;
  const dy = y - drag.startY;

  const item = (state.scene||[]).find(s=>s.id===drag.sceneId);
  if(!item) return;

  if(drag.mode==="move"){
    item.x = Math.round(drag.ox + dx);
    item.y = Math.round(drag.oy + dy);
  }else{
    // resize by handle
    let nx = drag.ox, ny = drag.oy, nw = drag.ow, nh = drag.oh;

    const minW = 40, minH = 40;

    if(drag.handle==="tl"){
      nx = drag.ox + dx; ny = drag.oy + dy;
      nw = drag.ow - dx; nh = drag.oh - dy;
    }else if(drag.handle==="tr"){
      ny = drag.oy + dy;
      nw = drag.ow + dx; nh = drag.oh - dy;
    }else if(drag.handle==="bl"){
      nx = drag.ox + dx;
      nw = drag.ow - dx; nh = drag.oh + dy;
    }else if(drag.handle==="br"){
      nw = drag.ow + dx; nh = drag.oh + dy;
    }

    // clamp
    if(nw < minW){ nw = minW; nx = item.x; }
    if(nh < minH){ nh = minH; ny = item.y; }

    item.x = Math.round(nx);
    item.y = Math.round(ny);
    item.w = Math.round(nw);
    item.h = Math.round(nh);
  }

  save();
  renderStage();
});

window.addEventListener("pointerup", ()=>{ drag = null; });

/* Scene buttons */
document.getElementById("btnClearScene").addEventListener("click", ()=>{
  state.scene = [];
  state._selectedSceneId = null;
  save();
  renderStage();
});

document.getElementById("btnBringFront").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return;
  const maxZ = Math.max(0, ...(state.scene||[]).map(s=>s.z||0));
  const it = (state.scene||[]).find(s=>s.id===id);
  if(it){ it.z = maxZ + 1; save(); renderStage(); }
});
document.getElementById("btnSendBack").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return;
  const minZ = Math.min(0, ...(state.scene||[]).map(s=>s.z||0));
  const it = (state.scene||[]).find(s=>s.id===id);
  if(it){ it.z = minZ - 1; save(); renderStage(); }
});
document.getElementById("btnDeleteSel").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return;
  state.scene = (state.scene||[]).filter(s=>s.id!==id);
  state._selectedSceneId = null;
  save(); renderStage();
});

/* Fullscreen */
document.getElementById("btnFullscreen").addEventListener("click", ()=>{
  document.body.classList.toggle("fs");
});

/* Rotation (4 views) */
let autoTimer = null;
function nextView(){
  const order = ["front","right","back","left"];
  const cur = state.person.current || "front";
  const i = Math.max(0, order.indexOf(cur));
  const next = order[(i+1)%order.length];

  // se la vista non esiste, saltala (ma non bloccare)
  const exists = !!state.person[next];
  if(exists){
    setPersonView(next);
  }else{
    // trova la prossima che esiste
    for(let k=1;k<=4;k++){
      const v = order[(i+k)%4];
      if(state.person[v]){ setPersonView(v); break; }
    }
  }
}
document.getElementById("btnRotate").addEventListener("click", nextView);
document.getElementById("btnAutoRotate").addEventListener("click", ()=>{
  if(autoTimer) return;
  autoTimer = setInterval(nextView, 900);
});
document.getElementById("btnStopRotate").addEventListener("click", ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
});

/* =========================
   Person upload (4 views)
========================= */
const fileFront = document.getElementById("fileFront");
const fileRight = document.getElementById("fileRight");
const fileBack  = document.getElementById("fileBack");
const fileLeft  = document.getElementById("fileLeft");

const hasFront = document.getElementById("hasFront");
const hasRight = document.getElementById("hasRight");
const hasBack  = document.getElementById("hasBack");
const hasLeft  = document.getElementById("hasLeft");

function updHas(){
  hasFront.textContent = state.person.front ? "OK" : "NO";
  hasRight.textContent = state.person.right ? "OK" : "NO";
  hasBack.textContent  = state.person.back ? "OK" : "NO";
  hasLeft.textContent  = state.person.left ? "OK" : "NO";
  hasFront.style.color = state.person.front ? "var(--ok)" : "";
  hasRight.style.color = state.person.right ? "var(--ok)" : "";
  hasBack.style.color  = state.person.back  ? "var(--ok)" : "";
  hasLeft.style.color  = state.person.left  ? "var(--ok)" : "";
}

function readImageFile(file){
  return new Promise((resolve,reject)=>{
    const r = new FileReader();
    r.onload = ()=>resolve(String(r.result));
    r.onerror = ()=>reject(r.error || new Error("FileReader error"));
    r.readAsDataURL(file);
  });
}

async function setViewFromInput(view, input){
  const f = input.files?.[0];
  if(!f) return;
  const dataUrl = await readImageFile(f);
  state.person[view] = dataUrl;
  // se non aveva nulla, imposta corrente
  state.person.current ||= view;
  save();
  updHas();
  renderStage();
  setStatusOk();
}

fileFront.addEventListener("change", ()=>setViewFromInput("front", fileFront));
fileRight.addEventListener("change", ()=>setViewFromInput("right", fileRight));
fileBack.addEventListener("change", ()=>setViewFromInput("back", fileBack));
fileLeft.addEventListener("change", ()=>setViewFromInput("left", fileLeft));

document.getElementById("btnPickFront").addEventListener("click", ()=>fileFront.click());
document.getElementById("btnPickRight").addEventListener("click", ()=>fileRight.click());
document.getElementById("btnPickBack").addEventListener("click",  ()=>fileBack.click());
document.getElementById("btnPickLeft").addEventListener("click",  ()=>fileLeft.click());

document.getElementById("btnUploadPerson").addEventListener("click", ()=>{
  // apri la prima, poi l‚Äôutente fa le altre
  fileFront.click();
});

document.getElementById("btnClearPerson").addEventListener("click", ()=>{
  state.person = {front:null,right:null,back:null,left:null,current:"front"};
  save();
  updHas();
  renderStage();
});

/* =========================
   Wardrobe
========================= */
const wardEl = document.getElementById("ward");
const wardCount = document.getElementById("wardCount");
let filter = "all";

function typeLabel(t){
  if(t==="top") return "Sopra";
  if(t==="bottom") return "Sotto";
  if(t==="dress") return "Intero";
  if(t==="acc") return "Accessori";
  return "Capo";
}

function viewLabel(v){
  if(v==="front") return "FRONTE";
  if(v==="right") return "FIANCO DX";
  if(v==="back") return "RETRO";
  if(v==="left") return "FIANCO SX";
  return "FRONTE";
}

function renderWardrobe(){
  wardEl.innerHTML="";
  const list = (state.wardrobe||[]).filter(g=>{
    if(filter==="all") return true;
    return g.type===filter;
  });
  wardCount.textContent = String((state.wardrobe||[]).length);

  list.forEach(g=>{
    const card = document.createElement("div");
    card.className="item";

    const th = document.createElement("div");
    th.className="thumb";
    const im = document.createElement("img");
    im.src = g.dataUrl;
    im.alt = g.name || "capo";
    th.appendChild(im);

    const meta = document.createElement("div");
    meta.className="meta";

    const t = document.createElement("div");
    t.className="t";
    t.textContent = g.name || "Capo";

    const s = document.createElement("div");
    s.className="s";
    s.textContent = `${typeLabel(g.type)} ‚Ä¢ ${viewLabel(g.view)}`;

    const p = document.createElement("div");
    p.className="p";

    const wear = document.createElement("button");
    wear.className="btn primary";
    wear.textContent="Metti addosso";
    wear.addEventListener("click", ()=>{
      addToSceneAutoFit(g.id);
      setTab("studio");
    });

    const del = document.createElement("button");
    del.className="btn bad";
    del.textContent="Elimina";
    del.addEventListener("click", ()=>{
      state.wardrobe = (state.wardrobe||[]).filter(x=>x.id!==g.id);
      save();
      renderWardrobe();
      renderStage();
    });

    p.appendChild(wear);
    p.appendChild(del);

    meta.appendChild(t);
    meta.appendChild(s);
    meta.appendChild(p);

    card.appendChild(th);
    card.appendChild(meta);
    wardEl.appendChild(card);
  });
}

document.querySelectorAll(".chip").forEach(ch=>{
  ch.addEventListener("click", ()=>{
    document.querySelectorAll(".chip").forEach(x=>x.classList.remove("active"));
    ch.classList.add("active");
    filter = ch.dataset.filter;
    renderWardrobe();
  });
});

document.getElementById("btnClearWard").addEventListener("click", ()=>{
  state.wardrobe = [];
  save();
  renderWardrobe();
  renderStage();
});

/* Demo wardrobe: (placeholder images generated) */
function makeSolidPng(w,h,text){
  const c=document.createElement("canvas");
  c.width=w;c.height=h;
  const ctx=c.getContext("2d");
  ctx.fillStyle="#0b0b12"; ctx.fillRect(0,0,w,h);
  ctx.strokeStyle="rgba(255,213,106,.55)"; ctx.lineWidth=6; ctx.strokeRect(10,10,w-20,h-20);
  ctx.fillStyle="rgba(255,255,255,.20)"; ctx.fillRect(0,0,w,h);
  ctx.fillStyle="rgba(255,255,255,.88)"; ctx.font="bold 56px system-ui";
  ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.fillText(text, w/2, h/2);
  return c.toDataURL("image/png");
}
document.getElementById("btnLoadDemo").addEventListener("click", ()=>{
  const now = Date.now();
  state.wardrobe = [
    {id:"g1", name:"T-shirt (demo)", type:"top", view:"front", dataUrl:makeSolidPng(600,800,"TOP"), createdAt:now},
    {id:"g2", name:"Pantalone (demo)", type:"bottom", view:"front", dataUrl:makeSolidPng(600,800,"BOTTOM"), createdAt:now},
    {id:"g3", name:"Vestito (demo)", type:"dress", view:"front", dataUrl:makeSolidPng(600,800,"DRESS"), createdAt:now},
    {id:"g4", name:"Giacca (demo)", type:"top", view:"front", dataUrl:makeSolidPng(600,800,"JACKET"), createdAt:now},
    {id:"g5", name:"Scarpe (demo)", type:"acc", view:"front", dataUrl:makeSolidPng(600,800,"SHOES"), createdAt:now},
  ];
  save();
  renderWardrobe();
});

/* =========================
   Auto-fit add garment to scene
========================= */
function addToSceneAutoFit(garmentId){
  const g = (state.wardrobe||[]).find(x=>x.id===garmentId);
  if(!g) return;

  const r = stage.getBoundingClientRect();
  const W = Math.round(r.width);
  const H = Math.round(r.height);

  // base box by type
  let boxW = Math.round(W * 0.58);
  let boxH = Math.round(H * 0.38);
  let x = Math.round(W * 0.21);
  let y = Math.round(H * 0.22);

  if(g.type==="bottom"){
    boxW = Math.round(W * 0.56);
    boxH = Math.round(H * 0.42);
    x = Math.round(W * 0.22);
    y = Math.round(H * 0.45);
  }else if(g.type==="dress"){
    boxW = Math.round(W * 0.62);
    boxH = Math.round(H * 0.66);
    x = Math.round(W * 0.19);
    y = Math.round(H * 0.22);
  }else if(g.type==="acc"){
    boxW = Math.round(W * 0.36);
    boxH = Math.round(H * 0.20);
    x = Math.round(W * 0.32);
    y = Math.round(H * 0.72);
  }

  const scale = state.globalScale || 1;
  boxW = Math.round(boxW * scale);
  boxH = Math.round(boxH * scale);

  const maxZ = Math.max(0, ...(state.scene||[]).map(s=>s.z||0));
  const id = "s_"+Math.random().toString(16).slice(2);

  state.scene.push({
    id,
    garmentId,
    x, y, w:boxW, h:boxH,
    z:maxZ+1
  });

  state._selectedSceneId = id;
  save();
  renderStage();
}

/* =========================
   Modal (Garment Editor) - ALWAYS opens
========================= */
const garmentModal = document.getElementById("garmentModal");
garmentModal.style.display = ""; // evita blocchi da vecchie css/caching

const garmentClose = document.getElementById("garmentClose");
const garmentFile = document.getElementById("garmentFile");
const btnPickGarmentImg = document.getElementById("btnPickGarmentImg");

function openGarmentModal(forcePickFile=true){
  garmentModal.classList.add("open");
  garmentModal.setAttribute("aria-hidden","false");
  // forza repaint + porta su
  requestAnimationFrame(()=>{
    garmentModal.querySelector(".modalCard").scrollTop = 0;
    if(forcePickFile){
      setTimeout(()=>{ try{ garmentFile.click(); }catch{} }, 150);
    }
  });
}
function closeGarmentModal(){
  garmentModal.classList.remove("open");
  garmentModal.setAttribute("aria-hidden","true");
}

document.getElementById("btnAddGarment").addEventListener("click", ()=>openGarmentModal(true));
garmentClose.addEventListener("click", closeGarmentModal);
garmentModal.addEventListener("click", (e)=>{
  if(e.target===garmentModal) closeGarmentModal();
});

btnPickGarmentImg.addEventListener("click", ()=>garmentFile.click());

/* =========================
   Crop editor (canvas + rect + handles)
========================= */
const cropWrap = document.getElementById("cropWrap");
const cropCanvas = document.getElementById("cropCanvas");
const ctx = cropCanvas.getContext("2d", { willReadFrequently:true });

const cropOverlay = document.getElementById("cropOverlay");
const cropBoxEl = document.getElementById("cropBox");
const hTL = document.getElementById("hTL");
const hTR = document.getElementById("hTR");
const hBL = document.getElementById("hBL");
const hBR = document.getElementById("hBR");

const imgZoom = document.getElementById("imgZoom");
const zoomVal = document.getElementById("zoomVal");

const btnFitCrop = document.getElementById("btnFitCrop");
const btnNewCrop = document.getElementById("btnNewCrop");
const btnResetCrop = document.getElementById("btnResetCrop");

let srcImg = new Image();
srcImg.crossOrigin = "anonymous";

let imgState = {
  ready:false,
  baseW:0, baseH:0,
  drawW:0, drawH:0,
  ox:0, oy:0, // image offset on canvas
  zoom:1.0
};

let crop = { x:60, y:60, w:220, h:320 };
let cropDrag = null;

function resizeCropCanvas(){
  const w = cropWrap.clientWidth;
  // altezza decente e stabile su mobile
  const h = Math.max(380, Math.round(w * 0.95));
  cropCanvas.width = Math.round(w * devicePixelRatio);
  cropCanvas.height= Math.round(h * devicePixelRatio);
  cropCanvas.style.width = w+"px";
  cropCanvas.style.height= h+"px";
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  redrawCrop();
}
window.addEventListener("resize", resizeCropCanvas);

function resetEditor(){
  imgState.ready=false;
  imgState.zoom=1.0;
  imgZoom.value="100";
  zoomVal.textContent="100%";
  crop = { x:60, y:60, w:240, h:340 };
  redrawCrop();
}

function fitImageToCanvas(){
  if(!imgState.ready) return;
  const cw = cropCanvas.clientWidth;
  const ch = cropCanvas.clientHeight;

  const iw = srcImg.naturalWidth;
  const ih = srcImg.naturalHeight;

  const scale = Math.min(cw/iw, ch/ih);
  imgState.baseW = iw*scale;
  imgState.baseH = ih*scale;

  imgState.zoom = Number(imgZoom.value)/100;
  imgState.drawW = imgState.baseW * imgState.zoom;
  imgState.drawH = imgState.baseH * imgState.zoom;

  imgState.ox = (cw - imgState.drawW)/2;
  imgState.oy = (ch - imgState.drawH)/2;

  // crop default centrato
  const w = Math.min(imgState.drawW*0.75, cw*0.85);
  const h = Math.min(imgState.drawH*0.75, ch*0.85);
  crop.w = Math.max(80, Math.round(w));
  crop.h = Math.max(120, Math.round(h));
  crop.x = Math.round((cw - crop.w)/2);
  crop.y = Math.round((ch - crop.h)/2);

  clampCropInside();
  redrawCrop();
}

function clampCropInside(){
  const cw = cropCanvas.clientWidth;
  const ch = cropCanvas.clientHeight;
  crop.w = Math.max(60, crop.w);
  crop.h = Math.max(60, crop.h);
  crop.x = Math.max(0, Math.min(cw - crop.w, crop.x));
  crop.y = Math.max(0, Math.min(ch - crop.h, crop.y));
}

function redrawCrop(){
  const cw = cropCanvas.clientWidth;
  const ch = cropCanvas.clientHeight;

  ctx.clearRect(0,0,cw,ch);
  // background
  ctx.fillStyle="#070710";
  ctx.fillRect(0,0,cw,ch);

  if(imgState.ready){
    imgState.zoom = Number(imgZoom.value)/100;
    imgState.drawW = imgState.baseW * imgState.zoom;
    imgState.drawH = imgState.baseH * imgState.zoom;

    // keep center with zoom: maintain center around previous center
    const cx = imgState.ox + (imgState.drawW/2);
    const cy = imgState.oy + (imgState.drawH/2);
    imgState.ox = (cw - imgState.drawW)/2;
    imgState.oy = (ch - imgState.drawH)/2;

    // draw image
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(srcImg, imgState.ox, imgState.oy, imgState.drawW, imgState.drawH);
  }else{
    ctx.fillStyle="rgba(255,255,255,.14)";
    ctx.font="700 18px system-ui";
    ctx.textAlign="center"; ctx.textBaseline="middle";
    ctx.fillText("Scegli un'immagine per iniziare", cw/2, ch/2);
  }

  // overlay rect UI (in DOM)
  cropBoxEl.style.left = crop.x+"px";
  cropBoxEl.style.top  = crop.y+"px";
  cropBoxEl.style.width= crop.w+"px";
  cropBoxEl.style.height= crop.h+"px";

  const setHandle = (el, x, y)=>{
    el.style.left = x+"px";
    el.style.top  = y+"px";
  };
  setHandle(hTL, crop.x, crop.y);
  setHandle(hTR, crop.x+crop.w, crop.y);
  setHandle(hBL, crop.x, crop.y+crop.h);
  setHandle(hBR, crop.x+crop.w, crop.y+crop.h);

  zoomVal.textContent = `${imgZoom.value}%`;
}

imgZoom.addEventListener("input", ()=>{
  redrawCrop();
});

btnFitCrop.addEventListener("click", ()=>{
  fitImageToCanvas();
});

btnNewCrop.addEventListener("click", ()=>{
  const cw = cropCanvas.clientWidth;
  const ch = cropCanvas.clientHeight;
  crop = { x:Math.round(cw*0.15), y:Math.round(ch*0.15), w:Math.round(cw*0.70), h:Math.round(ch*0.70) };
  clampCropInside();
  redrawCrop();
});

btnResetCrop.addEventListener("click", ()=>{
  resetEditor();
});

function pointerToCanvas(e){
  const r = cropCanvas.getBoundingClientRect();
  return { x: e.clientX - r.left, y: e.clientY - r.top };
}

function hitHandle(px,py){
  const pts = [
    {k:"tl", x:crop.x, y:crop.y},
    {k:"tr", x:crop.x+crop.w, y:crop.y},
    {k:"bl", x:crop.x, y:crop.y+crop.h},
    {k:"br", x:crop.x+crop.w, y:crop.y+crop.h},
  ];
  const R = 22;
  for(const p of pts){
    const dx=px-p.x, dy=py-p.y;
    if(dx*dx+dy*dy <= R*R) return p.k;
  }
  return null;
}

function hitRect(px,py){
  return (px>=crop.x && px<=crop.x+crop.w && py>=crop.y && py<=crop.y+crop.h);
}

cropWrap.addEventListener("pointerdown", (e)=>{
  // IMPORTANT: niente setPointerCapture (bug su alcuni Android)
  const {x,y} = pointerToCanvas(e);
  const h = hitHandle(x,y);
  if(h){
    cropDrag = {mode:"resize", handle:h, sx:x, sy:y, ox:crop.x, oy:crop.y, ow:crop.w, oh:crop.h};
    e.preventDefault();
    return;
  }
  if(hitRect(x,y)){
    cropDrag = {mode:"move", sx:x, sy:y, ox:crop.x, oy:crop.y};
    e.preventDefault();
    return;
  }
  // se clicchi fuori: sposta crop al centro l√¨ (pratico)
  crop.x = Math.round(x - crop.w/2);
  crop.y = Math.round(y - crop.h/2);
  clampCropInside();
  redrawCrop();
});

window.addEventListener("pointermove", (e)=>{
  if(!cropDrag) return;
  const {x,y} = pointerToCanvas(e);
  const dx = x - cropDrag.sx;
  const dy = y - cropDrag.sy;

  if(cropDrag.mode==="move"){
    crop.x = Math.round(cropDrag.ox + dx);
    crop.y = Math.round(cropDrag.oy + dy);
    clampCropInside();
    redrawCrop();
    return;
  }

  // resize
  let nx=cropDrag.ox, ny=cropDrag.oy, nw=cropDrag.ow, nh=cropDrag.oh;
  const min = 60;

  if(cropDrag.handle==="tl"){
    nx = cropDrag.ox + dx; ny = cropDrag.oy + dy;
    nw = cropDrag.ow - dx; nh = cropDrag.oh - dy;
  }else if(cropDrag.handle==="tr"){
    ny = cropDrag.oy + dy;
    nw = cropDrag.ow + dx; nh = cropDrag.oh - dy;
  }else if(cropDrag.handle==="bl"){
    nx = cropDrag.ox + dx;
    nw = cropDrag.ow - dx; nh = cropDrag.oh + dy;
  }else if(cropDrag.handle==="br"){
    nw = cropDrag.ow + dx; nh = cropDrag.oh + dy;
  }

  if(nw < min) nw = min;
  if(nh < min) nh = min;

  crop.x = Math.round(nx);
  crop.y = Math.round(ny);
  crop.w = Math.round(nw);
  crop.h = Math.round(nh);

  clampCropInside();
  redrawCrop();
});

window.addEventListener("pointerup", ()=>{ cropDrag=null; });

/* Load garment image */
let lastGarmentDataUrl = null;
garmentFile.addEventListener("change", async ()=>{
  const f = garmentFile.files?.[0];
  if(!f) return;
  try{
    const dataUrl = await readImageFile(f);
    lastGarmentDataUrl = dataUrl;
    srcImg = new Image();
    srcImg.onload = ()=>{
      imgState.ready = true;
      resizeCropCanvas();
      fitImageToCanvas();
      setStatusOk();
    };
    srcImg.src = dataUrl;
  }catch(err){
    showErr(String(err));
  }
});

/* Ensure canvas sized when modal opens */
const observer = new MutationObserver(()=>{
  if(garmentModal.classList.contains("open")){
    setTimeout(()=>{ resizeCropCanvas(); }, 50);
  }
});
observer.observe(garmentModal, {attributes:true, attributeFilter:["class"]});

/* =========================
   OCR (optional) - Tesseract
========================= */
const btnOCR = document.getElementById("btnOCR");
const ocrText = document.getElementById("ocrText");
const ocrState = document.getElementById("ocrState");

let tesseractReady=false;
let tesseractLoading=false;

function loadTesseract(){
  return new Promise((resolve,reject)=>{
    if(tesseractReady) return resolve();
    if(tesseractLoading) return resolve(); // gi√† in corso
    tesseractLoading=true;
    const s=document.createElement("script");
    s.src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js";
    s.onload=()=>{ tesseractReady=true; tesseractLoading=false; resolve(); };
    s.onerror=()=>{ tesseractLoading=false; reject(new Error("Impossibile caricare OCR (rete/CDN).")); };
    document.head.appendChild(s);
  });
}

async function doOCR(){
  if(!imgState.ready){
    showErr("Prima carica un'immagine capo.");
    return;
  }
  try{
    ocrState.textContent="ON‚Ä¶";
    ocrState.style.color="var(--acc)";
    await loadTesseract();

    // OCR sul ritaglio (pi√π pulito)
    const cut = exportCroppedPngDataUrl(1200); // alta qualit√†
    const { data } = await Tesseract.recognize(cut, "ita+eng");
    const txt = (data?.text || "").trim();
    ocrText.value = txt || "";
    ocrState.textContent = txt ? "OK" : "VUOTO";
    ocrState.style.color = txt ? "var(--ok)" : "";
    setStatusOk();
  }catch(err){
    ocrState.textContent="ERR";
    ocrState.style.color="var(--bad)";
    showErr(String(err));
  }
}
btnOCR.addEventListener("click", doOCR);

/* Select/Copy/Paste for Name */
const garmentName = document.getElementById("garmentName");
document.getElementById("btnSelectName").addEventListener("click", ()=>{
  garmentName.focus();
  garmentName.select();
});
document.getElementById("btnCopyName").addEventListener("click", async ()=>{
  garmentName.focus();
  garmentName.select();
  try{ await navigator.clipboard.writeText(garmentName.value); }catch{}
});
document.getElementById("btnPasteName").addEventListener("click", async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    if(t) garmentName.value = t.trim();
  }catch{
    // fallback: incolla OCR
    if(ocrText.value.trim()) garmentName.value = ocrText.value.trim().split("\n")[0].slice(0,80);
  }
});

/* =========================
   Save garment to wardrobe
========================= */
const garmentType = document.getElementById("garmentType");
const garmentView = document.getElementById("garmentView");
document.getElementById("btnSaveGarment").addEventListener("click", ()=>{
  try{
    if(!imgState.ready) { showErr("Prima carica un'immagine capo."); return; }

    const name = garmentName.value.trim() || "Capo";
    const type = garmentType.value;
    const view = garmentView.value;

    const dataUrl = exportCroppedPngDataUrl(1200);

    const id = "g_"+Math.random().toString(16).slice(2);
    state.wardrobe.unshift({
      id, name, type, view,
      dataUrl,
      createdAt: Date.now()
    });
    save();
    renderWardrobe();
    closeGarmentModal();
    setStatusOk();
  }catch(err){
    showErr(String(err));
  }
});

function exportCroppedPngDataUrl(maxSide=1000){
  // ritaglio dal canvas usando mapping inverso image->canvas
  const cw = cropCanvas.clientWidth;
  const ch = cropCanvas.clientHeight;

  // crop rect in canvas coords
  const rx = crop.x, ry=crop.y, rw=crop.w, rh=crop.h;

  // create output canvas
  const out = document.createElement("canvas");

  // keep aspect
  const scale = Math.min(maxSide / Math.max(rw,rh), 2.5);
  out.width = Math.max(10, Math.round(rw * scale));
  out.height= Math.max(10, Math.round(rh * scale));
  const octx = out.getContext("2d");

  // draw background transparent
  octx.clearRect(0,0,out.width,out.height);

  // draw from original srcImg as displayed on cropCanvas
  // We must map crop rect relative to displayed image rect (imgState.ox/oy and drawW/drawH)
  // Compute intersection area: use drawImage with source = srcImg and destination = canvas area
  // Approach: draw the displayed image onto a temp canvas, then crop area.
  const tmp = document.createElement("canvas");
  tmp.width = Math.round(cw);
  tmp.height= Math.round(ch);
  const tctx = tmp.getContext("2d");
  tctx.fillStyle="#000"; tctx.fillRect(0,0,cw,ch);
  tctx.drawImage(srcImg, imgState.ox, imgState.oy, imgState.drawW, imgState.drawH);

  // crop tmp ‚Üí out
  octx.imageSmoothingEnabled = true;
  octx.drawImage(tmp, rx, ry, rw, rh, 0, 0, out.width, out.height);

  return out.toDataURL("image/png");
}

/* =========================
   Init
========================= */
updHas();
renderWardrobe();
renderStage();
setStatusOk();

/* Extra: click on stage to clear selection */
stage.addEventListener("pointerdown", (e)=>{
  // if click not on scene item -> deselect
  if(!e.target.closest || !e.target.closest("div[data-scene-id]")){
    state._selectedSceneId = null;
    save();
    renderStage();
  }
});
</script>

</body>
</html>
