<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>SerCucTech ‚Ä¢ TryMe 2D PRO</title>
  <link rel="manifest" href="./manifest.json" />
  <meta name="theme-color" content="#0b0f14" />
  <style>
    :root{
      --bg:#0b0f14; --panel:rgba(255,255,255,.06); --panel2:rgba(255,255,255,.08);
      --txt:#e9eef5; --muted:rgba(233,238,245,.72);
      --acc:#d1b15b; --bad:#ff5b6a; --ok:#39d98a; --line:rgba(255,255,255,.12);
      --r:18px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:radial-gradient(1200px 600px at 20% 0%,rgba(209,177,91,.10),transparent 55%),var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial}
    a{color:inherit}
    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 80px}
    .top{display:flex;align-items:center;gap:12px;margin-bottom:14px}
    .logo{width:44px;height:44px;border-radius:14px;background:linear-gradient(180deg,rgba(209,177,91,.85),rgba(209,177,91,.25));display:grid;place-items:center;font-weight:800}
    h1{margin:0;font-size:20px;line-height:1.1}
    .sub{margin:3px 0 0;color:var(--muted);font-size:13px}
    .status{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:var(--panel);border:1px solid var(--line);font-size:13px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--ok)}
    .tabs{display:flex;gap:10px;margin:14px 0}
    .tab{flex:1;text-align:center;padding:12px;border-radius:999px;background:var(--panel);border:1px solid var(--line);cursor:pointer;user-select:none}
    .tab.on{background:linear-gradient(180deg,rgba(209,177,91,.22),rgba(255,255,255,.06));border-color:rgba(209,177,91,.35)}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:var(--r);overflow:hidden}
    .card h2{margin:0;padding:14px 14px 8px;font-size:16px}
    .card p{margin:0;padding:0 14px 14px;color:var(--muted);font-size:13px}
    .tools{display:flex;flex-wrap:wrap;gap:10px;padding:14px}
    .btn{appearance:none;border:none;cursor:pointer;border-radius:14px;padding:12px 14px;background:var(--panel2);color:var(--txt);border:1px solid var(--line);display:inline-flex;align-items:center;gap:10px}
    .btn.acc{background:linear-gradient(180deg,rgba(209,177,91,.25),rgba(255,255,255,.08));border-color:rgba(209,177,91,.35)}
    .btn.bad{background:rgba(255,91,106,.12);border-color:rgba(255,91,106,.25)}
    .btn.small{padding:9px 12px;border-radius:12px;font-size:13px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .viewer{position:relative;background:#070a0f;border-top:1px solid var(--line)}
    .stage{
      position:relative;
      width:100%;
      aspect-ratio:3/4;
      max-height:78vh;
      margin:0 auto;
      overflow:hidden;
      touch-action:none;
      background:#070a0f;
    }
    .layer{
      position:absolute;inset:0;
      display:block;
      width:100%;height:100%;
      object-fit:contain; /* persona naturale, NON schiacciata */
      transform-origin:center center;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
    }
    .overlayWrap{position:absolute;inset:0;pointer-events:auto;touch-action:none}
    .garmentBox{
      position:absolute;
      left:20%;top:20%;
      width:50%;height:60%;
      transform-origin:center center;
      touch-action:none;
      cursor:grab;
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.35));
    }
    .garmentImg{
      width:100%;height:100%;
      object-fit:contain;
      display:block;
      pointer-events:none;
    }
    .handles{position:absolute;inset:0;pointer-events:none}
    .h{
      width:18px;height:18px;border-radius:50%;
      background:rgba(77,208,225,.95);
      position:absolute;pointer-events:auto;
      border:2px solid rgba(0,0,0,.35);
      touch-action:none;
    }
    .h.tl{left:-9px;top:-9px}
    .h.tr{right:-9px;top:-9px}
    .h.bl{left:-9px;bottom:-9px}
    .h.br{right:-9px;bottom:-9px}
    .hud{
      position:absolute;left:10px;top:10px;right:10px;
      display:flex;flex-wrap:wrap;gap:8px;
      padding:10px;border-radius:16px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(8px);
    }
    .hud .pill{display:inline-flex;align-items:center;gap:8px;padding:9px 10px;border-radius:999px;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);font-size:13px;color:var(--txt)}
    .range{width:min(360px,100%);display:flex;align-items:center;gap:10px}
    input[type=range]{width:100%}
    .list{padding:14px;display:grid;gap:10px}
    .item{
      display:grid;grid-template-columns:64px 1fr auto;gap:10px;
      align-items:center;
      padding:10px;border-radius:16px;background:rgba(255,255,255,.06);border:1px solid var(--line);
    }
    .thumb{width:64px;height:64px;border-radius:14px;background:#06080c;border:1px solid rgba(255,255,255,.10);overflow:hidden;display:grid;place-items:center}
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{min-width:0}
    .meta b{display:block;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta small{color:var(--muted)}
    .toast{position:fixed;left:14px;right:14px;bottom:18px;padding:12px 14px;border-radius:16px;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.14);backdrop-filter:blur(10px);display:none}
    .toast.on{display:block}
    .fs{
      position:fixed;inset:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;
      padding:10px;
    }
    .fs.on{display:flex}
    .fs .stage{max-width:980px;max-height:92vh;width:100%}
    .fsTop{position:fixed;left:10px;top:10px;z-index:10000;display:none}
    .fs.on + .fsTop, .fs.on ~ .fsTop{display:block}
    .smallNote{padding:0 14px 14px;color:var(--muted);font-size:12px}
    .sep{height:1px;background:var(--line);margin:0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="logo">SC</div>
      <div style="flex:1">
        <h1>SerCucTech ‚Ä¢ TryMe 2D PRO</h1>
        <div class="sub">Persona 4 viste ‚Ä¢ Guardaroba ‚Ä¢ Editor capi ‚Ä¢ Rotazione ‚Ä¢ Fullscreen ‚Ä¢ OCR (opzionale)</div>
      </div>
      <div class="status" id="status"><span class="dot" id="dot"></span><span id="statusTxt">OK</span></div>
    </div>

    <div class="tabs">
      <div class="tab on" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div class="card" id="studioCard">
        <h2>Persona vestita + Rotazione</h2>
        <p>Carica fino a 4 viste (fronte ‚Üí dx ‚Üí retro ‚Üí sx). Poi scegli un capo nel Guardaroba e ‚ÄúMetti addosso‚Äù.</p>
        <div class="viewer">
          <div class="stage" id="stage">
            <img class="layer" id="personImg" alt="">
            <div class="overlayWrap" id="overlayWrap">
              <div class="garmentBox" id="garmentBox" style="display:none;">
                <img class="garmentImg" id="garmentImg" alt="">
                <div class="handles">
                  <div class="h tl" data-h="tl"></div>
                  <div class="h tr" data-h="tr"></div>
                  <div class="h bl" data-h="bl"></div>
                  <div class="h br" data-h="br"></div>
                </div>
              </div>
            </div>

            <div class="hud">
              <div class="pill">üì∑ Persona: <b id="viewName" style="margin-left:6px;font-weight:700">‚Äî</b></div>
              <button class="btn small" id="btnLoadPerson">üì∑ Carica persona (4 viste)</button>
              <button class="btn small" id="btnRotate">‚Üª Rotazione</button>
              <button class="btn small" id="btnAuto">‚ñ∂ Auto</button>
              <button class="btn small" id="btnStop">‚è∏ Stop</button>
              <button class="btn small" id="btnFullscreen">‚õ∂ Fullscreen</button>
              <button class="btn small bad" id="btnClearOutfit">üßπ Pulisci capi</button>
              <div class="range">
                <span class="pill">Scala capi</span>
                <input type="range" id="globalScale" min="60" max="180" value="100">
                <span class="pill" id="globalScaleLbl">100%</span>
              </div>
            </div>
          </div>
          <div class="smallNote">
            Tip: trascina il capo per spostarlo ‚Ä¢ usa le 4 maniglie per ridimensionare ‚Ä¢ slider per scala generale.
          </div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="card" id="rightCard">
        <h2>Azioni rapide</h2>
        <p>Apri Admin per creare persone/vetrine e caricare capi. Oppure gestisci il tuo guardaroba qui.</p>
        <div class="tools">
          <a class="btn acc" href="./admin.html">üîí Vai in ADMIN (tu)</a>
          <button class="btn" id="btnOpenMyWardrobe">üëï Gestisci Guardaroba</button>
          <button class="btn" id="btnExport">‚¨áÔ∏è Esporta dati (backup)</button>
          <button class="btn" id="btnImport">‚¨ÜÔ∏è Importa dati</button>
          <input type="file" id="importFile" accept="application/json" style="display:none">
        </div>
        <div class="sep"></div>
        <div class="list" id="wardrobeList">
          <div style="color:var(--muted);font-size:13px">Nessun capo ancora. Vai in ‚ÄúGuardaroba‚Äù o in ‚ÄúAdmin‚Äù per aggiungerli.</div>
        </div>
      </div>
    </div>

    <!-- GUARDAROBA TAB -->
    <div class="card" id="wardrobeCard" style="display:none;margin-top:12px">
      <h2>Guardaroba (clicca un capo ‚Üí va addosso)</h2>
      <p>Qui vedi i capi che hai salvato. Puoi filtrarli e vestirli subito.</p>
      <div class="tools">
        <button class="btn acc" id="btnAddItem">‚ûï Aggiungi capo (Editor PRO)</button>
        <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
        <button class="btn bad" id="btnWipeWardrobe">üßπ Svuota guardaroba</button>
      </div>
      <div class="tools" style="padding-top:0">
        <div class="row">
          <button class="btn small" data-filter="all">Tutti</button>
          <button class="btn small" data-filter="top">Sopra</button>
          <button class="btn small" data-filter="bottom">Sotto</button>
          <button class="btn small" data-filter="dress">Intero</button>
          <button class="btn small" data-filter="accessory">Accessori</button>
        </div>
      </div>
      <div class="list" id="wardrobeListFull"></div>
    </div>

    <!-- GUIDA TAB -->
    <div class="card" id="guideCard" style="display:none;margin-top:12px">
      <h2>Guida semplice</h2>
      <div class="list" style="color:var(--muted);font-size:14px;line-height:1.45">
        <div><b style="color:var(--txt)">1)</b> Vai in <b style="color:var(--txt)">Admin</b> e crea una persona/vetrina con PIN.</div>
        <div><b style="color:var(--txt)">2)</b> In Admin carica i capi (anche screenshot Amazon/Zalando) e ritaglia pulito.</div>
        <div><b style="color:var(--txt)">3)</b> Apri la <b style="color:var(--txt)">vetrina</b> della persona, inserisci PIN, carica le 4 viste della persona.</div>
        <div><b style="color:var(--txt)">4)</b> Scegli un capo nel guardaroba e premi <b style="color:var(--txt)">Metti addosso</b>.</div>
        <div><b style="color:var(--txt)">5)</b> Usa <b style="color:var(--txt)">Rotazione</b> e <b style="color:var(--txt)">Fullscreen</b>.</div>
        <div style="margin-top:8px;font-size:13px">
          ‚ö†Ô∏è Sicurezza: su GitHub Pages il PIN √® ‚Äúdeterrente‚Äù, non blindato. Per sicurezza vera serve backend/auth (Supabase).
        </div>
      </div>
    </div>
  </div>

  <div class="fs" id="fs">
    <div class="stage" id="fsStage"></div>
  </div>
  <div class="fsTop" id="fsTop" style="position:fixed;left:10px;top:10px;z-index:10000">
    <button class="btn small acc" id="btnExitFullscreen">‚õ∂ Esci</button>
  </div>

  <div class="toast" id="toast"></div>

  <input type="file" id="personFiles" accept="image/*" multiple style="display:none">

  <script src="./config.js"></script>
  <script>
    // PWA
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js").catch(()=>{}));
    }

    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => [...r.querySelectorAll(s)];

    const toast = (msg, bad=false) => {
      const t = $("#toast");
      t.textContent = msg;
      t.style.borderColor = bad ? "rgba(255,91,106,.35)" : "rgba(57,217,138,.25)";
      t.classList.add("on");
      clearTimeout(toast._tm);
      toast._tm = setTimeout(()=>t.classList.remove("on"), 2300);
    };

    const setStatus = (ok, msg) => {
      $("#dot").style.background = ok ? "var(--ok)" : "var(--bad)";
      $("#statusTxt").textContent = msg || (ok ? "OK" : "Errore");
    };

    // Storage base
    const STORE_KEY = "sercuctech_tryme_store_v1";
    function loadStore(){
      try{
        const raw = localStorage.getItem(STORE_KEY);
        if(!raw) return { wardrobe: [], people: {}, lastPersonView: 0, outfit: null, globalScale: 1 };
        return JSON.parse(raw);
      }catch(e){
        return { wardrobe: [], people: {}, lastPersonView: 0, outfit: null, globalScale: 1 };
      }
    }
    function saveStore(s){ localStorage.setItem(STORE_KEY, JSON.stringify(s)); }

    let store = loadStore();

    // Tabs
    $$(".tab").forEach(t=>{
      t.addEventListener("click", ()=>{
        $$(".tab").forEach(x=>x.classList.remove("on"));
        t.classList.add("on");
        const tab = t.dataset.tab;
        $("#studioCard").style.display = tab==="studio" ? "" : "none";
        $("#rightCard").style.display = tab==="studio" ? "" : "none";
        $("#wardrobeCard").style.display = tab==="guardaroba" ? "" : "none";
        $("#guideCard").style.display = tab==="guida" ? "" : "none";
        if(tab==="guardaroba") renderWardrobeFull();
        if(tab==="studio") renderWardrobeMini();
      });
    });

    // Person 4 views
    const person = { views: [null,null,null,null], idx: store.lastPersonView||0 };
    const viewLabels = ["fronte","dx","retro","sx"];

    function showPersonView(i){
      person.idx = (i+4)%4;
      store.lastPersonView = person.idx;
      saveStore(store);
      const src = person.views[person.idx];
      $("#personImg").src = src || "";
      $("#viewName").textContent = src ? viewLabels[person.idx] : "‚Äî";
    }

    function askLoadPerson(){
      $("#personFiles").click();
    }

    $("#btnLoadPerson").addEventListener("click", askLoadPerson);

    $("#personFiles").addEventListener("change", async (e)=>{
      try{
        const files = [...e.target.files||[]].slice(0,4);
        if(!files.length) return;
        // ordina: se 1 foto -> copia su tutte le viste
        const dataUrls = [];
        for(const f of files){
          dataUrls.push(await fileToDataURL(f));
        }
        if(dataUrls.length===1){
          person.views = [dataUrls[0],dataUrls[0],dataUrls[0],dataUrls[0]];
        }else{
          person.views = [dataUrls[0]||null, dataUrls[1]||null, dataUrls[2]||null, dataUrls[3]||null];
          // se mancano viste, riempi con la prima
          const base = person.views[0];
          for(let i=0;i<4;i++) if(!person.views[i]) person.views[i]=base;
        }
        showPersonView(0);
        toast("Persona caricata (4 viste).");
        setStatus(true,"OK");
      }catch(err){
        console.error(err);
        setStatus(false,"Errore");
        toast("Errore caricamento persona.", true);
      }finally{
        e.target.value="";
      }
    });

    // Rotation
    let autoTimer = null;
    $("#btnRotate").addEventListener("click", ()=> {
      if(!person.views[person.idx]) return toast("Carica prima la persona.", true);
      showPersonView(person.idx+1);
      applyOutfitToView();
    });
    $("#btnAuto").addEventListener("click", ()=>{
      if(!person.views[person.idx]) return toast("Carica prima la persona.", true);
      clearInterval(autoTimer);
      autoTimer = setInterval(()=>{
        showPersonView(person.idx+1);
        applyOutfitToView();
      }, 1100);
      toast("Auto-rotazione attiva.");
    });
    $("#btnStop").addEventListener("click", ()=>{
      clearInterval(autoTimer); autoTimer=null;
      toast("Stop.");
    });

    // Fullscreen
    const fs = $("#fs");
    const fsStage = $("#fsStage");
    $("#btnFullscreen").addEventListener("click", ()=>{
      if(!person.views[person.idx]) return toast("Carica prima la persona.", true);
      // sposta stage in fullscreen
      fsStage.innerHTML = "";
      fsStage.appendChild($("#stage").cloneNode(true));
      fs.classList.add("on");
      // nel clone non abbiamo handlers: √® solo ‚Äúvista‚Äù. quindi ok.
      toast("Fullscreen.");
    });
    $("#btnExitFullscreen").addEventListener("click", ()=>{
      fs.classList.remove("on");
      fsStage.innerHTML="";
    });

    // Outfit state
    const outfit = {
      itemId: null,
      // per view: pos/size/rot (semplice)
      perView: [
        {x:0.20,y:0.18,w:0.55,h:0.62,r:0},
        {x:0.20,y:0.18,w:0.55,h:0.62,r:0},
        {x:0.20,y:0.18,w:0.55,h:0.62,r:0},
        {x:0.20,y:0.18,w:0.55,h:0.62,r:0}
      ]
    };

    // Global scale
    const gs = $("#globalScale");
    gs.value = Math.round((store.globalScale||1)*100);
    $("#globalScaleLbl").textContent = gs.value + "%";
    gs.addEventListener("input", ()=>{
      store.globalScale = Number(gs.value)/100;
      $("#globalScaleLbl").textContent = gs.value + "%";
      saveStore(store);
      applyGarmentBox();
    });

    $("#btnClearOutfit").addEventListener("click", ()=>{
      outfit.itemId=null;
      $("#garmentBox").style.display="none";
      toast("Outfit pulito.");
    });

    function getWardrobe(){ return store.wardrobe || []; }

    function renderWardrobeMini(){
      const list = $("#wardrobeList");
      const items = getWardrobe().slice().reverse().slice(0,6);
      if(!items.length){
        list.innerHTML = `<div style="color:var(--muted);font-size:13px">Nessun capo ancora. Vai in ‚ÄúGuardaroba‚Äù o in ‚ÄúAdmin‚Äù per aggiungerli.</div>`;
        return;
      }
      list.innerHTML = items.map(it=>itemRowHTML(it, true)).join("");
      list.querySelectorAll("[data-act='wear']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          wearItem(id);
        });
      });
    }

    function renderWardrobeFull(filter="all"){
      const list = $("#wardrobeListFull");
      const items = getWardrobe().slice().reverse().filter(it=>{
        if(filter==="all") return true;
        return it.group===filter;
      });
      if(!items.length){
        list.innerHTML = `<div style="color:var(--muted);font-size:13px;padding:14px">Nessun capo in questa categoria.</div>`;
        return;
      }
      list.innerHTML = items.map(it=>itemRowHTML(it, false)).join("");
      list.querySelectorAll("[data-act='wear']").forEach(btn=>{
        btn.addEventListener("click", ()=> wearItem(btn.dataset.id));
      });
      list.querySelectorAll("[data-act='del']").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.dataset.id;
          store.wardrobe = getWardrobe().filter(x=>x.id!==id);
          saveStore(store);
          renderWardrobeFull(filter);
          renderWardrobeMini();
          toast("Capo eliminato.");
        });
      });
    }

    $$("#wardrobeCard [data-filter]").forEach(b=>{
      b.addEventListener("click", ()=>renderWardrobeFull(b.dataset.filter));
    });

    function itemRowHTML(it, mini){
      const img = (it.views && it.views[0]) ? it.views[0] : it.image;
      return `
        <div class="item">
          <div class="thumb">${img ? `<img src="${img}" alt="">` : "‚Äî"}</div>
          <div class="meta">
            <b>${escapeHtml(it.name||"Senza nome")}</b>
            <small>${labelGroup(it.group)} ‚Ä¢ ${it.views ? `${countViews(it.views)} viste` : "1 vista"}</small>
          </div>
          <div class="row" style="justify-content:flex-end">
            <button class="btn small acc" data-act="wear" data-id="${it.id}">Metti addosso</button>
            ${mini ? "" : `<button class="btn small bad" data-act="del" data-id="${it.id}">Elimina</button>`}
          </div>
        </div>
      `;
    }
    function countViews(v){ return (v||[]).filter(Boolean).length || 1; }
    function labelGroup(g){
      return g==="top"?"Sopra":g==="bottom"?"Sotto":g==="dress"?"Intero":g==="accessory"?"Accessori":"‚Äî";
    }
    function escapeHtml(s){
      return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
    }

    function wearItem(id){
      const it = getWardrobe().find(x=>x.id===id);
      if(!it) return toast("Capo non trovato.", true);
      if(!person.views[person.idx]) return toast("Carica prima la persona.", true);

      outfit.itemId = id;
      // scegli immagine giusta per vista corrente
      const vImg = (it.views && it.views[person.idx]) ? it.views[person.idx] : (it.views && it.views[0]) ? it.views[0] : it.image;
      $("#garmentImg").src = vImg || "";
      $("#garmentBox").style.display = vImg ? "block" : "none";

      // reset posizione vista se mai
      applyGarmentBox();
      toast(`Indossato: ${it.name || "capo"}`);
    }

    function applyOutfitToView(){
      if(!outfit.itemId) return;
      const it = getWardrobe().find(x=>x.id===outfit.itemId);
      if(!it) return;
      const vImg = (it.views && it.views[person.idx]) ? it.views[person.idx] : (it.views && it.views[0]) ? it.views[0] : it.image;
      $("#garmentImg").src = vImg || "";
      $("#garmentBox").style.display = vImg ? "block" : "none";
      applyGarmentBox();
    }

    function applyGarmentBox(){
      const b = $("#garmentBox");
      if(b.style.display==="none") return;
      const pv = outfit.perView[person.idx];
      const scale = store.globalScale || 1;

      b.style.left = (pv.x*100)+"%";
      b.style.top  = (pv.y*100)+"%";
      b.style.width = (pv.w*100*scale)+"%";
      b.style.height= (pv.h*100*scale)+"%";
      b.style.transform = `rotate(${pv.r||0}deg)`;
    }

    // Drag + resize (NO setPointerCapture -> evita InvalidStateError)
    (function garmentInteractions(){
      const box = $("#garmentBox");
      const wrap = $("#overlayWrap");
      let mode = null; // "move" o handle
      let start = null;

      function getRel(e){
        const rect = $("#stage").getBoundingClientRect();
        const x = (e.clientX - rect.left) / rect.width;
        const y = (e.clientY - rect.top) / rect.height;
        return {x,y,rect};
      }

      wrap.addEventListener("pointerdown", (e)=>{
        if(box.style.display==="none") return;
        const t = e.target;
        const isHandle = t.classList.contains("h");
        const isBox = t === box || box.contains(t);
        if(!isHandle && !isBox) return;

        e.preventDefault();
        mode = isHandle ? t.dataset.h : "move";
        const pv = outfit.perView[person.idx];
        const rel = getRel(e);
        start = { mode, pv: {...pv}, rel, cx: rel.x, cy: rel.y };
      }, {passive:false});

      wrap.addEventListener("pointermove", (e)=>{
        if(!start) return;
        e.preventDefault();

        const pv = outfit.perView[person.idx];
        const rel = getRel(e);

        if(start.mode==="move"){
          const dx = rel.x - start.cx;
          const dy = rel.y - start.cy;
          pv.x = clamp(start.pv.x + dx, 0, 1);
          pv.y = clamp(start.pv.y + dy, 0, 1);
        } else {
          // resize from corner
          let x = start.pv.x, y = start.pv.y, w = start.pv.w, h = start.pv.h;
          const dx = rel.x - start.cx;
          const dy = rel.y - start.cy;

          if(start.mode==="tl"){
            x = start.pv.x + dx;
            y = start.pv.y + dy;
            w = start.pv.w - dx;
            h = start.pv.h - dy;
          } else if(start.mode==="tr"){
            y = start.pv.y + dy;
            w = start.pv.w + dx;
            h = start.pv.h - dy;
          } else if(start.mode==="bl"){
            x = start.pv.x + dx;
            w = start.pv.w - dx;
            h = start.pv.h + dy;
          } else if(start.mode==="br"){
            w = start.pv.w + dx;
            h = start.pv.h + dy;
          }
          // min size
          w = Math.max(0.08, w);
          h = Math.max(0.08, h);
          // clamp pos
          x = clamp(x, 0, 1);
          y = clamp(y, 0, 1);

          pv.x = x; pv.y = y; pv.w = w; pv.h = h;
        }

        applyGarmentBox();
      }, {passive:false});

      window.addEventListener("pointerup", ()=>{
        if(!start) return;
        start = null;
        saveStore(store);
      });
    })();

    function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }

    // Demo items (leggerissimi)
    $("#btnLoadDemo").addEventListener("click", ()=>{
      const demo = [
        mkItem("T-shirt basic (demo)","top", null),
        mkItem("Pantalone (demo)","bottom", null),
        mkItem("Abito (demo)","dress", null)
      ];
      store.wardrobe = [...getWardrobe(), ...demo];
      saveStore(store);
      renderWardrobeFull();
      renderWardrobeMini();
      toast("Demo caricata. Ora aggiungi i tuoi capi reali in Admin.");
    });

    $("#btnWipeWardrobe").addEventListener("click", ()=>{
      if(!confirm("Sicuro? Cancella tutti i capi.")) return;
      store.wardrobe = [];
      saveStore(store);
      renderWardrobeFull();
      renderWardrobeMini();
      toast("Guardaroba svuotato.");
    });

    $("#btnOpenMyWardrobe").addEventListener("click", ()=>{
      // switch tab
      $$(".tab").find(t=>t.dataset.tab==="guardaroba").click();
    });

    // Export/Import
    $("#btnExport").addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(store, null, 2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "sercuctech-tryme-backup.json";
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
      toast("Backup esportato.");
    });
    $("#btnImport").addEventListener("click", ()=> $("#importFile").click());
    $("#importFile").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      try{
        const txt = await f.text();
        const data = JSON.parse(txt);
        if(!data || typeof data!=="object") throw new Error("bad");
        store = data;
        saveStore(store);
        renderWardrobeMini();
        toast("Import OK.");
      }catch(err){
        toast("Import fallito.", true);
      }finally{ e.target.value=""; }
    });

    // Add item -> manda ad Admin (editor completo l√¨)
    $("#btnAddItem").addEventListener("click", ()=>{
      location.href = "./admin.html#addItem";
    });

    function mkItem(name, group, image){
      return {
        id: "it_"+Math.random().toString(36).slice(2,10),
        name, group,
        image: image || "",
        views: null,
        createdAt: Date.now()
      };
    }

    async function fileToDataURL(file){
      return new Promise((res, rej)=>{
        const r = new FileReader();
        r.onload = ()=>res(r.result);
        r.onerror = rej;
        r.readAsDataURL(file);
      });
    }

    // init
    renderWardrobeMini();
    showPersonView(person.idx||0);
    applyGarmentBox();
    setStatus(true,"OK");
  </script>
</body>
</html>
