<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</title>
  <meta name="theme-color" content="#0b0b12" />
  <link rel="manifest" href="./manifest.json" />

  <!-- OCR (scarica libreria al primo uso) -->
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.03); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,213,106,.12);
      border-color:rgba(255,213,106,.25);
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .card .body{ padding:12px 14px; }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="range"], input[type="text"], select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }
    input[type="file"]{ width:100%; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }
    .btn.small{ padding:8px 10px; border-radius:12px; font-size:12px; }

    .section{ display:none; }
    .section.active{ display:block; }

    /* STAGE (persona + outfit) */
    .stageCard{ position:relative; }
    .stageTopBar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .stage{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background:#070710;
      border-radius:18px;
      overflow:hidden;
      height:560px;
      touch-action:none;
    }
    @media(max-width:980px){ .stage{ height:520px; } }

    .personWrap{
      position:absolute; inset:0;
      display:grid; place-items:center;
    }
    .personImg{
      max-width:100%;
      max-height:100%;
      width:100%;
      height:100%;
      object-fit:contain; /* ‚úÖ non schiaccia */
      transform-origin:center center;
      image-rendering:auto;
    }

    .overlay{
      position:absolute;
      left:0; top:0;
      width:100%; height:100%;
      pointer-events:none;
    }
    .garmentLayer{
      position:absolute;
      transform-origin:center center;
      pointer-events:auto; /* per drag */
      touch-action:none;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }

    .hintBubble{
      position:absolute;
      left:10px; top:10px;
      right:10px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      color:rgba(255,255,255,.92);
      font-size:12px;
      backdrop-filter: blur(10px);
    }

    /* Wardrobe cards */
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      padding:12px;
      display:flex; gap:12px;
    }
    .thumb{
      width:84px; height:84px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      overflow:hidden;
      display:grid; place-items:center;
      flex:0 0 auto;
      color:var(--muted);
      font-size:12px;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }
    .meta .p{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    /* Modal (scrollabile) */
    .modal{
      position:fixed; inset:0; z-index:9998;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal.open{ display:flex; }

    .modalCard{
      width:min(740px, 100%);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,11,18,.96);
      border-radius:18px;
      overflow:hidden;

      max-height:92vh;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalBody{
      padding:12px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }

    /* Crop stage */
    .cropStage{
      border:1px solid rgba(255,255,255,.10);
      background:#070710;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      height:420px;
      touch-action:none;
    }
    @media(max-width:820px){ .cropStage{ height:520px; } }
    .cropStage canvas{ width:100%; height:100%; display:block; }
    .cropBadge{
      position:absolute; left:10px; top:10px;
      background:rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
      border-radius:12px;
      padding:6px 10px;
      font-size:12px;
      color:rgba(255,255,255,.92);
      backdrop-filter: blur(10px);
    }

    /* Error box */
    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.10);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Carichi persona ‚Üí clicchi un capo ‚Üí va addosso ‚Ä¢ Ritocco + OCR ‚Ä¢ Rotazione fronte/fianco/retro</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">Avvio‚Ä¶</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">
  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">
      <div class="card stageCard">
        <h2>
          <span>Persona (foto) + outfit</span>
          <span class="sub">drag = sposta ultimo capo</span>
        </h2>
        <div class="body">
          <div class="stageTopBar">
            <span class="pill">Vista: <b id="viewLabel">FRONTE</b></span>

            <div class="row">
              <button class="btn small" id="btnPrevView">‚óÄ</button>
              <button class="btn small" id="btnNextView">‚ñ∂</button>
              <button class="btn small primary" id="btnRotateOnce">Rotazione 5-step</button>
              <button class="btn small" id="btnAutoRotate">Auto: OFF</button>
              <button class="btn small" id="btnFullscreen">IN/OUT Schermo</button>
            </div>
          </div>

          <div class="stage" id="stage">
            <div class="personWrap">
              <img id="personImg" class="personImg" alt="Persona" />
            </div>

            <div class="overlay" id="overlay"></div>

            <div class="hintBubble" id="hint">
              1) Carica foto persona ‚Ä¢ 2) Vai su Guardaroba ‚Ä¢ 3) Clicca ‚ÄúMetti addosso‚Äù<br/>
              Suggerimento: PNG trasparente √® meglio, ma va bene anche JPG (ritaglio).
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <div style="flex:1 1 260px; min-width:240px">
              <label>Carica foto persona</label>
              <input type="file" id="personFile" accept="image/*" />
              <div class="sub">Consiglio: corpo intero, luce buona, telefono dritto.</div>
            </div>

            <div style="flex:1 1 200px; min-width:200px">
              <label>Profilo</label>
              <select id="profile">
                <option value="uomo">Uomo</option>
                <option value="donna">Donna</option>
                <option value="bambino">Bambino</option>
                <option value="bambina">Bambina</option>
              </select>
              <div class="sub">Cambia proporzioni auto-fit capi.</div>
            </div>

            <div style="flex:1 1 200px; min-width:200px">
              <label>Taglia (solo per scaling demo)</label>
              <select id="sizePreset">
                <option value="XS">XS</option>
                <option value="S">S</option>
                <option value="M" selected>M</option>
                <option value="L">L</option>
                <option value="XL">XL</option>
              </select>
              <div class="sub">Influenza scala capi sul corpo.</div>
            </div>
          </div>

          <label>Zoom persona</label>
          <input id="personZoom" type="range" min="70" max="130" value="100" />
          <span class="pill">Zoom: <b id="personZoomVal">100</b>%</span>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn" id="btnClearOutfit">Togli tutti i capi</button>
            <button class="btn" id="btnResetOffsets">Reset posizioni capi</button>
            <span class="pill">Capi indossati: <b id="wearCount">0</b></span>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>
          <span>Controlli capo selezionato</span>
          <span class="sub">auto-fit + fine tuning</span>
        </h2>
        <div class="body">
          <div class="sub">
            Dopo ‚ÄúMetti addosso‚Äù puoi regolare leggermente. (Drag sulla persona = sposta l‚Äôultimo capo).
          </div>

          <label>Scala ultimo capo</label>
          <input id="garScale" type="range" min="60" max="160" value="100" />
          <span class="pill">Scala: <b id="garScaleVal">100</b>%</span>

          <label>Opacit√† ultimo capo</label>
          <input id="garOpacity" type="range" min="30" max="100" value="90" />
          <span class="pill">Opacit√†: <b id="garOpacityVal">90</b>%</span>

          <div style="height:10px"></div>
          <div class="sub">
            Nota: ‚Äúsostituire i vestiti originali della foto‚Äù in modo reale richiede AI/segmentazione.
            Qui sovrapponiamo capi (try-on 2D).
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2>
        <span>Guardaroba (click capo ‚Üí va addosso)</span>
        <span class="sub">Include upload + ritaglio + OCR</span>
      </h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnAddGarment">+ Aggiungi capo (upload)</button>
          <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
          <button class="btn" id="btnClearWard">Svuota guardaroba</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:12px"></div>

        <div class="row">
          <span class="pill">Filtro:</span>
          <button class="btn small" data-filter="all">Tutti</button>
          <button class="btn small" data-filter="top">Sopra</button>
          <button class="btn small" data-filter="bottom">Sotto</button>
          <button class="btn small" data-filter="dress">Intero</button>
          <button class="btn small" data-filter="shoes">Scarpe</button>
          <button class="btn small" data-filter="acc">Accessori</button>
        </div>

        <div style="height:12px"></div>
        <div class="cards" id="wardrobe"></div>

        <div style="height:12px"></div>
        <div class="sub">
          ‚úÖ Carichi una foto del capo (anche screenshot) ‚Üí fai ritaglio regolabile ‚Üí (opzionale) OCR per prendere il nome dalla foto.
          Se carichi solo FRONTE, la stessa immagine verr√† usata anche per fianco/retro finch√© non le sostituisci.
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida rapida</span><span class="sub">passo passo</span></h2>
      <div class="body">
        <ol style="margin:0; padding-left:18px; color:rgba(255,255,255,.9)">
          <li><b>Studio</b> ‚Üí ‚ÄúCarica foto persona‚Äù</li>
          <li>Vai su <b>Guardaroba</b> ‚Üí ‚Äú+ Aggiungi capo‚Äù</li>
          <li>Scegli immagine del capo ‚Üí <b>ritaglia</b> (zoom + dimensione) ‚Üí (opzionale) <b>OCR</b> ‚Üí ‚ÄúSalva nel guardaroba‚Äù</li>
          <li>Clicca <b>Metti addosso</b> ‚Üí vai in Studio e vedi il capo sulla persona</li>
          <li>Premi <b>Rotazione 5-step</b> o <b>Auto</b> per fronte/fianco/retro</li>
          <li>Se vuoi sistemare: <b>drag</b> sull‚Äôultimo capo + slider scala/opacit√†</li>
        </ol>
        <div style="height:10px"></div>
        <div class="sub">
          Se vuoi ‚Äútry-on reale che rimuove i vestiti originali‚Äù serve AI (segmentazione corpo + cloth warping).
          Qui √® una versione PRO 2D robusta, senza 404 e con OCR.
        </div>
      </div>
    </div>
  </section>
</main>

<!-- MODAL: Upload + Crop + OCR -->
<div class="modal" id="cropModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Aggiungi/Modifica capo</div>
        <div class="sub">Ritaglio regolabile + OCR (testo dalla foto)</div>
      </div>
      <button class="btn small" id="btnCloseCrop">‚úï</button>
    </div>

    <div class="modalBody">
      <label>Seleziona immagine capo</label>
      <input type="file" id="garFile" accept="image/*" />

      <div style="height:10px"></div>
      <div class="cropStage" id="cropStage">
        <canvas id="cropCanvas"></canvas>
        <div class="cropBadge">Drag = sposta immagine ‚Ä¢ Rettangolo = ritaglio</div>
      </div>

      <label>Zoom immagine</label>
      <input id="slZoom" type="range" min="50" max="250" value="110" />

      <label>Dimensione ritaglio</label>
      <input id="slCrop" type="range" min="35" max="95" value="80" />
      <div class="sub">Pi√π piccolo = ritaglio pi√π stretto sul vestito.</div>

      <label>Dati capo</label>
      <div class="row" style="gap:8px">
        <input id="garName" type="text" placeholder="Nome capo (es. Vestito casual)" style="flex:1 1 auto; min-width:180px" />
        <button class="btn small" id="btnSelName">Seleziona</button>
        <button class="btn small" id="btnCopyName">Copia</button>
        <button class="btn small" id="btnPasteName">Incolla</button>
        <button class="btn small primary" id="btnOcrName">OCR</button>
      </div>
      <div class="sub" id="ocrStatus" style="margin-top:8px"></div>

      <label>Tipo capo</label>
      <select id="garType">
        <option value="top">Camicia / Maglia (TOP)</option>
        <option value="bottom">Pantalone / Gonna (BOTTOM)</option>
        <option value="dress">Abito intero (DRESS)</option>
        <option value="shoes">Scarpe (SHOES)</option>
        <option value="acc">Accessorio (ACC)</option>
      </select>

      <label>Vista che stai caricando</label>
      <select id="garView">
        <option value="0">FRONTE</option>
        <option value="1">FIANCO (dx)</option>
        <option value="2">RETRO</option>
        <option value="3">FIANCO (sx)</option>
        <option value="4">FRONTE (ritorno)</option>
      </select>

      <div style="height:12px"></div>
      <div class="sub">
        Tip: se hai solo FRONTE, salva FRONTE e poi potrai sostituire FIANC0/RETRO quando vuoi.
      </div>
    </div>

    <div class="modalFoot">
      <button class="btn" id="btnDeleteGar">Elimina capo</button>
      <button class="btn primary" id="btnSaveGar">Salva nel guardaroba</button>
    </div>
  </div>
</div>

<div id="errBox"></div>

<script>
(() => {
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
    setTimeout(()=>{ errBox.style.display="none"; }, 4200);
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida"),
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // State
  const KEY = "sercuctech_vs2d_pro_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.person ??= { dataUrl:"", zoom:100, profile:"uomo", size:"M" };
  state.wardrobe ??= []; // {id,name,type,views[5],thumb,createdAt}
  state.wear ??= { top:null, bottom:null, dress:null, shoes:null, acc:null };
  state.offsets ??= {}; // per-item offsets & scale: offsets[itemId]={dx,dy,scale,opacity}
  state.activeView ??= 0;
  state.lastPlaced ??= null;
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // Studio elements
  const stage = document.getElementById("stage");
  const personImg = document.getElementById("personImg");
  const personFile = document.getElementById("personFile");
  const profileSel = document.getElementById("profile");
  const sizePreset = document.getElementById("sizePreset");
  const personZoom = document.getElementById("personZoom");
  const personZoomVal = document.getElementById("personZoomVal");
  const overlay = document.getElementById("overlay");
  const viewLabel = document.getElementById("viewLabel");
  const hint = document.getElementById("hint");
  const wearCount = document.getElementById("wearCount");

  const garScale = document.getElementById("garScale");
  const garScaleVal = document.getElementById("garScaleVal");
  const garOpacity = document.getElementById("garOpacity");
  const garOpacityVal = document.getElementById("garOpacityVal");

  // View labels (0..4)
  const VIEW_NAMES = ["FRONTE","FIANCO","RETRO","FIANCO","FRONTE"];

  // Anchors per profile & view (percentuali sullo stage)
  // (valori ‚Äúbuoni‚Äù per corpo intero; puoi raffinarli dopo)
  const anchors = {
    uomo: {
      top:    [[22,18,56,48],[24,18,52,48],[22,18,56,48],[24,18,52,48],[22,18,56,48]],
      bottom: [[24,44,52,50],[26,44,48,50],[24,44,52,50],[26,44,48,50],[24,44,52,50]],
      dress:  [[20,16,60,78],[23,16,54,78],[20,16,60,78],[23,16,54,78],[20,16,60,78]],
      shoes:  [[28,80,44,18],[30,80,40,18],[28,80,44,18],[30,80,40,18],[28,80,44,18]],
      acc:    [[30,4,40,18],[32,4,36,18],[30,4,40,18],[32,4,36,18],[30,4,40,18]],
    },
    donna: {
      top:    [[22,18,56,48],[24,18,52,48],[22,18,56,48],[24,18,52,48],[22,18,56,48]],
      bottom: [[24,44,52,50],[26,44,48,50],[24,44,52,50],[26,44,48,50],[24,44,52,50]],
      dress:  [[20,16,60,78],[23,16,54,78],[20,16,60,78],[23,16,54,78],[20,16,60,78]],
      shoes:  [[28,80,44,18],[30,80,40,18],[28,80,44,18],[30,80,40,18],[28,80,44,18]],
      acc:    [[30,4,40,18],[32,4,36,18],[30,4,40,18],[32,4,36,18],[30,4,40,18]],
    },
    bambino: {
      top:    [[24,20,52,44],[26,20,48,44],[24,20,52,44],[26,20,48,44],[24,20,52,44]],
      bottom: [[26,46,48,46],[28,46,44,46],[26,46,48,46],[28,46,44,46],[26,46,48,46]],
      dress:  [[22,18,56,74],[25,18,50,74],[22,18,56,74],[25,18,50,74],[22,18,56,74]],
      shoes:  [[30,82,40,16],[32,82,36,16],[30,82,40,16],[32,82,36,16],[30,82,40,16]],
      acc:    [[32,6,36,18],[34,6,32,18],[32,6,36,18],[34,6,32,18],[32,6,36,18]],
    },
    bambina: {
      top:    [[24,20,52,44],[26,20,48,44],[24,20,52,44],[26,20,48,44],[24,20,52,44]],
      bottom: [[26,46,48,46],[28,46,44,46],[26,46,48,46],[28,46,44,46],[26,46,48,46]],
      dress:  [[22,18,56,74],[25,18,50,74],[22,18,56,74],[25,18,50,74],[22,18,56,74]],
      shoes:  [[30,82,40,16],[32,82,36,16],[30,82,40,16],[32,82,36,16],[30,82,40,16]],
      acc:    [[32,6,36,18],[34,6,32,18],[32,6,36,18],[34,6,32,18],[32,6,36,18]],
    },
  };

  // Size scale factor (demo)
  const sizeScale = { XS:0.92, S:0.96, M:1.00, L:1.06, XL:1.12 };

  // Load person from state
  function renderPerson(){
    if(state.person.dataUrl){
      personImg.src = state.person.dataUrl;
      hint.style.display = "none";
    }else{
      personImg.removeAttribute("src");
      hint.style.display = "";
    }
    profileSel.value = state.person.profile;
    sizePreset.value = state.person.size;
    personZoom.value = String(state.person.zoom);
    personZoomVal.textContent = String(state.person.zoom);
    personImg.style.transform = `scale(${state.person.zoom/100})`;
  }

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result));
      fr.onerror = () => reject(fr.error || new Error("FileReader error"));
      fr.readAsDataURL(file);
    });
  }

  personFile.addEventListener("change", async ()=>{
    const f = personFile.files?.[0];
    if(!f) return;
    try{
      const url = await fileToDataURL(f);
      state.person.dataUrl = url;
      save();
      renderPerson();
      status.textContent = "OK";
    }catch(e){ showErr(e.message || String(e)); }
  });

  profileSel.addEventListener("change", ()=>{
    state.person.profile = profileSel.value;
    save();
    renderOutfit();
  });
  sizePreset.addEventListener("change", ()=>{
    state.person.size = sizePreset.value;
    save();
    renderOutfit();
  });

  personZoom.addEventListener("input", ()=>{
    state.person.zoom = Number(personZoom.value);
    personZoomVal.textContent = String(state.person.zoom);
    personImg.style.transform = `scale(${state.person.zoom/100})`;
    save();
  });

  // View switching (0..4)
  function setView(v){
    state.activeView = (v+5)%5;
    viewLabel.textContent = VIEW_NAMES[state.activeView];
    save();
    renderOutfit();
  }
  document.getElementById("btnPrevView").addEventListener("click", ()=> setView(state.activeView-1));
  document.getElementById("btnNextView").addEventListener("click", ()=> setView(state.activeView+1));

  // Rotation 5-step
  let autoTimer = null;
  function rotateOnce(){
    // segue 0->1->2->3->4 e torna a 0
    let seq = [0,1,2,3,4];
    let i = 0;
    const start = state.activeView;
    const idxStart = seq.indexOf(start);
    const playSeq = idxStart >= 0 ? seq.slice(idxStart).concat(seq.slice(0, idxStart)) : seq;
    let steps = playSeq.slice(0,5);
    i = 0;
    const t = setInterval(()=>{
      setView(steps[i]);
      i++;
      if(i>=steps.length){ clearInterval(t); }
    }, 420);
  }
  document.getElementById("btnRotateOnce").addEventListener("click", rotateOnce);

  const btnAutoRotate = document.getElementById("btnAutoRotate");
  btnAutoRotate.addEventListener("click", ()=>{
    if(autoTimer){
      clearInterval(autoTimer);
      autoTimer = null;
      btnAutoRotate.textContent = "Auto: OFF";
      return;
    }
    btnAutoRotate.textContent = "Auto: ON";
    autoTimer = setInterval(()=> setView(state.activeView+1), 550);
  });

  // Fullscreen
  const btnFullscreen = document.getElementById("btnFullscreen");
  btnFullscreen.addEventListener("click", async ()=>{
    try{
      if(!document.fullscreenElement){
        await stage.requestFullscreen();
      }else{
        await document.exitFullscreen();
      }
    }catch(e){
      showErr("Fullscreen non disponibile su questo browser.");
    }
  });

  // Outfit layers
  function clearOverlay(){
    overlay.innerHTML = "";
  }

  function getAnchor(type){
    const prof = state.person.profile;
    const view = state.activeView;
    const a = anchors[prof]?.[type]?.[view];
    return a || [25,25,50,50];
  }

  function ensureOffsets(itemId){
    state.offsets[itemId] ??= { dx:0, dy:0, scale:1, opacity:0.9 };
    return state.offsets[itemId];
  }

  function buildLayer(type, item){
    const view = state.activeView;
    const imgUrl = item.views?.[view] || item.views?.[0] || item.thumb;
    if(!imgUrl) return null;

    const [x,y,w,h] = getAnchor(type);
    const el = document.createElement("img");
    el.className = "garmentLayer";
    el.draggable = false;
    el.src = imgUrl;
    el.dataset.itemId = item.id;
    el.dataset.type = type;

    // base placement
    const off = ensureOffsets(item.id);
    const scaleBySize = sizeScale[state.person.size] || 1;

    // percent to px
    const rect = stage.getBoundingClientRect();
    const px = rect.width * (x/100);
    const py = rect.height * (y/100);
    const pw = rect.width * (w/100);
    const ph = rect.height * (h/100);

    el.style.left = (px + off.dx) + "px";
    el.style.top  = (py + off.dy) + "px";
    el.style.width = pw + "px";
    el.style.height = ph + "px";
    const totalScale = off.scale * scaleBySize;
    el.style.transform = `scale(${totalScale})`;
    el.style.opacity = String(off.opacity ?? 0.9);

    // enable drag for lastPlaced only (ma lasciamo a tutti, e gestiamo lastPlaced)
    el.addEventListener("pointerdown", (ev)=> startDrag(ev, el));

    return el;
  }

  function currentWearItems(){
    const out = [];
    const ids = Object.values(state.wear).filter(Boolean);
    for(const id of ids){
      const it = state.wardrobe.find(x => x.id === id);
      if(it) out.push(it);
    }
    return out;
  }

  function renderOutfit(){
    clearOverlay();
    const prof = state.person.profile;

    const wear = { ...state.wear };
    // se c'√® dress, nascondi top+bottom (logica semplice)
    if(wear.dress){
      wear.top = null;
      wear.bottom = null;
    }

    let count = 0;

    // ordine: dress -> top -> bottom -> shoes -> acc
    const order = ["dress","top","bottom","shoes","acc"];
    for(const type of order){
      const id = wear[type];
      if(!id) continue;
      const item = state.wardrobe.find(x => x.id === id);
      if(!item) continue;
      const layer = buildLayer(type, item);
      if(layer){
        overlay.appendChild(layer);
        count++;
      }
    }

    wearCount.textContent = String(count);

    // sync controls for lastPlaced
    if(state.lastPlaced){
      const off = state.offsets[state.lastPlaced];
      if(off){
        garScale.value = String(Math.round((off.scale||1)*100));
        garOpacity.value = String(Math.round((off.opacity ?? 0.9)*100));
        garScaleVal.textContent = String(garScale.value);
        garOpacityVal.textContent = String(garOpacity.value);
      }
    }

    status.textContent = "OK";
  }

  // Drag logic (sposta ultimo capo)
  let drag = null;
  function startDrag(ev, el){
    ev.preventDefault();
    const id = el.dataset.itemId;
    if(!id) return;
    drag = {
      id,
      startX: ev.clientX,
      startY: ev.clientY,
      orig: { ...(state.offsets[id] || {dx:0,dy:0,scale:1,opacity:0.9}) }
    };
    state.lastPlaced = id;
    save();
    stage.setPointerCapture(ev.pointerId);
  }
  stage.addEventListener("pointermove", (ev)=>{
    if(!drag) return;
    const dx = ev.clientX - drag.startX;
    const dy = ev.clientY - drag.startY;
    const off = ensureOffsets(drag.id);
    off.dx = drag.orig.dx + dx;
    off.dy = drag.orig.dy + dy;
    save();
    renderOutfit();
  });
  stage.addEventListener("pointerup", ()=>{ drag = null; });
  stage.addEventListener("pointercancel", ()=>{ drag = null; });

  // Controls for last garment
  garScale.addEventListener("input", ()=>{
    garScaleVal.textContent = String(garScale.value);
    if(!state.lastPlaced) return;
    const off = ensureOffsets(state.lastPlaced);
    off.scale = Number(garScale.value)/100;
    save();
    renderOutfit();
  });
  garOpacity.addEventListener("input", ()=>{
    garOpacityVal.textContent = String(garOpacity.value);
    if(!state.lastPlaced) return;
    const off = ensureOffsets(state.lastPlaced);
    off.opacity = Number(garOpacity.value)/100;
    save();
    renderOutfit();
  });

  document.getElementById("btnClearOutfit").addEventListener("click", ()=>{
    state.wear = { top:null, bottom:null, dress:null, shoes:null, acc:null };
    state.lastPlaced = null;
    save();
    renderOutfit();
  });
  document.getElementById("btnResetOffsets").addEventListener("click", ()=>{
    state.offsets = {};
    save();
    renderOutfit();
  });

  // Wardrobe UI
  const wardrobeEl = document.getElementById("wardrobe");
  const wardCount = document.getElementById("wardCount");
  let currentFilter = "all";

  function typeLabel(t){
    return t==="top" ? "Sopra" :
           t==="bottom" ? "Sotto" :
           t==="dress" ? "Intero" :
           t==="shoes" ? "Scarpe" : "Accessori";
  }

  function renderWardrobe(){
    wardrobeEl.innerHTML = "";
    const list = state.wardrobe.filter(it => currentFilter==="all" ? true : it.type === currentFilter);

    wardCount.textContent = String(list.length);

    list.sort((a,b)=> (b.createdAt||0) - (a.createdAt||0));

    for(const it of list){
      const card = document.createElement("div");
      card.className = "item";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      if(it.thumb){
        const im = document.createElement("img");
        im.src = it.thumb;
        thumb.appendChild(im);
      }else{
        thumb.textContent = it.type.toUpperCase();
      }

      const meta = document.createElement("div");
      meta.className = "meta";

      const t = document.createElement("div");
      t.className = "t";
      t.textContent = it.name || "Senza nome";

      const s = document.createElement("div");
      s.className = "s";
      s.textContent = `${typeLabel(it.type)} ‚Ä¢ viste: ${countViews(it)}/5`;

      const p = document.createElement("div");
      p.className = "p";

      const wearBtn = document.createElement("button");
      wearBtn.className = "btn primary";
      wearBtn.textContent = "Metti addosso";
      wearBtn.addEventListener("click", ()=>{
        // se √® dress, sostituisce top/bottom
        if(it.type === "dress"){
          state.wear.dress = it.id;
          state.wear.top = null;
          state.wear.bottom = null;
        }else{
          state.wear[it.type] = it.id;
          if(it.type === "top" || it.type === "bottom"){
            // se dress era attivo, toglilo (logica semplice)
            state.wear.dress = null;
          }
        }
        state.lastPlaced = it.id;
        ensureOffsets(it.id);
        save();
        setTab("studio");
        renderOutfit();
      });

      const editBtn = document.createElement("button");
      editBtn.className = "btn";
      editBtn.textContent = "Modifica / Carica vista";
      editBtn.addEventListener("click", ()=>{
        openCropForItem(it.id);
      });

      const delBtn = document.createElement("button");
      delBtn.className = "btn";
      delBtn.textContent = "Elimina";
      delBtn.addEventListener("click", ()=>{
        const idx = state.wardrobe.findIndex(x => x.id === it.id);
        if(idx>=0) state.wardrobe.splice(idx,1);
        // se indossato, toglilo
        for(const k of Object.keys(state.wear)){
          if(state.wear[k] === it.id) state.wear[k] = null;
        }
        delete state.offsets[it.id];
        if(state.lastPlaced === it.id) state.lastPlaced = null;
        save();
        renderWardrobe();
        renderOutfit();
      });

      p.appendChild(wearBtn);
      p.appendChild(editBtn);
      p.appendChild(delBtn);

      meta.appendChild(t);
      meta.appendChild(s);
      meta.appendChild(p);

      card.appendChild(thumb);
      card.appendChild(meta);
      wardrobeEl.appendChild(card);
    }
  }

  function countViews(it){
    return (it.views || []).filter(Boolean).length;
  }

  // Filter buttons
  document.querySelectorAll("[data-filter]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      currentFilter = btn.dataset.filter;
      renderWardrobe();
    });
  });

  document.getElementById("btnClearWard").addEventListener("click", ()=>{
    state.wardrobe = [];
    state.wear = { top:null, bottom:null, dress:null, shoes:null, acc:null };
    state.offsets = {};
    state.lastPlaced = null;
    save();
    renderWardrobe();
    renderOutfit();
  });

  // Demo (no 404): generate SVG data URLs
  function svgData(label){
    const svg =
`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512">
<defs>
<linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
  <stop offset="0" stop-color="#ffd56a" stop-opacity="0.35"/>
  <stop offset="1" stop-color="#66ffa8" stop-opacity="0.18"/>
</linearGradient>
</defs>
<rect width="512" height="512" rx="48" fill="#0b0b12"/>
<rect x="28" y="28" width="456" height="456" rx="40" fill="url(#g)" stroke="rgba(255,255,255,.18)"/>
<text x="256" y="270" font-family="system-ui,Segoe UI,Roboto" font-size="58" text-anchor="middle" fill="rgba(255,255,255,.92)" font-weight="800">${label}</text>
<text x="256" y="330" font-family="system-ui,Segoe UI,Roboto" font-size="18" text-anchor="middle" fill="rgba(255,255,255,.65)">demo ‚Ä¢ SerCucTech</text>
</svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  document.getElementById("btnLoadDemo").addEventListener("click", ()=>{
    const now = Date.now();
    state.wardrobe = [
      mkItem("T-shirt basic", "top", svgData("TOP"), now-1),
      mkItem("Jeans slim", "bottom", svgData("PANT"), now-2),
      mkItem("Vestito casual", "dress", svgData("DRESS"), now-3),
      mkItem("Sneakers", "shoes", svgData("SHOES"), now-4),
      mkItem("Cappello", "acc", svgData("ACC"), now-5),
      mkItem("Giacca", "top", svgData("JACKET"), now-6),
    ];
    save();
    renderWardrobe();
    status.textContent = "OK";
  });

  function mkItem(name, type, dataUrl, createdAt){
    const id = "g_" + Math.random().toString(36).slice(2,10);
    return {
      id, name, type,
      views: [dataUrl, dataUrl, dataUrl, dataUrl, dataUrl],
      thumb: dataUrl,
      createdAt
    };
  }

  // Crop modal + OCR
  const cropModal = document.getElementById("cropModal");
  const btnCloseCrop = document.getElementById("btnCloseCrop");
  const btnSaveGar = document.getElementById("btnSaveGar");
  const btnDeleteGar = document.getElementById("btnDeleteGar");
  const garFile = document.getElementById("garFile");
  const garName = document.getElementById("garName");
  const garType = document.getElementById("garType");
  const garView = document.getElementById("garView");
  const slZoom = document.getElementById("slZoom");
  const slCrop = document.getElementById("slCrop");
  const btnSelName = document.getElementById("btnSelName");
  const btnCopyName = document.getElementById("btnCopyName");
  const btnPasteName = document.getElementById("btnPasteName");
  const btnOcrName = document.getElementById("btnOcrName");
  const ocrStatus = document.getElementById("ocrStatus");

  const cropCanvas = document.getElementById("cropCanvas");
  const cropStage = document.getElementById("cropStage");
  const cctx = cropCanvas.getContext("2d");

  let editingItemId = null;

  const cropState = {
    zoom: 1.10,
    cropSize: 0.80,
    imgDX: 0,
    imgDY: 0,
  };
  let cropImg = new Image();
  let cropImgLoaded = false;
  let cropDrag = null;

  function openCropForItem(itemId){
    editingItemId = itemId || null;

    // default
    ocrStatus.textContent = "";
    garFile.value = "";
    cropImgLoaded = false;
    cropImg = new Image();

    if(itemId){
      const it = state.wardrobe.find(x => x.id === itemId);
      if(it){
        garName.value = it.name || "";
        garType.value = it.type || "top";
        // lascia vista selezionata dall'utente
      }
      btnDeleteGar.style.display = "";
    }else{
      garName.value = "";
      garType.value = "top";
      garView.value = "0";
      btnDeleteGar.style.display = "none";
    }

    cropState.zoom = 1.10;
    cropState.cropSize = 0.80;
    cropState.imgDX = 0;
    cropState.imgDY = 0;
    slZoom.value = "110";
    slCrop.value = "80";

    cropModal.classList.add("open");
    cropModal.setAttribute("aria-hidden","false");
    resizeCropCanvas();
    drawCrop();
  }

  function closeCropModal(){
    cropModal.classList.remove("open");
    cropModal.setAttribute("aria-hidden","true");
  }

  document.getElementById("btnAddGarment").addEventListener("click", ()=> openCropForItem(null));
  btnCloseCrop.addEventListener("click", closeCropModal);
  cropModal.addEventListener("click", (e)=>{ if(e.target === cropModal) closeCropModal(); });

  // Select / copy / paste
  btnSelName.addEventListener("click", ()=>{
    garName.focus();
    garName.select();
  });
  btnCopyName.addEventListener("click", async ()=>{
    try{
      garName.focus(); garName.select();
      await navigator.clipboard.writeText(garName.value || "");
      ocrStatus.textContent = "Copiato ‚úÖ";
    }catch{
      ocrStatus.textContent = "Non posso copiare (permessi browser).";
    }
  });
  btnPasteName.addEventListener("click", async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      if(t) garName.value = t.trim();
      ocrStatus.textContent = "Incollato ‚úÖ";
    }catch{
      ocrStatus.textContent = "Non posso incollare (permessi browser).";
    }
  });

  // OCR from crop
  async function ocrFromCurrentCrop(){
    try{
      if(!window.Tesseract) return showErr("OCR non disponibile: libreria non caricata.");
      if(!cropImgLoaded) return showErr("Prima seleziona un'immagine del capo.");

      ocrStatus.textContent = "OCR‚Ä¶ (attendi)";
      btnOcrName.disabled = true;

      // render current crop area into a temp canvas
      const r = getCropRect();
      const tmp = document.createElement("canvas");
      tmp.width = 900; tmp.height = 900;
      const tctx = tmp.getContext("2d");

      // draw current visible (same as drawCrop)
      const W = cropCanvas.width, H = cropCanvas.height;
      const imgW = cropImg.naturalWidth, imgH = cropImg.naturalHeight;
      const base = Math.min(W / imgW, H / imgH);
      const fit = base * cropState.zoom;
      const drawW = imgW * fit;
      const drawH = imgH * fit;
      const x = (W - drawW)/2 + cropState.imgDX;
      const y = (H - drawH)/2 + cropState.imgDY;

      const stageTmp = document.createElement("canvas");
      stageTmp.width = W; stageTmp.height = H;
      const sctx = stageTmp.getContext("2d");
      sctx.clearRect(0,0,W,H);
      sctx.drawImage(cropImg, x, y, drawW, drawH);

      tctx.drawImage(stageTmp, r.x, r.y, r.w, r.h, 0, 0, tmp.width, tmp.height);

      const dataUrl = tmp.toDataURL("image/png");

      const res = await Tesseract.recognize(dataUrl, "ita+eng", {
        logger: m => {
          if(m?.status === "recognizing text" && typeof m.progress === "number"){
            ocrStatus.textContent = `OCR‚Ä¶ ${(m.progress*100).toFixed(0)}%`;
          }
        }
      });

      let text = (res?.data?.text || "").trim();
      text = text
        .split("\n")
        .map(s => s.trim())
        .filter(Boolean)
        .join(" ")
        .replace(/\s+/g, " ")
        .trim();

      if(!text){
        ocrStatus.textContent = "OCR finito: nessun testo trovato. Prova ritaglio pi√π stretto.";
        return;
      }

      garName.value = text;
      ocrStatus.textContent = "OCR finito ‚úÖ Nome inserito.";
    }catch(e){
      showErr(e.message || String(e));
    }finally{
      btnOcrName.disabled = false;
    }
  }
  btnOcrName.addEventListener("click", ocrFromCurrentCrop);

  // Crop render
  function resizeCropCanvas(){
    const rect = cropStage.getBoundingClientRect();
    const dpr = Math.min(2, window.devicePixelRatio || 1);
    cropCanvas.width = Math.floor(rect.width * dpr);
    cropCanvas.height = Math.floor(rect.height * dpr);
    cctx.setTransform(dpr,0,0,dpr,0,0);
    drawCrop();
  }
  window.addEventListener("resize", ()=>{
    if(cropModal.classList.contains("open")) resizeCropCanvas();
    // re-render outfit if stage changes size
    renderOutfit();
  });

  slZoom.addEventListener("input", ()=>{
    cropState.zoom = Number(slZoom.value)/100;
    drawCrop();
  });
  slCrop.addEventListener("input", ()=>{
    cropState.cropSize = Number(slCrop.value)/100;
    drawCrop();
  });

  function getCropRect(){
    const W = cropStage.clientWidth;
    const H = cropStage.clientHeight;
    const s = cropState.cropSize;
    const size = Math.min(W,H) * s;
    const x = (W - size)/2;
    const y = (H - size)/2;
    return { x, y, w:size, h:size };
  }

  function drawCrop(){
    const W = cropStage.clientWidth;
    const H = cropStage.clientHeight;
    cctx.clearRect(0,0,W,H);

    // background
    cctx.fillStyle = "#070710";
    cctx.fillRect(0,0,W,H);

    if(cropImgLoaded){
      const imgW = cropImg.naturalWidth, imgH = cropImg.naturalHeight;
      const base = Math.min(W / imgW, H / imgH);
      const fit = base * cropState.zoom;
      const drawW = imgW * fit;
      const drawH = imgH * fit;

      const x = (W - drawW)/2 + cropState.imgDX;
      const y = (H - drawH)/2 + cropState.imgDY;

      cctx.drawImage(cropImg, x, y, drawW, drawH);
    }else{
      cctx.fillStyle = "rgba(255,255,255,.08)";
      cctx.font = "600 14px system-ui";
      cctx.fillText("Seleziona un'immagine del capo‚Ä¶", 18, 28);
    }

    // dark mask + crop rect
    const r = getCropRect();
    cctx.save();
    cctx.fillStyle = "rgba(0,0,0,.45)";
    cctx.fillRect(0,0,W,H);
    cctx.clearRect(r.x, r.y, r.w, r.h);
    cctx.restore();

    // crop border
    cctx.strokeStyle = "rgba(255,213,106,.55)";
    cctx.lineWidth = 2;
    cctx.strokeRect(r.x, r.y, r.w, r.h);
  }

  // drag image in crop
  cropStage.addEventListener("pointerdown", (ev)=>{
    if(!cropImgLoaded) return;
    cropDrag = { x: ev.clientX, y: ev.clientY, dx: cropState.imgDX, dy: cropState.imgDY };
    cropStage.setPointerCapture(ev.pointerId);
  });
  cropStage.addEventListener("pointermove", (ev)=>{
    if(!cropDrag) return;
    const dx = ev.clientX - cropDrag.x;
    const dy = ev.clientY - cropDrag.y;
    cropState.imgDX = cropDrag.dx + dx;
    cropState.imgDY = cropDrag.dy + dy;
    drawCrop();
  });
  cropStage.addEventListener("pointerup", ()=> cropDrag=null);
  cropStage.addEventListener("pointercancel", ()=> cropDrag=null);

  // load garment file into crop image
  garFile.addEventListener("change", async ()=>{
    const f = garFile.files?.[0];
    if(!f) return;
    try{
      const url = await fileToDataURL(f);
      cropImg = new Image();
      cropImgLoaded = false;
      cropImg.onload = ()=>{
        cropImgLoaded = true;
        cropState.imgDX = 0;
        cropState.imgDY = 0;
        drawCrop();
      };
      cropImg.src = url;
      ocrStatus.textContent = "Immagine caricata ‚úÖ Regola ritaglio e salva.";
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Save garment (cropped)
  function cropToDataUrl(){
    const W = cropStage.clientWidth;
    const H = cropStage.clientHeight;
    if(!cropImgLoaded) throw new Error("Nessuna immagine capo caricata.");

    // Create a canvas with crop content only
    const r = getCropRect();
    const out = document.createElement("canvas");
    out.width = 900; out.height = 900;
    const octx = out.getContext("2d");

    // Build full stage image into temp
    const tmp = document.createElement("canvas");
    tmp.width = W; tmp.height = H;
    const tctx = tmp.getContext("2d");
    tctx.fillStyle = "#070710";
    tctx.fillRect(0,0,W,H);

    const imgW = cropImg.naturalWidth, imgH = cropImg.naturalHeight;
    const base = Math.min(W / imgW, H / imgH);
    const fit = base * cropState.zoom;
    const drawW = imgW * fit;
    const drawH = imgH * fit;
    const x = (W - drawW)/2 + cropState.imgDX;
    const y = (H - drawH)/2 + cropState.imgDY;
    tctx.drawImage(cropImg, x, y, drawW, drawH);

    // copy crop rect into out (scaled)
    octx.drawImage(tmp, r.x, r.y, r.w, r.h, 0, 0, out.width, out.height);
    return out.toDataURL("image/png");
  }

  btnSaveGar.addEventListener("click", ()=>{
    try{
      const name = (garName.value || "").trim() || "Senza nome";
      const type = garType.value;
      const v = Number(garView.value);

      const dataUrl = cropToDataUrl();

      let item = null;
      if(editingItemId){
        item = state.wardrobe.find(x => x.id === editingItemId);
      }

      if(!item){
        item = {
          id: "g_" + Math.random().toString(36).slice(2,10),
          name,
          type,
          views: [null,null,null,null,null],
          thumb: null,
          createdAt: Date.now()
        };
        state.wardrobe.push(item);
      }else{
        item.name = name;
        item.type = type;
      }

      // set view
      item.views[v] = dataUrl;

      // if missing other views, auto-fill them with the same image
      for(let i=0;i<5;i++){
        if(!item.views[i]) item.views[i] = item.views[v];
      }

      // thumb: use front (0)
      item.thumb = item.views[0] || dataUrl;

      save();
      renderWardrobe();
      closeCropModal();
      status.textContent = "OK";
    }catch(e){
      showErr(e.message || String(e));
    }
  });

  btnDeleteGar.addEventListener("click", ()=>{
    if(!editingItemId) return;
    const idx = state.wardrobe.findIndex(x => x.id === editingItemId);
    if(idx>=0) state.wardrobe.splice(idx,1);

    // remove from wear
    for(const k of Object.keys(state.wear)){
      if(state.wear[k] === editingItemId) state.wear[k] = null;
    }
    delete state.offsets[editingItemId];
    if(state.lastPlaced === editingItemId) state.lastPlaced = null;

    save();
    renderWardrobe();
    renderOutfit();
    closeCropModal();
  });

  // Open crop from wardrobe
  function openCropForItem(id){
    openCropForItemInternal(id);
  }
  function openCropForItemInternal(id){
    editingItemId = id || null;
    openCropForItemUI();
  }
  function openCropForItemUI(){
    // prefill
    ocrStatus.textContent = "";
    garFile.value = "";
    cropImgLoaded = false;
    cropImg = new Image();

    if(editingItemId){
      const it = state.wardrobe.find(x => x.id === editingItemId);
      if(it){
        garName.value = it.name || "";
        garType.value = it.type || "top";
      }
      btnDeleteGar.style.display = "";
    }else{
      garName.value = "";
      garType.value = "top";
      garView.value = "0";
      btnDeleteGar.style.display = "none";
    }

    cropState.zoom = 1.10;
    cropState.cropSize = 0.80;
    cropState.imgDX = 0;
    cropState.imgDY = 0;
    slZoom.value = "110";
    slCrop.value = "80";

    cropModal.classList.add("open");
    cropModal.setAttribute("aria-hidden","false");
    setTimeout(()=>{ resizeCropCanvas(); drawCrop(); }, 0);
  }

  // Override: renderWardrobe edit button uses this real open:
  // (done above in renderWardrobe via openCropForItem(it.id))

  // Add garment button
  document.getElementById("btnAddGarment").addEventListener("click", ()=>{
    editingItemId = null;
    openCropForItemUI();
  });

  // init
  renderPerson();
  renderWardrobe();
  setView(state.activeView || 0);
  renderOutfit();
  status.textContent = "OK";
})();
</script>

<!-- PWA -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(()=>{});
    });
  }
</script>
</body>
</html>
