<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D</title>
  <meta name="theme-color" content="#0b0b12" />

  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,213,106,.12);
      border-color:rgba(255,213,106,.25);
    }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
    }
    .card .body{ padding:12px 14px; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    select, input[type="text"]{
      width:100%; box-sizing:border-box;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    /* STAGE */
    .stageWrap{
      border:1px solid rgba(255,255,255,.10);
      background:#090912;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      height:560px;
    }
    @media(max-width:980px){ .stageWrap{ height:480px; } }

    .stage{
      position:absolute; inset:0;
      display:grid; place-items:center;
      transform-origin:center center;
    }

    /* rotazione */
    .spinOn{ animation: spin 4s linear infinite; }
    @keyframes spin { from{ transform:rotate(0deg); } to{ transform:rotate(360deg); } }

    .canvasArea{
      position:relative;
      width:min(420px, 92vw);
      height:min(520px, 120vw);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      touch-action:none;
    }

    .layer{
      position:absolute;
      left:50%; top:50%;
      transform:translate(-50%,-50%);
      transform-origin:center center;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none; /* di default: non blocca */
      max-width:100%;
      max-height:100%;
    }

    /* gruppo outfit (sopra al modello) */
    #outfitGroup{ position:absolute; inset:0; pointer-events:auto; } /* per drag */
    #outfitGroup .layer{ pointer-events:none; } /* le img non prendono click */

    .hint{
      position:absolute; left:10px; top:10px; z-index:5;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.9);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      backdrop-filter: blur(8px);
    }

    /* GUARDAROBA */
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
      cursor:pointer;
    }
    .thumb{
      width:84px; height:84px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }

    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.08);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }

    .mini{
      font-size:12px; color:var(--muted);
      border:1px dashed rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      padding:10px;
      border-radius:14px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D</div>
          <div class="sub">Carichi persona ‚Üí clicchi un capo ‚Üí va addosso ‚Ä¢ Rotazione outfit + Auto-gira</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">OK</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">

      <div class="card">
        <h2><span>Avatar (foto) + outfit</span><span class="sub">drag = sposta ultimo capo</span></h2>
        <div class="body">
          <div class="stageWrap">
            <div class="stage" id="spinTarget">
              <div class="canvasArea" id="canvasArea">
                <div class="hint">1) Carica la foto persona ‚Ä¢ 2) Vai su Guardaroba ‚Ä¢ 3) Clicca un capo</div>

                <!-- MODELLO -->
                <img id="modelImg" class="layer" alt="modello" />

                <!-- OUTFIT GROUP (overlay) -->
                <div id="outfitGroup">
                  <img id="layerTop"    class="layer" alt="top" />
                  <img id="layerJacket" class="layer" alt="jacket" />
                  <img id="layerBottom" class="layer" alt="bottom" />
                  <img id="layerSkirt"  class="layer" alt="skirt" />
                  <img id="layerDress"  class="layer" alt="dress" />
                  <img id="layerShoes"  class="layer" alt="shoes" />
                </div>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="btnUploadPerson">üì∑ Carica persona</button>
            <button class="btn" id="btnClearOutfit">üßΩ Svuota outfit</button>
            <button class="btn" id="btnSpin">üîÑ Gira su se stesso: OFF</button>
          </div>

          <div style="height:10px"></div>

          <div class="mini">
            Suggerimento: usa vestiti <b>PNG trasparenti</b>. Se non li hai, l‚Äôapp mostra comunque placeholder.
          </div>
        </div>
      </div>

      <div class="card">
        <h2><span>Controlli outfit</span><span class="sub">auto & livelli</span></h2>
        <div class="body">
          <label>Ultimo capo selezionato (drag)</label>
          <input id="lastType" type="text" readonly value="nessuno" />

          <label>Modalit√† modello</label>
          <select id="profile">
            <option value="adulto">Adulto (uomo/donna)</option>
            <option value="bambino">Bambino</option>
            <option value="bambina">Bambina</option>
          </select>

          <div style="height:12px"></div>

          <div class="row">
            <button class="btn" id="btnCenter">üéØ Centra ultimo capo</button>
            <button class="btn" id="btnResetPos">‚Ü©Ô∏è Reset posizioni</button>
          </div>

          <div style="height:10px"></div>

          <div class="mini">
            Nota: per ‚Äúsomigliare alla foto‚Äù al 100% servono modelli 3D/ML. Qui facciamo un sistema 2D solido: foto + overlay vestiti.
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba (clicca un capo ‚Üí va addosso)</span><span class="sub">PNG trasparente consigliato</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnLoadDefault">üì¶ Carica guardaroba base</button>
          <button class="btn" id="btnClearWard">üßπ Svuota guardaroba</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <label style="margin-top:12px">Filtra per tipo</label>
        <select id="filterType">
          <option value="all">Tutti</option>
          <option value="top">Camicia / Maglia (TOP)</option>
          <option value="jacket">Giacca / Felpa (GIACCA)</option>
          <option value="bottom">Pantalone / Jeans (PANTALONE)</option>
          <option value="skirt">Gonna (GONNA)</option>
          <option value="dress">Vestito / Abito (ABITO)</option>
          <option value="shoes">Scarpe (SCARPE)</option>
        </select>

        <div style="height:12px"></div>
        <div class="cards" id="wardrobe"></div>

        <div style="height:12px"></div>
        <div class="mini">
          Vuoi i vestiti reali? Carica PNG trasparenti tuoi oppure li metti in repo dentro <b>assets/wardrobe/</b>.
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida</span><span class="sub">passi semplici</span></h2>
      <div class="body">
        <div class="mini">
          <b>1)</b> Studio ‚Üí ‚ÄúCarica persona‚Äù (foto intera, ben illuminata).<br/>
          <b>2)</b> Guardaroba ‚Üí ‚ÄúCarica guardaroba base‚Äù.<br/>
          <b>3)</b> Clicca un capo: appare subito addosso.<br/>
          <b>4)</b> ‚ÄúGira su se stesso‚Äù per vedere l‚Äôinsieme (auto-rotazione).<br/>
          <b>5)</b> Trascina sul modello per spostare l‚Äôultimo capo messo.
        </div>
      </div>
    </div>
  </section>

</main>

<input id="filePerson" type="file" accept="image/*" style="display:none" />

<div id="errBox"></div>

<script>
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida")
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // Storage
  const KEY = "sercuctech_vs2d_state_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.personDataUrl ??= "";
  state.wardrobe ??= [];
  state.outfit ??= { top:"", jacket:"", bottom:"", skirt:"", dress:"", shoes:"" };
  state.pos ??= {
    top:{x:0,y:0}, jacket:{x:0,y:0}, bottom:{x:0,y:0}, skirt:{x:0,y:0}, dress:{x:0,y:0}, shoes:{x:0,y:0}
  };
  state.lastType ??= "";

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // SVG fallback (NO LINK ESTERNI)
  function svgData(type, label){
    const map = {
      top:    { t:"TOP",    c:"#ffd56a" },
      jacket: { t:"GIACCA", c:"#ff9a6a" },
      bottom: { t:"PANT",   c:"#6ab7ff" },
      skirt:  { t:"GONNA",  c:"#b86aff" },
      dress:  { t:"ABITO",  c:"#6affb2" },
      shoes:  { t:"SCARPE", c:"#d0d0d0" }
    };
    const x = map[type] || {t:"CAPO", c:"#aaa"};
    const text = label || x.t;
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="800" height="1000">
        <defs>
          <linearGradient id="g" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0" stop-color="rgba(255,255,255,0.08)"/>
            <stop offset="1" stop-color="rgba(0,0,0,0.22)"/>
          </linearGradient>
        </defs>
        <rect width="800" height="1000" rx="40" fill="url(#g)"/>
        <rect x="40" y="40" width="720" height="920" rx="34" fill="rgba(0,0,0,0.22)" stroke="rgba(255,255,255,0.14)" stroke-width="4"/>
        <text x="50%" y="46%" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="84" fill="${x.c}" font-weight="900">${text}</text>
        <text x="50%" y="58%" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="26" fill="rgba(255,255,255,0.75)">placeholder (carica PNG trasparente)</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  // Elements
  const modelImg = document.getElementById("modelImg");
  const layers = {
    top: document.getElementById("layerTop"),
    jacket: document.getElementById("layerJacket"),
    bottom: document.getElementById("layerBottom"),
    skirt: document.getElementById("layerSkirt"),
    dress: document.getElementById("layerDress"),
    shoes: document.getElementById("layerShoes")
  };
  const lastTypeEl = document.getElementById("lastType");
  const wardrobeEl = document.getElementById("wardrobe");
  const wardCount = document.getElementById("wardCount");
  const filterType = document.getElementById("filterType");

  // Init model
  function renderModel(){
    if(state.personDataUrl){
      modelImg.src = state.personDataUrl;
    }else{
      modelImg.src = svgData("top", "PERSONA");
    }
    modelImg.onload = ()=>{};
    modelImg.onerror = ()=>{ modelImg.src = svgData("top","PERSONA"); };
  }

  // Apply outfit
  function applyLayer(type, src){
    state.outfit[type] = src || "";
    state.lastType = type;
    lastTypeEl.value = type;

    // mostra subito
    const img = layers[type];
    img.src = src || svgData(type);
    img.style.display = "block";
    img.onerror = ()=>{ img.src = svgData(type); };

    // applica posizione salvata
    applyPos(type);

    save();
  }

  function applyAllOutfit(){
    Object.keys(layers).forEach(type=>{
      const img = layers[type];
      const src = state.outfit[type];
      img.src = src ? src : svgData(type);
      img.style.display = "block";
      img.onerror = ()=>{ img.src = svgData(type); };
      applyPos(type);
    });
    lastTypeEl.value = state.lastType || "nessuno";
  }

  function clearOutfit(){
    state.outfit = { top:"", jacket:"", bottom:"", skirt:"", dress:"", shoes:"" };
    state.lastType = "";
    lastTypeEl.value = "nessuno";
    Object.keys(layers).forEach(type=>{
      layers[type].src = svgData(type);
      layers[type].style.display = "block";
      state.pos[type] = {x:0,y:0};
      applyPos(type);
    });
    save();
  }

  function applyPos(type){
    const p = state.pos[type] || {x:0,y:0};
    layers[type].style.transform = `translate(calc(-50% + ${p.x}px), calc(-50% + ${p.y}px))`;
  }

  // Profile (ridimensiona canvas per bimbi) - semplice
  const profile = document.getElementById("profile");
  const canvasArea = document.getElementById("canvasArea");
  function applyProfile(){
    const v = profile.value;
    if(v === "adulto"){
      canvasArea.style.width = "min(420px, 92vw)";
      canvasArea.style.height = "min(520px, 120vw)";
    }else{
      canvasArea.style.width = "min(380px, 92vw)";
      canvasArea.style.height = "min(480px, 120vw)";
    }
    localStorage.setItem("vs2d_profile", v);
  }
  profile.value = localStorage.getItem("vs2d_profile") || "adulto";
  profile.addEventListener("change", applyProfile);
  applyProfile();

  // Spin button
  const spinTarget = document.getElementById("spinTarget");
  const btnSpin = document.getElementById("btnSpin");
  let spinning = false;
  function setSpin(on){
    spinning = !!on;
    spinTarget.classList.toggle("spinOn", spinning);
    btnSpin.textContent = `üîÑ Gira su se stesso: ${spinning ? "ON" : "OFF"}`;
  }
  btnSpin.addEventListener("click", ()=> setSpin(!spinning));

  // Upload person
  const filePerson = document.getElementById("filePerson");
  document.getElementById("btnUploadPerson").addEventListener("click", ()=> filePerson.click());
  filePerson.addEventListener("change", async ()=>{
    const f = filePerson.files && filePerson.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    state.personDataUrl = dataUrl;
    save();
    renderModel();
  });

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result));
      r.onerror = ()=> reject(r.error);
      r.readAsDataURL(file);
    });
  }

  // Wardrobe default (NO imgur)
  function defaultWardrobe(){
    return [
      { id:"u_top",    title:"Camicia Uomo",   type:"top",    img: svgData("top","TOP") },
      { id:"u_jacket", title:"Giacca Uomo",    type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"u_bottom", title:"Pantalone Uomo", type:"bottom", img: svgData("bottom","PANT") },
      { id:"u_shoes",  title:"Scarpe Uomo",    type:"shoes",  img: svgData("shoes","SCARPE") },

      { id:"d_top",    title:"Maglia Donna",   type:"top",    img: svgData("top","TOP") },
      { id:"d_jacket", title:"Giacca Donna",   type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"d_skirt",  title:"Gonna Donna",    type:"skirt",  img: svgData("skirt","GONNA") },
      { id:"d_dress",  title:"Vestito Donna",  type:"dress",  img: svgData("dress","ABITO") },

      { id:"b_top",    title:"Maglia Bambino", type:"top",    img: svgData("top","TOP") },
      { id:"b_jacket", title:"Felpa Bambino",  type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"b_bottom", title:"Pantalone Bimbo",type:"bottom", img: svgData("bottom","PANT") },
      { id:"b_shoes",  title:"Scarpe Bimbo",   type:"shoes",  img: svgData("shoes","SCARPE") },

      { id:"bb_top",   title:"Maglia Bambina", type:"top",    img: svgData("top","TOP") },
      { id:"bb_skirt", title:"Gonna Bambina",  type:"skirt",  img: svgData("skirt","GONNA") },
      { id:"bb_dress", title:"Vestito Bimba",  type:"dress",  img: svgData("dress","ABITO") },
      { id:"bb_shoes", title:"Scarpe Bimba",   type:"shoes",  img: svgData("shoes","SCARPE") }
    ];
  }

  document.getElementById("btnLoadDefault").addEventListener("click", ()=>{
    state.wardrobe = defaultWardrobe();
    save();
    renderWardrobe();
    setTab("guardaroba");
  });

  document.getElementById("btnClearWard").addEventListener("click", ()=>{
    state.wardrobe = [];
    save();
    renderWardrobe();
  });

  filterType.addEventListener("change", renderWardrobe);

  function renderWardrobe(){
    wardrobeEl.innerHTML = "";
    const list = Array.isArray(state.wardrobe) ? state.wardrobe : [];
    wardCount.textContent = String(list.length);

    const ft = filterType.value;
    const filtered = ft === "all" ? list : list.filter(x => x.type === ft);

    filtered.forEach(item=>{
      const card = document.createElement("div");
      card.className = "item";
      card.title = "Clicca per mettere addosso";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const im = document.createElement("img");
      im.src = item.img || svgData(item.type);
      im.onerror = ()=>{ im.src = svgData(item.type); };
      thumb.appendChild(im);

      const meta = document.createElement("div");
      meta.className = "meta";
      const t = document.createElement("div");
      t.className = "t";
      t.textContent = item.title || "Capo";
      const s = document.createElement("div");
      s.className = "s";
      s.textContent = (item.type || "capo").toUpperCase();

      meta.appendChild(t);
      meta.appendChild(s);

      card.appendChild(thumb);
      card.appendChild(meta);

      // CLICK: mette addosso subito + porta in Studio
      card.addEventListener("click", ()=>{
        applyLayer(item.type, item.img);
        // quando metti un capo: se rotazione off, non la forziamo. Se vuoi forzarla, scommenta:
        // setSpin(true);
        setTab("studio");
      });

      wardrobeEl.appendChild(card);
    });

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "Guardaroba vuoto (premi ‚ÄúCarica guardaroba base‚Äù).";
      wardrobeEl.appendChild(empty);
    }
  }

  // Outfit buttons
  document.getElementById("btnClearOutfit").addEventListener("click", clearOutfit);

  document.getElementById("btnCenter").addEventListener("click", ()=>{
    const t = state.lastType;
    if(!t) return;
    state.pos[t] = {x:0,y:0};
    applyPos(t);
    save();
  });

  document.getElementById("btnResetPos").addEventListener("click", ()=>{
    Object.keys(state.pos).forEach(k=> state.pos[k] = {x:0,y:0});
    Object.keys(layers).forEach(applyPos);
    save();
  });

  // DRAG: sposta ultimo capo messo
  const outfitGroup = document.getElementById("outfitGroup");
  let dragging = false;
  let startX = 0, startY = 0;
  let baseX = 0, baseY = 0;

  function getPoint(ev){
    const e = ev.touches ? ev.touches[0] : ev;
    return { x:e.clientX, y:e.clientY };
  }

  outfitGroup.addEventListener("pointerdown", (ev)=>{
    if(!state.lastType) return;
    dragging = true;
    outfitGroup.setPointerCapture(ev.pointerId);
    const p = getPoint(ev);
    startX = p.x; startY = p.y;
    const cur = state.pos[state.lastType] || {x:0,y:0};
    baseX = cur.x; baseY = cur.y;
  });

  outfitGroup.addEventListener("pointermove", (ev)=>{
    if(!dragging || !state.lastType) return;
    const p = getPoint(ev);
    const dx = p.x - startX;
    const dy = p.y - startY;
    state.pos[state.lastType] = { x: Math.round(baseX + dx), y: Math.round(baseY + dy) };
    applyPos(state.lastType);
  });

  outfitGroup.addEventListener("pointerup", ()=>{
    if(!dragging) return;
    dragging = false;
    save();
  });
  outfitGroup.addEventListener("pointercancel", ()=>{
    if(!dragging) return;
    dragging = false;
    save();
  });

  // INIT
  renderModel();
  applyAllOutfit();
  renderWardrobe();
  lastTypeEl.value = state.lastType || "nessuno";
  setSpin(false);
</script>
</body>
</html>
