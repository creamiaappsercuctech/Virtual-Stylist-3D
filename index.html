<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1, viewport-fit=cover" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</title>
  <meta name="theme-color" content="#0b0b12" />

  <!-- PWA (opzionale): se metti manifest.json + sw.js nella stessa cartella, attiva -->
  <link rel="manifest" href="./manifest.json">

  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.03); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      --danger:#ff6a6a;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--txt)}
    header{
      position:sticky;top:0;z-index:10;
      background:rgba(11,11,18,.86);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1100px;margin:0 auto;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900; flex:0 0 auto;
    }
    .sub{color:var(--muted);font-size:12px;line-height:1.35}
    .pill{
      display:inline-flex;gap:8px;align-items:center;padding:6px 10px;
      border-radius:999px;border:1px solid var(--line);
      background:var(--card);color:var(--muted);font-size:12px;
    }
    .pill b{color:var(--txt)}
    .tabs{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;border-radius:999px;
      cursor:pointer;user-select:none;
    }
    .tab.active{background:rgba(255,213,106,.12);border-color:rgba(255,213,106,.25)}
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0;font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex;justify-content:space-between;align-items:center;
    }
    .card .body{padding:12px 14px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:10px 12px;border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }
    .btn.danger{
      background:rgba(255,106,106,.10);
      border-color:rgba(255,106,106,.30);
    }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input[type="text"], select, textarea{
      width:100%;padding:10px;border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }
    input[type="range"]{width:100%}
    textarea{min-height:90px;resize:vertical}

    .section{display:none}
    .section.active{display:block}

    /* STAGE */
    .stageWrap{
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px;
      background:#080812;
      overflow:hidden;
      position:relative;
    }
    .stageBar{
      display:flex; gap:10px; flex-wrap:wrap;
      padding:10px; border-bottom:1px solid rgba(255,255,255,.06);
      background:rgba(255,255,255,.02);
      align-items:center;
      justify-content:space-between;
    }
    .stageBar .group{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .stage{
      position:relative;
      width:100%;
      height:min(70vh, 680px);
      background:#0b0b12;
      touch-action:none; /* per drag su mobile */
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .stageInner{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
    }

    /* Persona (img) */
    .personLayer{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
    }
    .personLayer img{
      max-width:100%;
      max-height:100%;
      width:auto;
      height:auto;
      object-fit:contain; /* NO schiacciamento */
      image-rendering:auto;
      user-select:none;
      pointer-events:none;
    }

    /* Capi in scena */
    .sceneItem{
      position:absolute;
      left:0; top:0;
      transform-origin:center center;
      user-select:none;
      touch-action:none;
    }
    .sceneItem img{
      width:100%; height:100%;
      object-fit:contain;
      pointer-events:none; /* il drag √® sul wrapper */
      user-select:none;
    }
    .sceneItem.selected{
      outline:2px dashed rgba(255,213,106,.65);
      outline-offset:2px;
    }
    .handle{
      position:absolute;
      width:18px;height:18px;
      background:#69d7ff;
      border:2px solid rgba(0,0,0,.35);
      border-radius:999px;
      z-index:3;
      touch-action:none;
    }
    .h-nw{left:-9px;top:-9px}
    .h-ne{right:-9px;top:-9px}
    .h-sw{left:-9px;bottom:-9px}
    .h-se{right:-9px;bottom:-9px}

    /* Modal */
    .modalOverlay{
      position:fixed; inset:0; z-index:999;
      background:rgba(0,0,0,.55);
      display:none;
      align-items:center; justify-content:center;
      padding:14px;
    }
    .modal{
      width:min(920px, 100%);
      max-height:92vh;
      overflow:auto;              /* SCORREVOLE */
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,11,18,.96);
      backdrop-filter: blur(10px);
      border-radius:18px;
      box-shadow: 0 12px 40px rgba(0,0,0,.55);
    }
    .modalHead{
      position:sticky; top:0;
      background:rgba(11,11,18,.96);
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:12px 14px;
      display:flex; justify-content:space-between; align-items:center;
      z-index:2;
    }
    .modalHead .x{
      width:38px;height:38px;border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      cursor:pointer;
    }
    .modalBody{padding:12px 14px}

    /* Crop editor */
    .cropWrap{
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px;
      background:#07070f;
      overflow:hidden;
    }
    .cropStage{
      position:relative;
      width:100%;
      height:min(58vh, 520px);
      touch-action:none;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    canvas{display:block}

    .cropHint{
      position:absolute; top:10px; left:10px; right:10px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px; color:rgba(255,255,255,.92);
      z-index:5;
    }
    .divider{height:12px}

    /* Wardrobe */
    .cards{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    @media(max-width:680px){.cards{grid-template-columns:1fr}}
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
    }
    .thumb{
      width:84px;height:84px;border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:grid;place-items:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .thumb img{width:100%;height:100%;object-fit:cover}
    .meta{flex:1 1 auto;min-width:0}
    .meta .t{font-weight:900;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .meta .s{font-size:12px;color:var(--muted);margin-top:2px}
    .meta .p{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap}

    /* Error box */
    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.10);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row" style="min-width:0">
        <div class="brand">SC</div>
        <div style="min-width:0">
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Persona 4 viste ‚Ä¢ Guardaroba ‚Ä¢ Ritaglio PRO ‚Ä¢ Rotazione ‚Ä¢ Fullscreen ‚Ä¢ Testo su capo (OCR manuale)</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">Avvio‚Ä¶</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">

      <div class="card">
        <h2>
          <span>Persona vestita + Rotazione</span>
          <span class="sub">fronte ‚Üí fianco dx ‚Üí retro ‚Üí fianco sx</span>
        </h2>
        <div class="body">

          <div class="stageWrap">
            <div class="stageBar">
              <div class="group">
                <button class="btn primary" id="btnUploadPerson">üì∑ Carica persona (4 viste)</button>
                <button class="btn" id="btnRotateOnce">‚Ü™Ô∏è Rotazione</button>
                <button class="btn" id="btnAuto">‚ñ∂Ô∏è Auto</button>
                <button class="btn" id="btnStop">‚èπ Stop</button>
              </div>

              <div class="group">
                <button class="btn" id="btnFullscreen">‚õ∂ Fullscreen</button>
                <button class="btn danger" id="btnClearScene">üßπ Pulisci capi</button>
              </div>
            </div>

            <div class="stage" id="stage">
              <div class="stageInner" id="stageInner">
                <div class="personLayer" id="personLayer"></div>
                <!-- scene items injected here -->
              </div>
            </div>
          </div>

          <label>Scala generale capi</label>
          <input id="slGlobal" type="range" min="60" max="160" value="100">
          <span class="pill">Scala: <b id="vGlobal">100</b>%</span>

          <div class="divider"></div>

          <div class="row" style="justify-content:space-between">
            <div class="row">
              <span class="pill">Vista attuale: <b id="curView">FRONTE</b></span>
              <span class="pill">Capi in scena: <b id="sceneCount">0</b></span>
            </div>

            <div class="row">
              <button class="btn" id="btnBringFront">‚¨ÜÔ∏è Porta avanti</button>
              <button class="btn" id="btnSendBack">‚¨áÔ∏è Porta dietro</button>
              <button class="btn danger" id="btnDeleteSel">üóë Elimina</button>
            </div>
          </div>

          <div class="sub" style="margin-top:10px">
            Tip: tocca un capo per selezionarlo ‚Üí trascina per spostare ‚Üí usa le 4 maniglie per ridimensionare.
          </div>

        </div>
      </div>

      <div class="card">
        <h2><span>Comandi rapidi</span><span class="sub">try-on veloce</span></h2>
        <div class="body">
          <div class="row">
            <button class="btn primary" id="btnOpenAddGarment">üëó Aggiungi capo</button>
            <button class="btn" id="btnGoWardrobe">üß∫ Vai Guardaroba</button>
          </div>

          <div class="divider"></div>

          <div class="sub">
            ‚Ä¢ In <b>Guardaroba</b> premi <b>Metti addosso</b> ‚Üí auto-fit immediato.<br>
            ‚Ä¢ Se il capo ‚Äúsparisce‚Äù: premi <b>Porta avanti</b> o cambia scala generale.
          </div>

          <div class="divider"></div>

          <label>Modalit√† persona</label>
          <select id="personProfile">
            <option value="adult_m" selected>Uomo</option>
            <option value="adult_f">Donna</option>
            <option value="kid_m">Bambino</option>
            <option value="kid_f">Bambina</option>
          </select>
          <div class="sub" style="margin-top:8px">
            (Influenza auto-fit: posizione/scala predefinita dei capi)
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba (clicca ‚ÄúMetti addosso‚Äù)</span><span class="sub">upload + demo inclusa</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnAddGarment">‚ûï Aggiungi capo</button>
          <button class="btn" id="btnLoadDemo">üì¶ Carica demo</button>
          <button class="btn danger" id="btnClearWardrobe">üßπ Svuota guardaroba</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div class="divider"></div>

        <div class="row">
          <button class="btn" data-filter="all">Tutti</button>
          <button class="btn" data-filter="top">Sopra</button>
          <button class="btn" data-filter="bottom">Sotto</button>
          <button class="btn" data-filter="dress">Intero</button>
          <button class="btn" data-filter="acc">Accessori</button>
        </div>

        <div class="divider"></div>
        <div class="cards" id="wardrobe"></div>

        <div class="divider"></div>
        <div class="sub">
          Consiglio: usa screenshot Amazon ‚Üí apri ‚ÄúAggiungi capo‚Äù ‚Üí ritaglia solo il capo (meglio se fondo chiaro).
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida rapida</span><span class="sub">passo passo</span></h2>
      <div class="body">
        <div class="sub" style="font-size:13px;line-height:1.5">
          <b>1) Studio</b> ‚Üí premi <b>Carica persona (4 viste)</b> e carica almeno il <b>FRONTE</b>. Se hai anche DX/RETRO/SX la rotazione sar√† completa.<br><br>
          <b>2) Guardaroba</b> ‚Üí premi <b>Aggiungi capo</b> ‚Üí scegli immagine ‚Üí <b>ritaglia</b> col rettangolo (drag maniglie) ‚Üí opzionale: <b>Togli bianco</b> per ridurre bordi ‚Üí opzionale: incolla testo (nome brand) e premi <b>Applica testo</b> ‚Üí <b>Salva nel guardaroba</b>.<br><br>
          <b>3) Metti addosso</b> ‚Üí in Guardaroba premi <b>Metti addosso</b> sul capo ‚Üí torna allo Studio e regola se serve (trascina e maniglie).<br><br>
          <b>4) Rotazione</b> ‚Üí premi <b>Auto</b> per far scorrere le viste (FRONTE‚ÜíDX‚ÜíRETRO‚ÜíSX).<br><br>
          <b>Fullscreen</b> ‚Üí premi <b>Fullscreen</b> per vedere la persona vestita a schermo pieno.
        </div>
      </div>
    </div>
  </section>

</main>

<!-- MODAL: Persona 4 viste -->
<div class="modalOverlay" id="modalPerson">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Carica persona (4 viste)</div>
        <div class="sub">FRONTE obbligatorio ‚Ä¢ DX/RETRO/SX opzionali ‚Ä¢ Nessuno schiacciamento (fit naturale)</div>
      </div>
      <button class="x" id="closePerson">‚úï</button>
    </div>
    <div class="modalBody">
      <div class="grid">
        <div class="card">
          <h2><span>FRONTE</span><span class="sub">consigliato corpo intero</span></h2>
          <div class="body">
            <input type="file" accept="image/*" id="inFront">
          </div>
        </div>
        <div class="card">
          <h2><span>FIANCO DX</span><span class="sub">opzionale</span></h2>
          <div class="body">
            <input type="file" accept="image/*" id="inRight">
          </div>
        </div>
        <div class="card">
          <h2><span>RETRO</span><span class="sub">opzionale</span></h2>
          <div class="body">
            <input type="file" accept="image/*" id="inBack">
          </div>
        </div>
        <div class="card">
          <h2><span>FIANCO SX</span><span class="sub">opzionale</span></h2>
          <div class="body">
            <input type="file" accept="image/*" id="inLeft">
          </div>
        </div>
      </div>

      <div class="divider"></div>
      <div class="row" style="justify-content:space-between">
        <span class="pill">Suggerimento: luce buona ‚Ä¢ telefono dritto ‚Ä¢ distanza 2‚Äì3m</span>
        <button class="btn primary" id="btnSavePerson">Salva</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Add/Edit Garment + Crop PRO -->
<div class="modalOverlay" id="modalGarment">
  <div class="modal">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Aggiungi/Modifica capo</div>
        <div class="sub">Ritaglio PRO (maniglie) + togli bianco + testo su immagine (OCR manuale)</div>
      </div>
      <button class="x" id="closeGarment">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="row">
        <input type="file" accept="image/*" id="inGarmentFile">
        <button class="btn" id="btnFitCrop">üîé Adatta</button>
        <button class="btn" id="btnNewCrop">üß© Nuovo ritaglio</button>
        <button class="btn danger" id="btnResetCrop">‚Ü©Ô∏è Reset</button>
      </div>

      <div class="divider"></div>

      <div class="cropWrap">
        <div class="cropStage" id="cropStage">
          <div class="cropHint">Drag = sposta immagine ‚Ä¢ Maniglie = ridimensiona ritaglio ‚Ä¢ Pinch/Zoom = slider sotto</div>
          <canvas id="cropCanvas"></canvas>
        </div>
      </div>

      <label>Zoom immagine</label>
      <input id="slZoom" type="range" min="50" max="250" value="100">

      <label>Togli bianco (riduce bordi chiari)</label>
      <input id="slWhite" type="range" min="0" max="80" value="0">
      <span class="pill">Soglia: <b id="vWhite">0</b></span>

      <div class="divider"></div>

      <div class="grid">
        <div class="card">
          <h2><span>Dati capo</span><span class="sub">salvati nel guardaroba</span></h2>
          <div class="body">
            <label>Nome capo</label>
            <input id="gName" type="text" placeholder="es. Vestito Guess" />

            <label>Tipo capo</label>
            <select id="gType">
              <option value="top">Camicia / Maglia (TOP)</option>
              <option value="bottom">Pantalone / Gonna (BOTTOM)</option>
              <option value="dress">Abito intero (DRESS)</option>
              <option value="acc">Accessorio</option>
            </select>

            <label>Vista che stai caricando (solo etichetta)</label>
            <select id="gView">
              <option value="front" selected>FRONTE</option>
              <option value="right">FIANCO DX</option>
              <option value="back">RETRO</option>
              <option value="left">FIANCO SX</option>
            </select>

            <div class="divider"></div>
            <button class="btn primary" id="btnSaveGarment">Salva nel guardaroba</button>
          </div>
        </div>

        <div class="card">
          <h2><span>Testo su immagine (OCR manuale)</span><span class="sub">copia/incolla e applica</span></h2>
          <div class="body">
            <div class="row">
              <button class="btn" id="btnSelText">Seleziona</button>
              <button class="btn" id="btnCopyText">Copia</button>
              <button class="btn" id="btnPasteText">Incolla</button>
              <button class="btn primary" id="btnApplyText">Applica testo</button>
            </div>
            <label>Testo (incolla qui)</label>
            <textarea id="gText" placeholder="Incolla qui il testo (nome brand, prezzo, ecc.)"></textarea>

            <div class="sub" style="margin-top:8px">
              Questo NON √® OCR automatico: √® ‚ÄúOCR manuale‚Äù (tu incolli il testo). Se vuoi OCR vero si pu√≤ aggiungere tesseract.js (pesante).
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<div id="errBox"></div>

<script>
/* ============================
   SerCucTech Virtual Stylist 2D PRO
   Offline-friendly, single-file.
   No setPointerCapture (evita InvalidStateError su Android WebView).
================================ */

const statusEl = document.getElementById("status");
const errBox = document.getElementById("errBox");

function setStatusOk(){ statusEl.textContent = "OK"; }
function showErr(msg){
  errBox.style.display = "block";
  errBox.textContent = "ERRORE:\n" + msg;
  statusEl.textContent = "Errore";
  clearTimeout(showErr._t);
  showErr._t = setTimeout(()=>{ errBox.style.display="none"; }, 4200);
}
window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

/* Tabs */
const tabs = [...document.querySelectorAll(".tab")];
const sections = {
  studio: document.getElementById("studio"),
  guardaroba: document.getElementById("guardaroba"),
  guida: document.getElementById("guida"),
};
function setTab(name){
  tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
  Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
  localStorage.setItem("vs2d_tab", name);
}
tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
setTab(localStorage.getItem("vs2d_tab") || "studio");

/* State */
const KEY = "sercuctech_vs2d_pro_v1";
const state = JSON.parse(localStorage.getItem(KEY) || "{}");
state.person ??= { front:null, right:null, back:null, left:null };
state.curView ??= "front"; // front,right,back,left
state.scene ??= [];        // scene items: {id, garmentId, x,y,w,h,rot,z}
state.wardrobe ??= [];     // garments: {id, name, type, view, imgDataUrl, textOverlay?}
state.globalScale ??= 1.0;
state.personProfile ??= "adult_m";
state._selectedSceneId ??= null;

function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

/* DOM refs */
const stage = document.getElementById("stage");
const stageInner = document.getElementById("stageInner");
const personLayer = document.getElementById("personLayer");
const curViewEl = document.getElementById("curView");
const sceneCountEl = document.getElementById("sceneCount");

const slGlobal = document.getElementById("slGlobal");
const vGlobal = document.getElementById("vGlobal");
slGlobal.value = String(Math.round(state.globalScale*100));
vGlobal.textContent = String(Math.round(state.globalScale*100));

slGlobal.addEventListener("input", ()=>{
  const v = Number(slGlobal.value)/100;
  state.globalScale = v;
  vGlobal.textContent = String(Math.round(v*100));
  save();
});

/* Person profile */
const personProfile = document.getElementById("personProfile");
personProfile.value = state.personProfile || "adult_m";
personProfile.addEventListener("change", ()=>{
  state.personProfile = personProfile.value;
  save();
});

/* Person rendering */
function viewLabel(v){
  return v==="front"?"FRONTE":v==="right"?"FIANCO DX":v==="back"?"RETRO":"FIANCO SX";
}
function getPersonImg(){
  return state.person[state.curView] || state.person.front || null;
}
function renderPerson(){
  personLayer.innerHTML = "";
  const src = getPersonImg();
  curViewEl.textContent = viewLabel(state.curView);

  if(!src){
    const hint = document.createElement("div");
    hint.className = "sub";
    hint.style.padding = "18px";
    hint.style.textAlign = "center";
    hint.innerHTML = "<b>1)</b> Carica la foto persona (FRONTE) ‚Ä¢ <b>2)</b> Vai su Guardaroba ‚Ä¢ <b>3)</b> Metti addosso un capo";
    personLayer.appendChild(hint);
    return;
  }
  const img = document.createElement("img");
  img.src = src;
  img.alt = "Persona";
  personLayer.appendChild(img);
}

/* Rotation */
let autoTimer = null;
function nextView(){
  const order = ["front","right","back","left"];
  const i = order.indexOf(state.curView);
  state.curView = order[(i+1)%order.length];
  save();
  renderAll();
}
document.getElementById("btnRotateOnce").addEventListener("click", nextView);
document.getElementById("btnAuto").addEventListener("click", ()=>{
  if(autoTimer) return;
  autoTimer = setInterval(nextView, 1000);
});
document.getElementById("btnStop").addEventListener("click", ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer = null; }
});

/* Fullscreen */
document.getElementById("btnFullscreen").addEventListener("click", async ()=>{
  try{
    if(!document.fullscreenElement){
      await stage.requestFullscreen();
    }else{
      await document.exitFullscreen();
    }
  }catch(e){
    showErr("Fullscreen non disponibile su questo browser.");
  }
});

/* Scene tools */
document.getElementById("btnClearScene").addEventListener("click", ()=>{
  state.scene = [];
  state._selectedSceneId = null;
  save();
  renderStage();
});

document.getElementById("btnBringFront").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return showErr("Seleziona un capo.");
  const it = state.scene.find(x=>x.id===id);
  if(!it) return;
  it.z = Math.max(0, ...state.scene.map(s=>s.z||0)) + 1;
  save(); renderStage();
});

document.getElementById("btnSendBack").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return showErr("Seleziona un capo.");
  const it = state.scene.find(x=>x.id===id);
  if(!it) return;
  it.z = Math.min(0, ...state.scene.map(s=>s.z||0)) - 1;
  save(); renderStage();
});

document.getElementById("btnDeleteSel").addEventListener("click", ()=>{
  const id = state._selectedSceneId;
  if(!id) return showErr("Seleziona un capo.");
  state.scene = state.scene.filter(s=>s.id!==id);
  state._selectedSceneId = null;
  save(); renderStage();
});

/* Wardrobe */
const wardrobeEl = document.getElementById("wardrobe");
const wardCountEl = document.getElementById("wardCount");
let wardFilter = "all";

function garmentTypeLabel(t){
  return t==="top"?"Sopra":t==="bottom"?"Sotto":t==="dress"?"Intero":"Accessori";
}

function renderWardrobe(){
  wardrobeEl.innerHTML = "";
  wardCountEl.textContent = String(state.wardrobe.length);

  const list = state.wardrobe.filter(g=> wardFilter==="all" ? true : g.type===wardFilter);

  if(list.length===0){
    const empty = document.createElement("div");
    empty.className = "sub";
    empty.style.padding = "10px";
    empty.textContent = "Guardaroba vuoto (o filtro vuoto). Premi ‚ÄúAggiungi capo‚Äù oppure ‚ÄúCarica demo‚Äù.";
    wardrobeEl.appendChild(empty);
    return;
  }

  list.forEach(g=>{
    const card = document.createElement("div");
    card.className = "item";

    const th = document.createElement("div");
    th.className = "thumb";
    const im = document.createElement("img");
    im.src = g.imgDataUrl;
    im.alt = g.name || "Capo";
    th.appendChild(im);

    const meta = document.createElement("div");
    meta.className = "meta";

    const t = document.createElement("div");
    t.className = "t";
    t.textContent = g.name || "Capo";

    const s = document.createElement("div");
    s.className = "s";
    s.textContent = `${garmentTypeLabel(g.type)} ‚Ä¢ vista: ${viewLabel(g.view||"front")}`;

    const p = document.createElement("div");
    p.className = "p";

    const wear = document.createElement("button");
    wear.className = "btn primary";
    wear.textContent = "Metti addosso";
    wear.addEventListener("click", ()=>{
      addToSceneAutoFit(g.id);
      setTab("studio");
    });

    const del = document.createElement("button");
    del.className = "btn danger";
    del.textContent = "Elimina";
    del.addEventListener("click", ()=>{
      state.wardrobe = state.wardrobe.filter(x=>x.id!==g.id);
      save();
      renderWardrobe();
    });

    p.appendChild(wear);
    p.appendChild(del);

    meta.appendChild(t);
    meta.appendChild(s);
    meta.appendChild(p);

    card.appendChild(th);
    card.appendChild(meta);
    wardrobeEl.appendChild(card);
  });
}

/* Filters */
document.querySelectorAll("[data-filter]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    wardFilter = btn.dataset.filter;
    renderWardrobe();
  });
});

/* Demo garments: usa SVG data-url (no link rotti) */
function svgDataUrl(svg){
  return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
}
function loadDemo(){
  const demo = [
    { name:"T-shirt basic (Uomo)", type:"top", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><path d="M140 150 L200 110 L256 140 L312 110 L372 150 L340 210 L340 410 L172 410 L172 210 Z" fill="#1c2233" opacity="0.92"/></svg>`) },
    { name:"Jeans (Uomo)", type:"bottom", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><path d="M200 130 L312 130 L330 410 L286 410 L270 260 L242 260 L226 410 L182 410 Z" fill="#141a2b" opacity="0.93"/></svg>`) },
    { name:"Vestito (Donna)", type:"dress", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><path d="M230 90 L282 90 L300 160 L360 210 L320 430 L192 430 L152 210 L212 160 Z" fill="#2b2320" opacity="0.90"/></svg>`) },
    { name:"Gonna (Bambina)", type:"bottom", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><path d="M190 180 L322 180 L350 360 L162 360 Z" fill="#3a2450" opacity="0.90"/></svg>`) },
    { name:"Felpa (Bambino)", type:"top", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><path d="M170 160 L220 120 L256 140 L292 120 L342 160 L320 220 L320 420 L192 420 L192 220 Z" fill="#2a2a3a" opacity="0.92"/></svg>`) },
    { name:"Cappello", type:"acc", view:"front", imgDataUrl: svgDataUrl(`<svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"><rect width="100%" height="100%" fill="transparent"/><ellipse cx="256" cy="250" rx="150" ry="40" fill="#111118" opacity="0.92"/><path d="M170 240 Q256 140 342 240 Q256 260 170 240 Z" fill="#111118" opacity="0.92"/></svg>`) },
  ];

  // prepend newest first
  demo.reverse().forEach(d=>{
    state.wardrobe.unshift({
      id:"g_"+Math.random().toString(16).slice(2),
      name:d.name, type:d.type, view:d.view,
      imgDataUrl:d.imgDataUrl,
      textOverlay:null
    });
  });
  save();
  renderWardrobe();
}
document.getElementById("btnLoadDemo").addEventListener("click", loadDemo);

document.getElementById("btnClearWardrobe").addEventListener("click", ()=>{
  state.wardrobe = [];
  save(); renderWardrobe();
});

/* Open buttons */
document.getElementById("btnGoWardrobe").addEventListener("click", ()=> setTab("guardaroba"));
document.getElementById("btnOpenAddGarment").addEventListener("click", ()=> openGarmentModal());
document.getElementById("btnAddGarment").addEventListener("click", ()=> openGarmentModal());
document.getElementById("btnAddGarment").addEventListener("click", ()=> setTab("guardaroba"));

/* ============================
   SCENE RENDER + DRAG/RESIZE
================================ */
function renderStage(){
  // remove old scene items
  [...stageInner.querySelectorAll(".sceneItem")].forEach(n=>n.remove());

  // count
  sceneCountEl.textContent = String(state.scene.length);

  // sort by z
  const items = [...state.scene].sort((a,b)=>(a.z||0)-(b.z||0));
  items.forEach(it=>{
    const g = state.wardrobe.find(x=>x.id===it.garmentId);
    if(!g) return;

    const el = document.createElement("div");
    el.className = "sceneItem" + (state._selectedSceneId===it.id ? " selected":"");
    el.style.left = it.x+"px";
    el.style.top  = it.y+"px";
    el.style.width  = it.w+"px";
    el.style.height = it.h+"px";
    el.style.zIndex = String(it.z||0);
    el.style.transform = `rotate(${it.rot||0}deg)`;

    const img = document.createElement("img");
    img.src = g.imgDataUrl;
    img.alt = g.name || "capo";
    el.appendChild(img);

    // selection
    el.addEventListener("pointerdown", (e)=>{
      e.preventDefault();
      selectScene(it.id);
      startDragMove(e, it.id);
    });

    // handles
    const hNW = mkHandle("h-nw", it.id, "nw");
    const hNE = mkHandle("h-ne", it.id, "ne");
    const hSW = mkHandle("h-sw", it.id, "sw");
    const hSE = mkHandle("h-se", it.id, "se");
    el.appendChild(hNW); el.appendChild(hNE); el.appendChild(hSW); el.appendChild(hSE);

    stageInner.appendChild(el);
  });
}

function selectScene(id){
  state._selectedSceneId = id;
  save();
  renderStage();
}

function mkHandle(cls, sceneId, corner){
  const h = document.createElement("div");
  h.className = "handle " + cls;
  h.addEventListener("pointerdown", (e)=>{
    e.preventDefault();
    selectScene(sceneId);
    startDragResize(e, sceneId, corner);
  });
  return h;
}

/* No setPointerCapture => stable on Android */
function startDragMove(ev, sceneId){
  const it = state.scene.find(x=>x.id===sceneId);
  if(!it) return;

  const startX = ev.clientX, startY = ev.clientY;
  const ox = it.x, oy = it.y;

  const onMove = (e)=>{
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    it.x = Math.round(ox + dx);
    it.y = Math.round(oy + dy);
    save();
    renderStage();
  };
  const onUp = ()=>{
    window.removeEventListener("pointermove", onMove);
    window.removeEventListener("pointerup", onUp);
  };
  window.addEventListener("pointermove", onMove, {passive:false});
  window.addEventListener("pointerup", onUp, {passive:true});
}

function startDragResize(ev, sceneId, corner){
  const it = state.scene.find(x=>x.id===sceneId);
  if(!it) return;

  const startX = ev.clientX, startY = ev.clientY;
  const ox=it.x, oy=it.y, ow=it.w, oh=it.h;

  const onMove = (e)=>{
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    let nx=ox, ny=oy, nw=ow, nh=oh;
    if(corner==="se"){ nw = ow + dx; nh = oh + dy; }
    if(corner==="sw"){ nx = ox + dx; nw = ow - dx; nh = oh + dy; }
    if(corner==="ne"){ ny = oy + dy; nw = ow + dx; nh = oh - dy; }
    if(corner==="nw"){ nx = ox + dx; ny = oy + dy; nw = ow - dx; nh = oh - dy; }

    nw = Math.max(60, Math.round(nw));
    nh = Math.max(60, Math.round(nh));

    it.x = Math.round(nx);
    it.y = Math.round(ny);
    it.w = nw;
    it.h = nh;

    save();
    renderStage();
  };
  const onUp = ()=>{
    window.removeEventListener("pointermove", onMove);
    window.removeEventListener("pointerup", onUp);
  };
  window.addEventListener("pointermove", onMove, {passive:false});
  window.addEventListener("pointerup", onUp, {passive:true});
}

/* Auto-fit placement */
function fitPreset(profile, type){
  // returns {boxW, boxH, yPosFactor}
  // profile influences size
  const base = profile.startsWith("kid") ? 0.80 : 1.00;
  if(type==="top")   return { w:0.56*base, h:0.38*base, y:0.30 };
  if(type==="bottom")return { w:0.56*base, h:0.45*base, y:0.60 };
  if(type==="dress") return { w:0.62*base, h:0.70*base, y:0.48 };
  return              { w:0.36*base, h:0.22*base, y:0.78 };
}

function addToSceneAutoFit(garmentId){
  const g = state.wardrobe.find(x=>x.id===garmentId);
  if(!g) return showErr("Capo non trovato.");

  const r = stageInner.getBoundingClientRect();
  const W = Math.round(r.width);
  const H = Math.round(r.height);

  const p = fitPreset(state.personProfile || "adult_m", g.type);
  const scale = state.globalScale || 1;

  let boxW = Math.max(60, Math.round(W * p.w * scale));
  let boxH = Math.max(60, Math.round(H * p.h * scale));

  // center
  let x = Math.round((W - boxW)/2);
  let y = Math.round((H * p.y) - (boxH/2));

  // clamp inside
  x = Math.max(0, Math.min(x, W - boxW));
  y = Math.max(0, Math.min(y, H - boxH));

  const maxZ = Math.max(0, ...(state.scene.map(s=>s.z||0)));
  const id = "s_"+Math.random().toString(16).slice(2);

  state.scene.push({
    id, garmentId,
    x,y,w:boxW,h:boxH,
    rot:0,
    z:maxZ+1
  });

  state._selectedSceneId = id;
  save();
  renderStage();
  setStatusOk();
}

/* ============================
   PERSON MODAL
================================ */
const modalPerson = document.getElementById("modalPerson");
const closePerson = document.getElementById("closePerson");
document.getElementById("btnUploadPerson").addEventListener("click", ()=> openPersonModal());
closePerson.addEventListener("click", ()=> modalPerson.style.display="none");
modalPerson.addEventListener("click", (e)=>{ if(e.target===modalPerson) modalPerson.style.display="none"; });

function openPersonModal(){ modalPerson.style.display="flex"; }

function fileToDataUrl(file){
  return new Promise((res, rej)=>{
    const fr = new FileReader();
    fr.onload = ()=> res(fr.result);
    fr.onerror = ()=> rej(fr.error);
    fr.readAsDataURL(file);
  });
}

const inFront = document.getElementById("inFront");
const inRight = document.getElementById("inRight");
const inBack  = document.getElementById("inBack");
const inLeft  = document.getElementById("inLeft");

document.getElementById("btnSavePerson").addEventListener("click", async ()=>{
  try{
    if(inFront.files[0]) state.person.front = await fileToDataUrl(inFront.files[0]);
    if(inRight.files[0]) state.person.right = await fileToDataUrl(inRight.files[0]);
    if(inBack.files[0])  state.person.back  = await fileToDataUrl(inBack.files[0]);
    if(inLeft.files[0])  state.person.left  = await fileToDataUrl(inLeft.files[0]);

    if(!state.person.front){
      showErr("Carica almeno la vista FRONTE.");
      return;
    }
    save();
    modalPerson.style.display="none";
    renderAll();
    setStatusOk();
  }catch(e){
    showErr("Errore caricamento persona.");
  }
});

/* ============================
   GARMENT MODAL + CROP PRO
================================ */
const modalGarment = document.getElementById("modalGarment");
const closeGarment = document.getElementById("closeGarment");
closeGarment.addEventListener("click", ()=> modalGarment.style.display="none");
modalGarment.addEventListener("click", (e)=>{ if(e.target===modalGarment) modalGarment.style.display="none"; });

function openGarmentModal(){
  modalGarment.style.display="flex";
  resetCropAll(true);
}

const inGarmentFile = document.getElementById("inGarmentFile");
const cropCanvas = document.getElementById("cropCanvas");
const cropStage = document.getElementById("cropStage");
const ctx = cropCanvas.getContext("2d", { willReadFrequently:true });

const slZoom = document.getElementById("slZoom");
const slWhite = document.getElementById("slWhite");
const vWhite = document.getElementById("vWhite");

const gName = document.getElementById("gName");
const gType = document.getElementById("gType");
const gView = document.getElementById("gView");
const gText = document.getElementById("gText");

/* crop engine state */
let srcImg = null;
let imgX=0, imgY=0, imgScale=1;
let crop = { x:80, y:80, w:260, h:360 };
let dragMode = null; // "img" or handle corner
let down = {x:0,y:0, ix:0,iy:0, cx:0,cy:0,cw:0,ch:0};

function resizeCropCanvas(){
  const r = cropStage.getBoundingClientRect();
  cropCanvas.width = Math.max(320, Math.round(r.width));
  cropCanvas.height = Math.max(420, Math.round(r.height));
  drawCrop();
}

window.addEventListener("resize", ()=>{
  if(modalGarment.style.display==="flex"){
    resizeCropCanvas();
  }
});

function resetCropAll(keepMeta=false){
  srcImg = null;
  imgX=0; imgY=0; imgScale=1;
  crop = { x:80, y:80, w:260, h:360 };
  slZoom.value = "100";
  slWhite.value = "0";
  vWhite.textContent = "0";
  if(!keepMeta){
    gName.value = "";
    gType.value = "top";
    gView.value = "front";
    gText.value = "";
  }
  resizeCropCanvas();
}

function fitImageToCanvas(){
  if(!srcImg) return;
  const cw = cropCanvas.width, ch = cropCanvas.height;
  const sx = cw / srcImg.width;
  const sy = ch / srcImg.height;
  imgScale = Math.min(sx, sy) * 0.95;
  imgX = (cw - srcImg.width*imgScale)/2;
  imgY = (ch - srcImg.height*imgScale)/2;

  // default crop centered
  const boxW = Math.round(cw*0.55);
  const boxH = Math.round(ch*0.72);
  crop.w = boxW; crop.h = boxH;
  crop.x = Math.round((cw-boxW)/2);
  crop.y = Math.round((ch-boxH)/2);
  drawCrop();
}

function drawCrop(){
  // background
  ctx.clearRect(0,0,cropCanvas.width,cropCanvas.height);
  ctx.fillStyle = "#07070f";
  ctx.fillRect(0,0,cropCanvas.width,cropCanvas.height);

  // draw image
  if(srcImg){
    ctx.save();
    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(srcImg, imgX, imgY, srcImg.width*imgScale, srcImg.height*imgScale);
    ctx.restore();
  }else{
    ctx.fillStyle = "rgba(255,255,255,.12)";
    ctx.font = "700 16px system-ui";
    ctx.textAlign = "center";
    ctx.fillText("Scegli un'immagine per iniziare", cropCanvas.width/2, cropCanvas.height/2);
  }

  // dim outside crop
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,.45)";
  ctx.fillRect(0,0,cropCanvas.width,cropCanvas.height);
  ctx.clearRect(crop.x, crop.y, crop.w, crop.h);
  ctx.restore();

  // crop border
  ctx.save();
  ctx.strokeStyle = "rgba(255,213,106,.9)";
  ctx.lineWidth = 2;
  ctx.setLineDash([6,4]);
  ctx.strokeRect(crop.x+1, crop.y+1, crop.w-2, crop.h-2);
  ctx.setLineDash([]);
  ctx.restore();

  // handles (4 corners) - always visible
  drawHandle(crop.x, crop.y);
  drawHandle(crop.x+crop.w, crop.y);
  drawHandle(crop.x, crop.y+crop.h);
  drawHandle(crop.x+crop.w, crop.y+crop.h);
}
function drawHandle(x,y){
  ctx.save();
  ctx.fillStyle = "#69d7ff";
  ctx.strokeStyle = "rgba(0,0,0,.35)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(x, y, 10, 0, Math.PI*2);
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

function hitHandle(px,py){
  const pts = [
    {k:"nw", x:crop.x, y:crop.y},
    {k:"ne", x:crop.x+crop.w, y:crop.y},
    {k:"sw", x:crop.x, y:crop.y+crop.h},
    {k:"se", x:crop.x+crop.w, y:crop.y+crop.h},
  ];
  for(const p of pts){
    const d = Math.hypot(px-p.x, py-p.y);
    if(d <= 16) return p.k;
  }
  // inside crop => move crop? (qui: muovi immagine)
  return null;
}

function clampCrop(){
  crop.w = Math.max(80, crop.w);
  crop.h = Math.max(80, crop.h);

  // keep within canvas
  crop.x = Math.max(0, Math.min(crop.x, cropCanvas.width - crop.w));
  crop.y = Math.max(0, Math.min(crop.y, cropCanvas.height - crop.h));
}

/* pointer events without setPointerCapture */
cropCanvas.addEventListener("pointerdown", (e)=>{
  e.preventDefault();
  const rect = cropCanvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const h = hitHandle(x,y);
  dragMode = h ? ("handle_"+h) : "img";

  down.x = x; down.y = y;
  down.ix = imgX; down.iy = imgY;
  down.cx = crop.x; down.cy = crop.y; down.cw = crop.w; down.ch = crop.h;

  const onMove = (ev)=>{
    ev.preventDefault();
    const xx = ev.clientX - rect.left;
    const yy = ev.clientY - rect.top;
    const dx = xx - down.x;
    const dy = yy - down.y;

    if(dragMode==="img"){
      imgX = down.ix + dx;
      imgY = down.iy + dy;
    }else if(dragMode.startsWith("handle_")){
      const k = dragMode.slice(7);
      if(k==="se"){ crop.w = down.cw + dx; crop.h = down.ch + dy; }
      if(k==="sw"){ crop.x = down.cx + dx; crop.w = down.cw - dx; crop.h = down.ch + dy; }
      if(k==="ne"){ crop.y = down.cy + dy; crop.w = down.cw + dx; crop.h = down.ch - dy; }
      if(k==="nw"){ crop.x = down.cx + dx; crop.y = down.cy + dy; crop.w = down.cw - dx; crop.h = down.ch - dy; }
      clampCrop();
    }
    drawCrop();
  };
  const onUp = ()=>{
    window.removeEventListener("pointermove", onMove);
    window.removeEventListener("pointerup", onUp);
  };
  window.addEventListener("pointermove", onMove, {passive:false});
  window.addEventListener("pointerup", onUp, {passive:true});
});

slZoom.addEventListener("input", ()=>{
  const z = Number(slZoom.value)/100;
  if(!srcImg) return;
  const rect = cropCanvas.getBoundingClientRect();
  const cx = cropCanvas.width/2;
  const cy = cropCanvas.height/2;

  // zoom around center
  const prev = imgScale;
  imgScale = (fitBaseScale || 1) * z;
  const k = imgScale/prev;
  imgX = cx - (cx - imgX)*k;
  imgY = cy - (cy - imgY)*k;
  drawCrop();
});

slWhite.addEventListener("input", ()=>{
  vWhite.textContent = slWhite.value;
});

/* Keep a base scale from fit */
let fitBaseScale = 1;

inGarmentFile.addEventListener("change", async ()=>{
  try{
    const f = inGarmentFile.files[0];
    if(!f) return;
    const url = await fileToDataUrl(f);
    srcImg = new Image();
    srcImg.onload = ()=>{
      resizeCropCanvas();
      // fit
      const cw = cropCanvas.width, ch = cropCanvas.height;
      const sx = cw / srcImg.width;
      const sy = ch / srcImg.height;
      fitBaseScale = Math.min(sx, sy) * 0.95;
      imgScale = fitBaseScale * (Number(slZoom.value)/100);
      imgX = (cw - srcImg.width*imgScale)/2;
      imgY = (ch - srcImg.height*imgScale)/2;
      fitImageToCanvas();
    };
    srcImg.src = url;
  }catch(e){
    showErr("Errore caricamento immagine capo.");
  }
});

document.getElementById("btnFitCrop").addEventListener("click", ()=>{
  if(!srcImg) return;
  fitImageToCanvas();
});

document.getElementById("btnNewCrop").addEventListener("click", ()=>{
  const cw = cropCanvas.width, ch = cropCanvas.height;
  crop = { x: Math.round(cw*0.22), y: Math.round(ch*0.14), w: Math.round(cw*0.56), h: Math.round(ch*0.72) };
  drawCrop();
});

document.getElementById("btnResetCrop").addEventListener("click", ()=>{
  resetCropAll(true);
});

/* Manual OCR controls */
document.getElementById("btnSelText").addEventListener("click", ()=>{
  gText.focus(); gText.select();
});
document.getElementById("btnCopyText").addEventListener("click", async ()=>{
  try{ await navigator.clipboard.writeText(gText.value||""); }catch{}
});
document.getElementById("btnPasteText").addEventListener("click", async ()=>{
  try{
    const t = await navigator.clipboard.readText();
    if(t) gText.value = t;
  }catch{
    // fallback: focus so user can paste
    gText.focus();
    showErr("Incolla manualmente (tasto Incolla del telefono).");
  }
});

/* Apply text overlay into the crop output (will bake into garment) */
let pendingTextOverlay = null;
document.getElementById("btnApplyText").addEventListener("click", ()=>{
  const t = (gText.value||"").trim();
  if(!t) return showErr("Inserisci/incolla un testo prima.");
  pendingTextOverlay = t;
  setStatusOk();
});

/* Export crop to PNG dataURL (+ remove white edges threshold) */
function exportCroppedPNG(){
  if(!srcImg) throw new Error("No image");

  // create offscreen canvas the size of crop rect (final)
  const out = document.createElement("canvas");
  out.width = Math.max(10, Math.round(crop.w));
  out.height = Math.max(10, Math.round(crop.h));
  const o = out.getContext("2d", { willReadFrequently:true });

  // draw from visible canvas: easiest is to re-render full image transform into out
  // Convert crop area in canvas coords back into original image sampling:
  // We'll just draw from srcImg using current transform:
  // Step 1: draw same as cropCanvas then clip; Step 2: copy crop region to out.

  // Draw full image onto a temp canvas (same size as cropCanvas)
  const tmp = document.createElement("canvas");
  tmp.width = cropCanvas.width;
  tmp.height = cropCanvas.height;
  const tctx = tmp.getContext("2d", { willReadFrequently:true });
  tctx.drawImage(srcImg, imgX, imgY, srcImg.width*imgScale, srcImg.height*imgScale);

  // copy crop region
  const imgData = tctx.getImageData(crop.x, crop.y, crop.w, crop.h);

  // remove near-white background (simple threshold)
  const thr = Number(slWhite.value) || 0; // 0..80
  if(thr>0){
    const d = imgData.data;
    for(let i=0;i<d.length;i+=4){
      const r=d[i], g=d[i+1], b=d[i+2], a=d[i+3];
      if(a===0) continue;
      // distance to white
      const dist = (255-r) + (255-g) + (255-b);
      if(dist < thr*6){ // sensitivity
        d[i+3] = 0; // make transparent
      }
    }
  }

  // put to output
  o.putImageData(imgData, 0, 0);

  // bake text overlay if requested
  if(pendingTextOverlay){
    o.save();
    o.fillStyle = "rgba(0,0,0,.55)";
    o.strokeStyle = "rgba(255,255,255,.85)";
    o.lineWidth = 3;
    o.font = "900 26px system-ui";
    o.textAlign = "center";
    o.textBaseline = "middle";

    // wrap lines
    const maxW = out.width*0.92;
    const words = pendingTextOverlay.split(/\s+/);
    const lines = [];
    let line = "";
    for(const w of words){
      const test = (line? line+" ":"")+w;
      if(o.measureText(test).width <= maxW) line = test;
      else { if(line) lines.push(line); line = w; }
    }
    if(line) lines.push(line);

    // draw block bottom
    const blockH = Math.max(44, lines.length*32 + 16);
    const y0 = out.height - blockH/2 - 10;
    o.fillRect(out.width*0.04, out.height - blockH - 10, out.width*0.92, blockH);

    let y = out.height - blockH + 18;
    for(const ln of lines){
      o.strokeText(ln, out.width/2, y);
      o.fillStyle = "rgba(255,213,106,.98)";
      o.fillText(ln, out.width/2, y);
      o.fillStyle = "rgba(0,0,0,.55)";
      y += 32;
    }
    o.restore();

    // consume
    pendingTextOverlay = null;
  }

  return out.toDataURL("image/png");
}

document.getElementById("btnSaveGarment").addEventListener("click", ()=>{
  try{
    if(!srcImg) return showErr("Prima scegli un'immagine capo.");

    const dataUrl = exportCroppedPNG();
    const name = (gName.value||"").trim() || "Capo";
    const type = gType.value;
    const view = gView.value;

    state.wardrobe.unshift({
      id:"g_"+Math.random().toString(16).slice(2),
      name, type, view,
      imgDataUrl: dataUrl,
      textOverlay: null
    });

    save();
    renderWardrobe();
    modalGarment.style.display = "none";
    setStatusOk();
  }catch(e){
    showErr("Salvataggio capo fallito.");
  }
});

/* ============================
   APP INIT
================================ */
function renderAll(){
  renderPerson();
  renderStage();
  renderWardrobe();
  setStatusOk();
}

renderAll();

/* Quick nav */
document.getElementById("btnGoWardrobe").addEventListener("click", ()=> setTab("guardaroba"));

/* PWA Service Worker (opzionale) */
if ("serviceWorker" in navigator) {
  window.addEventListener("load", () => {
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
