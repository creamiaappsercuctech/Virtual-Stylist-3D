<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</title>
  <meta name="theme-color" content="#0b0b12" />
  <link rel="manifest" href="./manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.03); --card2:rgba(255,255,255,.02);
      --acc:#66d7ff;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{ background:rgba(255,213,106,.12); border-color:rgba(255,213,106,.25); }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }
    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
      gap:10px;
    }
    .card .body{ padding:12px 14px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="text"], select{
      width:100%; padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }
    input[type="file"]{ width:100%; }
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(102,215,255,.14);
      border-color:rgba(102,215,255,.30);
    }
    .btn.good{
      background:rgba(110,255,168,.12);
      border-color:rgba(110,255,168,.25);
    }
    .btn.bad{
      background:rgba(255,110,110,.10);
      border-color:rgba(255,110,110,.25);
    }
    .btn.small{ padding:8px 10px; border-radius:12px; font-size:12px; }

    .section{ display:none; }
    .section.active{ display:block; }

    /* STAGE */
    .stage{
      position:relative;
      border:1px solid rgba(255,255,255,.08);
      background:#070710;
      border-radius:18px;
      overflow:hidden;
      height:560px;
      touch-action:none;
    }
    @media(max-width:980px){ .stage{ height:520px; } }
    .personWrap{ position:absolute; inset:0; display:grid; place-items:center; }
    .personImg{
      width:100%; height:100%;
      object-fit:contain; /* non schiaccia */
      transform-origin:center center;
    }
    .overlay{ position:absolute; left:0; top:0; width:100%; height:100%; pointer-events:none; }
    .garmentLayer{
      position:absolute;
      transform-origin:center center;
      pointer-events:auto;
      touch-action:none;
      user-select:none;
      -webkit-user-drag:none;
      filter: drop-shadow(0 10px 18px rgba(0,0,0,.35));
    }
    .hintBubble{
      position:absolute; left:10px; top:10px; right:10px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      backdrop-filter: blur(10px);
    }

    /* Wardrobe list */
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      padding:12px;
      display:flex; gap:12px;
    }
    .thumb{
      width:84px; height:84px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      overflow:hidden;
      display:grid; place-items:center;
      color:var(--muted);
      font-size:12px;
      flex:0 0 auto;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }
    .meta .p{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    /* Modal */
    .modal{
      position:fixed; inset:0; z-index:9998;
      background:rgba(0,0,0,.62);
      display:none;
      align-items:flex-start;
      justify-content:center;
      padding:14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modal.open{ display:flex; }
    .modalCard{
      width:min(820px, 100%);
      border:1px solid rgba(255,255,255,.12);
      background:rgba(11,11,18,.96);
      border-radius:18px;
      overflow:hidden;
      max-height:92vh;
      display:flex;
      flex-direction:column;
    }
    .modalHead{
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .modalBody{
      padding:12px 14px;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    .modalFoot{
      padding:12px 14px;
      border-top:1px solid rgba(255,255,255,.08);
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }

    /* ===== CROP EDITOR (come seconda foto) ===== */
    .cropShell{
      position:relative;
      border:1px solid rgba(255,255,255,.10);
      background:#070710;
      border-radius:16px;
      overflow:hidden;
      height:560px;
      touch-action:none;
    }
    @media(max-width:820px){ .cropShell{ height:540px; } }

    .cropCanvas{ width:100%; height:100%; display:block; }

    .cropOverlay{
      position:absolute; inset:0;
      pointer-events:none;
    }
    .cropRect{
      position:absolute;
      border:2px solid rgba(102,215,255,.9);
      box-shadow: 0 0 0 9999px rgba(0,0,0,.45);
      border-radius:10px;
      pointer-events:auto;
      touch-action:none;
    }
    .handle{
      position:absolute;
      width:26px; height:26px;
      border-radius:50%;
      background:rgba(102,215,255,.95);
      border:2px solid rgba(255,255,255,.35);
      box-shadow:0 8px 16px rgba(0,0,0,.25);
      pointer-events:auto;
      touch-action:none;
    }
    .h-nw{ left:-13px; top:-13px; cursor:nwse-resize; }
    .h-ne{ right:-13px; top:-13px; cursor:nesw-resize; }
    .h-sw{ left:-13px; bottom:-13px; cursor:nesw-resize; }
    .h-se{ right:-13px; bottom:-13px; cursor:nwse-resize; }

    .cropHint{
      position:absolute; left:10px; top:10px; right:10px;
      background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px 12px;
      font-size:12px;
      backdrop-filter: blur(10px);
      pointer-events:none;
    }

    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:9999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.10);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D PRO</div>
          <div class="sub">Upload persona ‚Üí carica capi ‚Üí ritaglio con maniglie ‚Üí metti addosso</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">Avvio‚Ä¶</b></span>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">
  <section id="studio" class="section active">
    <div class="grid">
      <div class="card">
        <h2><span>Persona + Outfit</span><span class="sub">drag = sposta ultimo capo</span></h2>
        <div class="body">
          <div class="row" style="justify-content:space-between">
            <span class="pill">Vista: <b id="viewLabel">FRONTE</b></span>
            <div class="row">
              <button class="btn small" id="btnPrevView">‚óÄ</button>
              <button class="btn small" id="btnNextView">‚ñ∂</button>
              <button class="btn small primary" id="btnRotateOnce">Rotazione</button>
              <button class="btn small" id="btnAutoRotate">Auto: OFF</button>
              <button class="btn small" id="btnFullscreen">IN/OUT Schermo</button>
            </div>
          </div>

          <div class="stage" id="stage">
            <div class="personWrap"><img id="personImg" class="personImg" alt="Persona"/></div>
            <div class="overlay" id="overlay"></div>
            <div class="hintBubble" id="hint">
              1) Carica foto persona ‚Ä¢ 2) Vai su Guardaroba ‚Ä¢ 3) Carica capo e premi ‚ÄúMetti addosso‚Äù
            </div>
          </div>

          <div style="height:10px"></div>
          <label>Carica foto persona</label>
          <input type="file" id="personFile" accept="image/*" />
          <div class="sub">Suggerimento: corpo intero, luce buona, telefono dritto.</div>
        </div>
      </div>

      <div class="card">
        <h2><span>Info</span><span class="sub">Try-on 2D</span></h2>
        <div class="body">
          <div class="sub">
            Questa versione fa sovrapposizione 2D. Per ‚Äúrimuovere‚Äù i vestiti originali serve AI (segmentazione).
          </div>
          <div style="height:10px"></div>
          <button class="btn" id="btnClearOutfit">Togli tutti i capi</button>
        </div>
      </div>
    </div>
  </section>

  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba</span><span class="sub">click ‚ÄúMetti addosso‚Äù ‚Üí va in Studio</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnAddGarment">+ Aggiungi capo (upload)</button>
          <button class="btn" id="btnClearWard">Svuota guardaroba</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:12px"></div>
        <div class="cards" id="wardrobe"></div>
      </div>
    </div>
  </section>

  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida</span><span class="sub">passo passo</span></h2>
      <div class="body">
        <ol style="margin:0;padding-left:18px">
          <li><b>Studio</b> ‚Üí carica persona</li>
          <li><b>Guardaroba</b> ‚Üí ‚ÄúAggiungi capo‚Äù</li>
          <li><b>Ritaglia</b> con maniglie (come seconda foto) ‚Üí ‚ÄúSalva nel guardaroba‚Äù</li>
          <li>Clicca <b>Metti addosso</b></li>
        </ol>
      </div>
    </div>
  </section>
</main>

<!-- MODAL CROP -->
<div class="modal" id="cropModal" aria-hidden="true">
  <div class="modalCard">
    <div class="modalHead">
      <div>
        <div style="font-weight:900">Seleziona tu la parte</div>
        <div class="sub">Carica screenshot/immagine ‚Üí scegli la zona col riquadro ‚Üí salva solo quella zona (pulita).</div>
      </div>
      <button class="btn small" id="btnCloseCrop">‚úï</button>
    </div>

    <div class="modalBody">
      <div class="row">
        <button class="btn primary" id="btnPick">üì∏ Scegli immagine</button>
        <button class="btn" id="btnFit">üîé Adatta</button>
        <button class="btn good" id="btnNewCrop">üß© Nuovo ritaglio</button>
        <button class="btn bad" id="btnReset">‚Ü© Reset</button>
        <input type="file" id="garFile" accept="image/*" style="display:none"/>
      </div>

      <div style="height:10px"></div>

      <div class="cropShell" id="cropShell">
        <canvas id="cropCanvas" class="cropCanvas"></canvas>

        <div class="cropOverlay">
          <div class="cropHint">Drag = sposta immagine ‚Ä¢ Maniglie = ridimensiona ritaglio</div>

          <div class="cropRect" id="cropRect">
            <div class="handle h-nw" data-h="nw"></div>
            <div class="handle h-ne" data-h="ne"></div>
            <div class="handle h-sw" data-h="sw"></div>
            <div class="handle h-se" data-h="se"></div>
          </div>
        </div>
      </div>

      <label>Dati capo</label>
      <div class="row" style="gap:8px">
        <input id="garName" type="text" placeholder="Nome capo (es. Vestito casual)" style="flex:1 1 auto; min-width:180px" />
        <button class="btn small" id="btnSelName">Seleziona</button>
        <button class="btn small" id="btnCopyName">Copia</button>
        <button class="btn small" id="btnPasteName">Incolla</button>
        <button class="btn small primary" id="btnOcrName">OCR</button>
      </div>
      <div class="sub" id="ocrStatus" style="margin-top:8px"></div>

      <label>Tipo capo</label>
      <select id="garType">
        <option value="top">Camicia / Maglia (TOP)</option>
        <option value="bottom">Pantalone / Gonna (BOTTOM)</option>
        <option value="dress">Abito intero (DRESS)</option>
        <option value="shoes">Scarpe (SHOES)</option>
        <option value="acc">Accessorio (ACC)</option>
      </select>

    </div>

    <div class="modalFoot">
      <span class="sub">Tip: usa screenshot di Amazon ‚Üí ritaglia solo il capo.</span>
      <button class="btn primary" id="btnSaveGar">Salva nel guardaroba</button>
    </div>
  </div>
</div>

<div id="errBox"></div>

<script>
(() => {
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
    setTimeout(()=>{ errBox.style.display="none"; }, 4200);
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida"),
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // Simple state
  const KEY = "sercuctech_vs2d_cropHandles_v1";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.person ??= { dataUrl:"" };
  state.wardrobe ??= []; // {id,name,type,img}
  state.wear ??= { top:null, bottom:null, dress:null, shoes:null, acc:null };
  state.activeView ??= 0;
  state.lastPlaced ??= null;
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // Studio
  const stage = document.getElementById("stage");
  const overlay = document.getElementById("overlay");
  const personImg = document.getElementById("personImg");
  const personFile = document.getElementById("personFile");
  const hint = document.getElementById("hint");

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = () => resolve(String(fr.result));
      fr.onerror = () => reject(fr.error || new Error("FileReader error"));
      fr.readAsDataURL(file);
    });
  }

  function renderPerson(){
    if(state.person.dataUrl){
      personImg.src = state.person.dataUrl;
      hint.style.display = "none";
    }else{
      personImg.removeAttribute("src");
      hint.style.display = "";
    }
  }

  personFile.addEventListener("change", async ()=>{
    const f = personFile.files?.[0];
    if(!f) return;
    try{
      state.person.dataUrl = await fileToDataURL(f);
      save();
      renderPerson();
      status.textContent = "OK";
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Fullscreen
  document.getElementById("btnFullscreen").addEventListener("click", async ()=>{
    try{
      if(!document.fullscreenElement) await stage.requestFullscreen();
      else await document.exitFullscreen();
    }catch{ showErr("Fullscreen non disponibile."); }
  });

  // Simple view rotation label
  const viewLabel = document.getElementById("viewLabel");
  const V = ["FRONTE","FIANCO","RETRO","FIANCO","FRONTE"];
  function setView(v){
    state.activeView = (v+5)%5;
    viewLabel.textContent = V[state.activeView];
    save();
  }
  document.getElementById("btnPrevView").addEventListener("click", ()=>setView(state.activeView-1));
  document.getElementById("btnNextView").addEventListener("click", ()=>setView(state.activeView+1));

  let autoTimer = null;
  const btnAuto = document.getElementById("btnAutoRotate");
  btnAuto.addEventListener("click", ()=>{
    if(autoTimer){ clearInterval(autoTimer); autoTimer=null; btnAuto.textContent="Auto: OFF"; return; }
    btnAuto.textContent="Auto: ON";
    autoTimer = setInterval(()=> setView(state.activeView+1), 550);
  });
  document.getElementById("btnRotateOnce").addEventListener("click", ()=>{
    let seq=[0,1,2,3,4], i=0;
    const t=setInterval(()=>{ setView(seq[i]); i++; if(i>=seq.length) clearInterval(t); }, 420);
  });

  // Wardrobe list
  const wardrobeEl = document.getElementById("wardrobe");
  const wardCount = document.getElementById("wardCount");

  function typeLabel(t){
    return t==="top" ? "Sopra" :
           t==="bottom" ? "Sotto" :
           t==="dress" ? "Intero" :
           t==="shoes" ? "Scarpe" : "Accessori";
  }

  function renderOutfit(){
    overlay.innerHTML = "";
    const order = ["dress","top","bottom","shoes","acc"];
    for(const k of order){
      const id = state.wear[k];
      if(!id) continue;
      const it = state.wardrobe.find(x=>x.id===id);
      if(!it) continue;

      const img = document.createElement("img");
      img.className = "garmentLayer";
      img.src = it.img;
      img.style.left="20%";
      img.style.top= k==="shoes" ? "78%" : (k==="acc" ? "4%" : (k==="bottom" ? "44%" : "16%"));
      img.style.width= k==="shoes" ? "60%" : "60%";
      img.style.height= k==="shoes" ? "18%" : (k==="acc" ? "18%" : (k==="bottom" ? "50%" : "60%"));
      overlay.appendChild(img);
    }
  }

  function renderWardrobe(){
    wardrobeEl.innerHTML="";
    wardCount.textContent = String(state.wardrobe.length);

    for(const it of [...state.wardrobe].reverse()){
      const card = document.createElement("div");
      card.className = "item";

      const th = document.createElement("div");
      th.className="thumb";
      const im = document.createElement("img");
      im.src = it.img;
      th.appendChild(im);

      const meta = document.createElement("div");
      meta.className="meta";
      const t = document.createElement("div");
      t.className="t";
      t.textContent = it.name || "Senza nome";

      const s = document.createElement("div");
      s.className="s";
      s.textContent = `${typeLabel(it.type)}`;

      const p = document.createElement("div");
      p.className="p";

      const wearBtn = document.createElement("button");
      wearBtn.className="btn primary";
      wearBtn.textContent="Metti addosso";
      wearBtn.addEventListener("click", ()=>{
        if(it.type==="dress"){
          state.wear.dress=it.id;
          state.wear.top=null; state.wear.bottom=null;
        }else{
          state.wear[it.type]=it.id;
          if(it.type==="top" || it.type==="bottom") state.wear.dress=null;
        }
        state.lastPlaced=it.id;
        save();
        setTab("studio");
        renderOutfit();
      });

      const delBtn = document.createElement("button");
      delBtn.className="btn";
      delBtn.textContent="Elimina";
      delBtn.addEventListener("click", ()=>{
        state.wardrobe = state.wardrobe.filter(x=>x.id!==it.id);
        for(const k of Object.keys(state.wear)){
          if(state.wear[k]===it.id) state.wear[k]=null;
        }
        save();
        renderWardrobe();
        renderOutfit();
      });

      p.appendChild(wearBtn);
      p.appendChild(delBtn);

      meta.appendChild(t);
      meta.appendChild(s);
      meta.appendChild(p);

      card.appendChild(th);
      card.appendChild(meta);
      wardrobeEl.appendChild(card);
    }
  }

  document.getElementById("btnClearWard").addEventListener("click", ()=>{
    state.wardrobe=[];
    state.wear={ top:null,bottom:null,dress:null,shoes:null,acc:null };
    save();
    renderWardrobe();
    renderOutfit();
  });

  document.getElementById("btnClearOutfit").addEventListener("click", ()=>{
    state.wear={ top:null,bottom:null,dress:null,shoes:null,acc:null };
    save();
    renderOutfit();
  });

  // ===== CROP MODAL con maniglie =====
  const cropModal = document.getElementById("cropModal");
  const btnCloseCrop = document.getElementById("btnCloseCrop");
  const btnAddGarment = document.getElementById("btnAddGarment");

  const btnPick = document.getElementById("btnPick");
  const btnFit = document.getElementById("btnFit");
  const btnNewCrop = document.getElementById("btnNewCrop");
  const btnReset = document.getElementById("btnReset");

  const garFile = document.getElementById("garFile");
  const garName = document.getElementById("garName");
  const garType = document.getElementById("garType");
  const btnSaveGar = document.getElementById("btnSaveGar");

  const btnSelName = document.getElementById("btnSelName");
  const btnCopyName = document.getElementById("btnCopyName");
  const btnPasteName = document.getElementById("btnPasteName");
  const btnOcrName = document.getElementById("btnOcrName");
  const ocrStatus = document.getElementById("ocrStatus");

  const cropShell = document.getElementById("cropShell");
  const cropCanvas = document.getElementById("cropCanvas");
  const ctx = cropCanvas.getContext("2d");

  const cropRectEl = document.getElementById("cropRect");
  const handles = [...cropRectEl.querySelectorAll(".handle")];

  // Image transform
  let img = new Image();
  let imgLoaded = false;
  const imgT = { x:0, y:0, s:1 }; // translate + scale in canvas space

  // Crop rect (in CSS pixels relative to cropShell)
  const cropR = { x:60, y:140, w:240, h:240 };

  function openCrop(){
    cropModal.classList.add("open");
    cropModal.setAttribute("aria-hidden","false");
    requestAnimationFrame(()=> {
      fitCanvas();
      setDefaultCrop();
      syncCropEl();
      draw();
    });
  }
  function closeCrop(){
    cropModal.classList.remove("open");
    cropModal.setAttribute("aria-hidden","true");
  }
  btnAddGarment.addEventListener("click", openCrop);
  btnCloseCrop.addEventListener("click", closeCrop);
  cropModal.addEventListener("click", (e)=>{ if(e.target===cropModal) closeCrop(); });

  btnPick.addEventListener("click", ()=> garFile.click());
  btnNewCrop.addEventListener("click", ()=>{
    setDefaultCrop();
    syncCropEl();
    draw();
  });
  btnReset.addEventListener("click", ()=>{
    resetAll();
  });

  function fitCanvas(){
    const r = cropShell.getBoundingClientRect();
    const dpr = Math.min(2, window.devicePixelRatio||1);
    cropCanvas.width = Math.floor(r.width*dpr);
    cropCanvas.height = Math.floor(r.height*dpr);
    cropCanvas.style.width = r.width+"px";
    cropCanvas.style.height = r.height+"px";
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener("resize", ()=>{
    if(cropModal.classList.contains("open")){
      fitCanvas();
      syncCropEl();
      draw();
    }
  });

  function setDefaultCrop(){
    const W = cropShell.clientWidth;
    const H = cropShell.clientHeight;
    const size = Math.min(W,H)*0.72;
    cropR.w = size;
    cropR.h = size;
    cropR.x = (W-size)/2;
    cropR.y = (H-size)/2;
  }

  function syncCropEl(){
    cropRectEl.style.left = cropR.x+"px";
    cropRectEl.style.top  = cropR.y+"px";
    cropRectEl.style.width = cropR.w+"px";
    cropRectEl.style.height= cropR.h+"px";
  }

  function resetAll(){
    img = new Image();
    imgLoaded = false;
    imgT.x=0; imgT.y=0; imgT.s=1;
    garFile.value="";
    ocrStatus.textContent="";
    setDefaultCrop();
    syncCropEl();
    draw();
  }

  function draw(){
    const W = cropShell.clientWidth;
    const H = cropShell.clientHeight;
    ctx.clearRect(0,0,W,H);
    ctx.fillStyle="#070710";
    ctx.fillRect(0,0,W,H);

    if(!imgLoaded){
      ctx.fillStyle="rgba(255,255,255,.08)";
      ctx.font="600 14px system-ui";
      ctx.fillText("Scegli un'immagine per iniziare", 18, 30);
      status.textContent="OK";
      return;
    }

    // draw image with transform (canvas is in CSS px due to setTransform)
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;
    ctx.save();
    ctx.translate(imgT.x, imgT.y);
    ctx.scale(imgT.s, imgT.s);
    ctx.drawImage(img, 0, 0, iw, ih);
    ctx.restore();

    status.textContent="OK";
  }

  function fitImageToCrop(){
    if(!imgLoaded) return;
    // Fit image so that crop area is filled (cover)
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;

    const scale = Math.max(cropR.w / iw, cropR.h / ih);
    imgT.s = scale;

    // center image within crop
    const drawW = iw * imgT.s;
    const drawH = ih * imgT.s;

    imgT.x = cropR.x + (cropR.w - drawW)/2;
    imgT.y = cropR.y + (cropR.h - drawH)/2;

    draw();
  }
  btnFit.addEventListener("click", fitImageToCrop);

  garFile.addEventListener("change", async ()=>{
    const f = garFile.files?.[0];
    if(!f) return;
    try{
      const url = await fileToDataURL(f);
      img = new Image();
      imgLoaded = false;
      img.onload = ()=>{
        imgLoaded = true;
        // start with a reasonable scale so it is visible
        setDefaultCrop();
        syncCropEl();

        // put image at 0,0 then fit
        imgT.x = 0;
        imgT.y = 0;
        imgT.s = 1;
        fitImageToCrop();
      };
      img.src = url;
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Drag image (pan) anywhere on cropShell (except on handles)
  let pan = null;
  cropShell.addEventListener("pointerdown", (ev)=>{
    const target = ev.target;
    if(target.classList?.contains("handle")) return; // handles handled separately
    if(target === cropRectEl) return; // crop rect drag could be added later; for now pan
    if(!imgLoaded) return;
    pan = { x:ev.clientX, y:ev.clientY, ox:imgT.x, oy:imgT.y };
    cropShell.setPointerCapture(ev.pointerId);
  });
  cropShell.addEventListener("pointermove", (ev)=>{
    if(!pan) return;
    const dx = ev.clientX - pan.x;
    const dy = ev.clientY - pan.y;
    imgT.x = pan.ox + dx;
    imgT.y = pan.oy + dy;
    draw();
  });
  cropShell.addEventListener("pointerup", ()=> pan=null);
  cropShell.addEventListener("pointercancel", ()=> pan=null);

  // Resize crop rect via handles
  let resize = null;
  handles.forEach(h=>{
    h.addEventListener("pointerdown", (ev)=>{
      ev.stopPropagation();
      resize = {
        handle: h.dataset.h,
        x: ev.clientX,
        y: ev.clientY,
        r: { x:cropR.x, y:cropR.y, w:cropR.w, h:cropR.h }
      };
      cropRectEl.setPointerCapture(ev.pointerId);
    });
  });

  cropRectEl.addEventListener("pointermove", (ev)=>{
    if(!resize) return;

    const dx = ev.clientX - resize.x;
    const dy = ev.clientY - resize.y;

    const minSize = 120;
    const W = cropShell.clientWidth;
    const H = cropShell.clientHeight;

    let {x,y,w,h} = resize.r;

    // keep square-ish like your second screenshot
    // use max delta between dx/dy depending on corner
    const d = Math.abs(dx) > Math.abs(dy) ? dx : dy;

    if(resize.handle === "nw"){
      x = x + d;
      y = y + d;
      w = w - d;
      h = h - d;
    }else if(resize.handle === "ne"){
      y = y + d;
      w = w + d;
      h = h - d;
    }else if(resize.handle === "sw"){
      x = x + d;
      w = w - d;
      h = h + d;
    }else if(resize.handle === "se"){
      w = w + d;
      h = h + d;
    }

    // clamp
    w = Math.max(minSize, w);
    h = Math.max(minSize, h);

    // keep inside bounds
    x = Math.max(10, Math.min(x, W - w - 10));
    y = Math.max(10, Math.min(y, H - h - 10));

    cropR.x=x; cropR.y=y; cropR.w=w; cropR.h=h;
    syncCropEl();
    draw();
  });

  cropRectEl.addEventListener("pointerup", ()=>{
    if(resize){ resize=null; }
  });
  cropRectEl.addEventListener("pointercancel", ()=>{
    if(resize){ resize=null; }
  });

  // Copy/paste helpers
  btnSelName.addEventListener("click", ()=>{
    garName.focus(); garName.select();
  });
  btnCopyName.addEventListener("click", async ()=>{
    try{
      garName.focus(); garName.select();
      await navigator.clipboard.writeText(garName.value || "");
      ocrStatus.textContent = "Copiato ‚úÖ";
    }catch{ ocrStatus.textContent = "Copia non disponibile (permessi browser)."; }
  });
  btnPasteName.addEventListener("click", async ()=>{
    try{
      const t = await navigator.clipboard.readText();
      if(t) garName.value = t.trim();
      ocrStatus.textContent = "Incollato ‚úÖ";
    }catch{ ocrStatus.textContent = "Incolla non disponibile (permessi browser)."; }
  });

  // Crop to PNG from current canvas transform + crop rect
  function exportCropPNG(){
    if(!imgLoaded) throw new Error("Prima scegli un'immagine del capo.");

    // We need to map crop rect (CSS px) into the image drawing coordinate system
    // Image is drawn at (imgT.x, imgT.y) with scale imgT.s.
    // So for a canvas pixel P: imageCoord = (P - T) / s
    const sx = (cropR.x - imgT.x) / imgT.s;
    const sy = (cropR.y - imgT.y) / imgT.s;
    const sw = (cropR.w) / imgT.s;
    const sh = (cropR.h) / imgT.s;

    // Clamp within image bounds
    const iw = img.naturalWidth;
    const ih = img.naturalHeight;

    const csx = Math.max(0, sx);
    const csy = Math.max(0, sy);
    const csw = Math.max(1, Math.min(iw - csx, sw));
    const csh = Math.max(1, Math.min(ih - csy, sh));

    const out = document.createElement("canvas");
    out.width = 900; out.height = 900;
    const o = out.getContext("2d");
    o.clearRect(0,0,out.width,out.height);
    o.drawImage(img, csx, csy, csw, csh, 0, 0, out.width, out.height);
    return out.toDataURL("image/png");
  }

  // OCR from crop
  async function ocrFromCrop(){
    try{
      if(!window.Tesseract) return showErr("OCR non disponibile.");
      if(!imgLoaded) return showErr("Prima scegli un'immagine.");

      ocrStatus.textContent = "OCR‚Ä¶ (attendi)";
      btnOcrName.disabled = true;

      const dataUrl = exportCropPNG();
      const res = await Tesseract.recognize(dataUrl, "ita+eng", {
        logger: m => {
          if(m?.status === "recognizing text" && typeof m.progress === "number"){
            ocrStatus.textContent = `OCR‚Ä¶ ${(m.progress*100).toFixed(0)}%`;
          }
        }
      });

      let text = (res?.data?.text || "").trim();
      text = text.split("\n").map(s=>s.trim()).filter(Boolean).join(" ");
      text = text.replace(/\s+/g," ").trim();

      if(!text){
        ocrStatus.textContent = "OCR: nessun testo trovato. Ritaglia solo la zona del testo.";
        return;
      }
      garName.value = text;
      ocrStatus.textContent = "OCR finito ‚úÖ";
    }catch(e){
      showErr(e.message || String(e));
    }finally{
      btnOcrName.disabled = false;
    }
  }
  btnOcrName.addEventListener("click", ocrFromCrop);

  // Save garment
  btnSaveGar.addEventListener("click", ()=>{
    try{
      const name = (garName.value||"").trim() || "Senza nome";
      const type = garType.value;
      const png = exportCropPNG();

      state.wardrobe.push({
        id: "g_" + Math.random().toString(36).slice(2,10),
        name, type, img: png,
        createdAt: Date.now()
      });

      save();
      renderWardrobe();
      closeCrop();
      status.textContent="OK";
    }catch(e){ showErr(e.message || String(e)); }
  });

  // Init wardrobe render
  renderPerson();
  renderWardrobe();
  renderOutfit();
  status.textContent="OK";

})();
</script>
</body>
</html>
