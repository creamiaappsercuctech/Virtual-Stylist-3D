<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 3D</title>
  <meta name="theme-color" content="#0b0b12" />
  <link rel="manifest" href="./manifest.json" />
  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.08);
      --card:rgba(255,255,255,.03); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:10;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,213,106,.12);
      border-color:rgba(255,213,106,.25);
    }

    .grid{ display:grid; grid-template-columns: 1.1fr .9fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
    }
    .card .body{ padding:12px 14px; }

    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input[type="range"], input[type="text"], select{
      width:100%; box-sizing:border-box;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }

    .btn{
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.04);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }
    .btn.danger{
      background:rgba(255,110,110,.10);
      border-color:rgba(255,110,110,.25);
    }

    #threeWrap{
      height:520px;
      background:#090912;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.06);
      overflow:hidden;
      position:relative;
    }
    @media(max-width:980px){ #threeWrap{ height:420px; } }

    .section{ display:none; }
    .section.active{ display:block; }

    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
    }
    .thumb{
      width:84px; height:84px; border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      flex:0 0 auto;
      font-size:12px; color:var(--muted);
    }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }
    .meta .p{ margin-top:8px; display:flex; gap:8px; flex-wrap:wrap; }

    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:99;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.08);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }

    .note{
      border:1px dashed rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      padding:10px 12px;
      border-radius:14px;
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }

    .hr{ height:1px; background:rgba(255,255,255,.06); margin:12px 0; }

    /* Photo modal (viewer) */
    #photoModal{ touch-action:none; }

    /* Picker modal */
    #pickModal{
      position:fixed; inset:0; z-index:10000;
      background:rgba(0,0,0,.92);
      display:none;
      flex-direction:column;
    }
    #pickTop{
      padding:12px; display:flex; gap:10px; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
    }
    #pickTitle{ font-weight:900; }
    #pickHelp{ color:var(--muted); font-size:12px; line-height:1.3; }
    #pickCanvasWrap{
      flex:1 1 auto;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:10px;
    }
    #pickCanvas{
      width:min(100%, 980px);
      height:auto;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background:#0b0b12;
      touch-action: none;
    }
    #pickBottom{
      padding:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      border-top:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.25);
    }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      color:var(--txt);
    }
    td,th{
      border-bottom:1px solid rgba(255,255,255,.08);
      padding:8px 6px;
      text-align:left;
    }
    th{ color:var(--muted); font-weight:700; }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 3D</div>
          <div class="sub">Home unica (Studio / Guardaroba / Business) ‚Ä¢ Misure reali da 2 foto (carta)</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">Avvio‚Ä¶</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="business">Business</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">
      <!-- LEFT: 3D + tools -->
      <div class="card">
        <h2><span>Avatar 3D + prova outfit</span><span class="sub">drag = ruota</span></h2>
        <div class="body">
          <div id="threeWrap"></div>

          <div style="height:10px"></div>

          <div class="row">
            <div style="flex:1 1 240px; min-width:220px">
              <label>Spalle (cm)</label>
              <input id="slShoulders" type="range" min="30" max="56" value="44" />
              <span class="pill">Spalle: <b id="vShoulders">44</b> cm</span>
            </div>
            <div style="flex:1 1 240px; min-width:220px">
              <label>Vita (cm)</label>
              <input id="slWaist" type="range" min="45" max="120" value="86" />
              <span class="pill">Vita: <b id="vWaist">86</b> cm</span>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="btnOutfitBase">Solo base</button>
            <button class="btn" id="btnOutfitCasual">Casual (T-shirt)</button>
            <button class="btn" id="btnOutfitJacket">Con giacca</button>
            <button class="btn" id="btnReset">‚Ü©Ô∏è Reset</button>
          </div>

          <div class="hr"></div>

          <!-- FOTO PERSONA (preview + fullscreen) -->
          <div class="row">
            <button class="btn primary" id="btnUploadPhoto">üì∑ Carica foto persona (singola)</button>
            <button class="btn" id="btnClearPhoto">üóëÔ∏è Rimuovi</button>
            <span class="pill">Foto: <b id="photoStatus">Nessuna</b></span>
          </div>

          <input id="photoInput" type="file" accept="image/*" style="display:none" />

          <div style="height:12px"></div>

          <div class="card" style="border-radius:16px">
            <h2><span>Foto persona (preview)</span><span class="sub">tocca per schermo intero</span></h2>
            <div class="body">
              <img id="photoPreview" alt="Foto persona"
                   style="width:100%; max-height:320px; object-fit:contain; border-radius:14px; border:1px solid rgba(255,255,255,.08); background:rgba(255,255,255,.02); display:none; cursor:pointer;" />
              <div id="photoHint" class="sub">Carica una foto: verr√† mostrata qui. Tocca l‚Äôimmagine per aprirla a schermo intero.</div>
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: sizes + real measurements -->
      <div>
        <div class="card">
          <h2><span>Taglia stimata</span><span class="sub">adulto + bimbo</span></h2>
          <div class="body">
            <label>Profilo (proporzioni avatar + taglie)</label>
            <select id="profile">
              <option value="uomo">Uomo</option>
              <option value="donna">Donna</option>
              <option value="bambino">Bambino</option>
              <option value="bambina">Bambina</option>
            </select>

            <div class="row" style="margin-top:10px">
              <span class="pill">Top: <b id="sizeTop">M</b></span>
              <span class="pill">Pants: <b id="sizePants">48</b></span>
              <span class="pill">EU Shoe: <b id="sizeShoe">42</b></span>
            </div>

            <label>Altezza (cm)</label>
            <input id="heightCm" type="text" inputmode="numeric" placeholder="es. 178" value="178" />

            <div style="height:10px"></div>
            <button class="btn primary" id="btnRecalc">Ricalcola taglie</button>

            <div style="height:10px"></div>
            <div class="sub">
              Suggerimento: dopo che ‚Äúmisure reali‚Äù calcola spalle/vita, questi slider si aggiornano automaticamente.
            </div>
          </div>
        </div>

        <div style="height:14px"></div>

        <div class="card">
          <h2><span>Misure reali ricavate (2 foto + carta)</span><span class="sub">precisione buona con foto dritte</span></h2>
          <div class="body">
            <div class="note">
              ‚úÖ Ti serve: <b>foto frontale</b> + <b>foto laterale</b> e una <b>carta di credito</b> visibile nella foto frontale (vicina al corpo).<br>
              Regole: luce buona, telefono dritto, distanza 2‚Äì3m, corpo intero in foto.
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn primary" id="btnUpFront">‚¨ÜÔ∏è Carica FRONTALE</button>
              <button class="btn primary" id="btnUpSide">‚¨ÜÔ∏è Carica LATERALE</button>
              <span class="pill">Front: <b id="frontOk">NO</b></span>
              <span class="pill">Side: <b id="sideOk">NO</b></span>
            </div>
            <input id="fileFront" type="file" accept="image/*" style="display:none" />
            <input id="fileSide" type="file" accept="image/*" style="display:none" />

            <div style="height:10px"></div>

            <div class="row">
              <button class="btn" id="btnCalibrate">üéØ Calibra carta (4 angoli)</button>
              <span class="pill">Scala: <b id="scaleTxt">non calibrata</b></span>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <button class="btn" id="btnMShoulders">üìè Spalle (front 2 click)</button>
              <button class="btn" id="btnMChestW">üìè Torace larghezza (front)</button>
              <button class="btn" id="btnMWaistW">üìè Vita larghezza (front)</button>
              <button class="btn" id="btnMHipsW">üìè Fianchi larghezza (front)</button>
            </div>

            <div style="height:10px"></div>

            <div class="row">
              <button class="btn" id="btnMChestD">üìê Torace profondit√† (side)</button>
              <button class="btn" id="btnMWaistD">üìê Vita profondit√† (side)</button>
              <button class="btn" id="btnMHipsD">üìê Fianchi profondit√† (side)</button>
              <button class="btn danger" id="btnClearMeasures">üßπ Reset misure</button>
            </div>

            <div class="hr"></div>

            <div class="row">
              <button class="btn primary" id="btnCompute">‚úÖ Calcola misure reali</button>
              <span class="pill">Risultato: <b id="calcStatus">‚Äî</b></span>
            </div>

            <div style="height:10px"></div>

            <div class="card" style="border-radius:16px">
              <h2><span>Risultati (cm)</span><span class="sub">circonferenza stimata = ellisse</span></h2>
              <div class="body" style="overflow:auto">
                <table>
                  <thead>
                    <tr>
                      <th>Parte</th>
                      <th>Larghezza</th>
                      <th>Profondit√†</th>
                      <th>Circonferenza stimata</th>
                    </tr>
                  </thead>
                  <tbody id="tbl">
                    <tr><td colspan="4" class="sub">Carica foto, calibra carta, fai le misure, poi ‚ÄúCalcola‚Äù.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

            <div style="height:10px"></div>
            <div class="sub">
              Nota: la circonferenza √® stima ‚Äúrealistica‚Äù usando larghezza + profondit√†. Se fai bene la foto laterale, migliora molto.
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba multi-store (cards)</span><span class="sub">Acquista = link affiliato</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnAddDemo">Carica demo</button>
          <button class="btn" id="btnClearWardrobe">Svuota</button>
          <span class="pill">Elementi: <b id="wardCount">0</b></span>
        </div>

        <div style="height:12px"></div>
        <div class="cards" id="wardrobe"></div>

        <div style="height:12px"></div>
        <div class="sub">
          Nota: qui puoi incollare link Awin (deeplink) oppure Amazon con tag. (Upgrade: upload immagini per card + categorie + filtri)
        </div>
      </div>
    </div>
  </section>

  <!-- BUSINESS -->
  <section id="business" class="section">
    <div class="grid">
      <div class="card">
        <h2><span>Affiliate settings</span><span class="sub">Awin + Amazon</span></h2>
        <div class="body">
          <label>Awin Publisher ID (opzionale)</label>
          <input id="awinId" type="text" placeholder="es. 123456" />

          <label>Amazon Tag IT</label>
          <input id="amazonTag" type="text" placeholder="es. sercuctech-21" />

          <div style="height:10px"></div>
          <span class="pill">Salvato in: <b>localStorage</b></span>

          <div style="height:12px"></div>
          <div class="sub">
            Awin: incolla direttamente i tuoi link tracciati (deeplink) nelle card.<br/>
            Amazon: incolla link normale e il sistema aggiunge automaticamente <b>?tag=</b>.
          </div>
        </div>
      </div>

      <div class="card">
        <h2><span>Generatore link Amazon</span><span class="sub">aggiunge il tag</span></h2>
        <div class="body">
          <label>Incolla link Amazon</label>
          <input id="amazonIn" type="text" placeholder="https://www.amazon.it/..." />

          <div style="height:10px"></div>
          <button class="btn primary" id="btnAmazonMake">Crea link affiliato</button>

          <label>Link affiliato generato</label>
          <input id="amazonOut" type="text" readonly />

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCopy">Copia</button>
            <button class="btn" id="btnOpen">Apri</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida rapida</span><span class="sub">misure reali con carta</span></h2>
      <div class="body">
        <div class="sub">
          <b>Step 1</b>: Carica FRONTALE + LATERALE (corpo intero).<br>
          <b>Step 2</b>: Nella foto frontale deve vedersi la <b>carta di credito</b> (vicina al corpo). Premi <b>Calibra carta</b> e clicca i 4 angoli.<br>
          <b>Step 3</b>: Premi i bottoni misura e fai 2 click (sinistra/destra oppure davanti/dietro).<br>
          <b>Step 4</b>: Premi <b>Calcola</b>. Le misure (cm) vengono salvate e spalle/vita aggiornano l‚Äôavatar.
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Fullscreen viewer (single photo) -->
<div id="photoModal" style="
  position:fixed; inset:0; z-index:9999;
  background:rgba(0,0,0,.92);
  display:none; align-items:center; justify-content:center;
  padding:12px;">
  <div style="position:absolute; top:12px; left:12px; right:12px; display:flex; justify-content:space-between; gap:10px;">
    <span class="pill">Foto a schermo intero</span>
    <button class="btn primary" id="btnCloseModal">‚úñ Chiudi</button>
  </div>
  <img id="photoFull" alt="Foto schermo intero"
       style="width:100%; height:100%; object-fit:contain; border-radius:16px;" />
</div>

<!-- Picker modal (for calibration + measures) -->
<div id="pickModal">
  <div id="pickTop">
    <div style="min-width:0">
      <div id="pickTitle">Selezione punti</div>
      <div id="pickHelp">‚Äî</div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button class="btn" id="btnPickUndo">‚Ü©Ô∏è Undo</button>
      <button class="btn danger" id="btnPickCancel">‚úñ Chiudi</button>
    </div>
  </div>

  <div id="pickCanvasWrap">
    <canvas id="pickCanvas"></canvas>
  </div>

  <div id="pickBottom">
    <div class="kpi">
      <span class="pill">Punti: <b id="pickCount">0</b></span>
      <span class="pill">Target: <b id="pickTarget">‚Äî</b></span>
      <span class="pill">Fonte: <b id="pickSource">‚Äî</b></span>
    </div>
    <button class="btn primary" id="btnPickDone">‚úÖ Fatto</button>
  </div>
</div>

<div id="errBox"></div>

<script type="module">
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");

  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    business: document.getElementById("business"),
    guida: document.getElementById("guida"),
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs3d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs3d_tab") || "studio");

  // Storage
  const KEY = "sercuctech_vs3d_state_v4_measures_card";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.affiliate ??= { awinId:"", amazonTag:"" };
  state.wardrobe ??= [];
  state.profile ??= "uomo";
  state.heightCm ??= "178";
  state.shoulders ??= 44;
  state.waist ??= 86;

  // photos for measurement (front/side)
  state.meas ??= {
    frontDataUrl: "",
    sideDataUrl: "",
    // calibration
    pxPerCm: 0,
    cardPts: [], // 4 points
    // body points (each: [p1,p2])
    front: { shoulders:null, chestW:null, waistW:null, hipsW:null },
    side:  { chestD:null,  waistD:null,  hipsD:null  },
    results: null
  };

  // single photo viewer
  state.photoDataUrl ??= "";

  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // ---------- helpers ----------
  function dist(a,b){ const dx=a.x-b.x, dy=a.y-b.y; return Math.hypot(dx,dy); }
  function round1(x){ return Math.round(x*10)/10; }
  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  // Ramanujan ellipse circumference
  function ellipseCircumference(widthCm, depthCm){
    if(!(widthCm>0) || !(depthCm>0)) return 0;
    const a = widthCm/2;
    const b = depthCm/2;
    const h = Math.pow((a-b),2)/Math.pow((a+b),2);
    // Ramanujan approximation 2:
    const c = Math.PI*(a+b)*(1 + (3*h)/(10+Math.sqrt(4-3*h)));
    return c;
  }

  // ---------- BUSINESS ----------
  const awinId = document.getElementById("awinId");
  const amazonTag = document.getElementById("amazonTag");
  awinId.value = state.affiliate.awinId || "";
  amazonTag.value = state.affiliate.amazonTag || "";
  awinId.addEventListener("input", ()=>{ state.affiliate.awinId = awinId.value.trim(); save(); });
  amazonTag.addEventListener("input", ()=>{ state.affiliate.amazonTag = amazonTag.value.trim(); save(); });

  function addAmazonTag(url, tag){
    try{
      const u = new URL(url);
      const host = u.hostname.toLowerCase();
      const isAmazon = host.includes("amazon.") || host.includes("amzn.");
      if(!isAmazon) return url;
      if(tag && !u.searchParams.get("tag")) u.searchParams.set("tag", tag);
      return u.toString();
    }catch{
      return url;
    }
  }

  const amazonIn = document.getElementById("amazonIn");
  const amazonOut = document.getElementById("amazonOut");
  document.getElementById("btnAmazonMake").addEventListener("click", ()=>{
    const tag = (state.affiliate.amazonTag || "").trim();
    const src = amazonIn.value.trim();
    amazonOut.value = addAmazonTag(src, tag);
  });
  document.getElementById("btnCopy").addEventListener("click", async ()=>{
    try{ await navigator.clipboard.writeText(amazonOut.value.trim()); }catch{}
  });
  document.getElementById("btnOpen").addEventListener("click", ()=>{
    const u = amazonOut.value.trim();
    if(u) window.open(u, "_blank");
  });

  // ---------- WARDROBE ----------
  const wardrobeEl = document.getElementById("wardrobe");
  const wardCount = document.getElementById("wardCount");

  function renderWardrobe(){
    wardrobeEl.innerHTML = "";
    wardCount.textContent = String(state.wardrobe.length);

    state.wardrobe.forEach((it, idx)=>{
      const card = document.createElement("div");
      card.className = "item";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      thumb.textContent = it.store || "Store";

      const meta = document.createElement("div");
      meta.className = "meta";

      const t = document.createElement("div");
      t.className = "t";
      t.textContent = it.title || "Prodotto";

      const s = document.createElement("div");
      s.className = "s";
      s.textContent = `${it.store || "Store"} ‚Ä¢ ${it.type || "capo"}`;

      const p = document.createElement("div");
      p.className = "p";

      const buy = document.createElement("button");
      buy.className = "btn primary";
      buy.textContent = "Acquista";
      buy.addEventListener("click", ()=>{
        let link = (it.link || "").trim();
        link = addAmazonTag(link, state.affiliate.amazonTag || "");
        if(link) window.open(link, "_blank");
      });

      const del = document.createElement("button");
      del.className = "btn";
      del.textContent = "Elimina";
      del.addEventListener("click", ()=>{
        state.wardrobe.splice(idx, 1);
        save();
        renderWardrobe();
      });

      p.appendChild(buy);
      p.appendChild(del);

      meta.appendChild(t);
      meta.appendChild(s);
      meta.appendChild(p);

      card.appendChild(thumb);
      card.appendChild(meta);
      wardrobeEl.appendChild(card);
    });
  }

  document.getElementById("btnAddDemo").addEventListener("click", ()=>{
    state.wardrobe = [
      { title:"T-shirt basic", store:"Amazon", type:"top", link:"https://www.amazon.it/" },
      { title:"Jeans slim", store:"Zalando", type:"pants", link:"https://www.zalando.it/" },
      { title:"Sneakers", store:"Decathlon", type:"shoes", link:"https://www.decathlon.it/" },
      { title:"Giacca leggera", store:"Amazon", type:"jacket", link:"https://www.amazon.it/" }
    ];
    save();
    renderWardrobe();
    setTab("guardaroba");
  });
  document.getElementById("btnClearWardrobe").addEventListener("click", ()=>{
    state.wardrobe = [];
    save();
    renderWardrobe();
  });
  renderWardrobe();

  // ---------- SIZES + PROFILE ----------
  const slShoulders = document.getElementById("slShoulders");
  const slWaist = document.getElementById("slWaist");
  const vShoulders = document.getElementById("vShoulders");
  const vWaist = document.getElementById("vWaist");
  const heightCm = document.getElementById("heightCm");
  const profile = document.getElementById("profile");
  const sizeTop = document.getElementById("sizeTop");
  const sizePants = document.getElementById("sizePants");
  const sizeShoe = document.getElementById("sizeShoe");

  profile.value = state.profile || "uomo";
  heightCm.value = state.heightCm || "178";
  slShoulders.value = state.shoulders ?? 44;
  slWaist.value = state.waist ?? 86;

  function calcSizes(){
    const sh = Number(slShoulders.value);
    const wa = Number(slWaist.value);
    const h = Number(String(heightCm.value).replace(/[^\d]/g,"")) || 178;
    const p = (profile?.value || "uomo");

    let top = "M";
    let pants = 48;
    let shoe = 42;

    if(p === "uomo" || p === "donna"){
      if(sh < 38) top = "XS";
      else if(sh < 42) top = "S";
      else if(sh < 46) top = "M";
      else if(sh < 50) top = "L";
      else top = "XL";

      if(wa < 72) pants = 42;
      else if(wa < 78) pants = 44;
      else if(wa < 84) pants = 46;
      else if(wa < 90) pants = 48;
      else if(wa < 98) pants = 50;
      else pants = 52;

      if(h < 160) shoe = 38;
      else if(h < 168) shoe = 39;
      else if(h < 174) shoe = 40;
      else if(h < 180) shoe = 41;
      else if(h < 186) shoe = 42;
      else shoe = 43;

      if(p === "donna"){
        if(top === "L") top = "M";
        if(top === "XL") top = "L";
      }
    }

    if(p === "bambino" || p === "bambina"){
      let kid = 116;
      if(h < 98) kid = 92;
      else if(h < 104) kid = 98;
      else if(h < 110) kid = 104;
      else if(h < 116) kid = 110;
      else if(h < 122) kid = 116;
      else if(h < 128) kid = 122;
      else if(h < 134) kid = 128;
      else if(h < 140) kid = 134;
      else if(h < 146) kid = 140;
      else if(h < 152) kid = 146;
      else if(h < 158) kid = 152;
      else if(h < 164) kid = 158;
      else kid = 164;

      top = String(kid);
      pants = String(kid);

      if(h < 100) shoe = 26;
      else if(h < 110) shoe = 28;
      else if(h < 120) shoe = 30;
      else if(h < 130) shoe = 33;
      else if(h < 140) shoe = 35;
      else if(h < 150) shoe = 37;
      else if(h < 160) shoe = 39;
      else shoe = 40;
    }

    sizeTop.textContent = top;
    sizePants.textContent = String(pants);
    sizeShoe.textContent = String(shoe);
  }

  document.getElementById("btnRecalc").addEventListener("click", ()=> calcSizes());

  slShoulders.addEventListener("input", ()=>{
    state.shoulders = Number(slShoulders.value); save();
    applyFromUI(); calcSizes();
  });

  slWaist.addEventListener("input", ()=>{
    state.waist = Number(slWaist.value); save();
    applyFromUI(); calcSizes();
  });

  heightCm.addEventListener("input", ()=>{
    state.heightCm = heightCm.value; save();
    calcSizes();
  });

  profile.addEventListener("change", ()=>{
    state.profile = profile.value; save();
    applyFromUI(); calcSizes();
  });

  // ---------- SINGLE PHOTO UPLOAD + VIEWER ----------
  const btnUploadPhoto = document.getElementById("btnUploadPhoto");
  const btnClearPhoto  = document.getElementById("btnClearPhoto");
  const photoInput     = document.getElementById("photoInput");
  const photoPreview   = document.getElementById("photoPreview");
  const photoFull      = document.getElementById("photoFull");
  const photoModal     = document.getElementById("photoModal");
  const btnCloseModal  = document.getElementById("btnCloseModal");
  const photoStatus    = document.getElementById("photoStatus");
  const photoHint      = document.getElementById("photoHint");

  function readFileAsDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result || ""));
      r.onerror = ()=> reject(new Error("Impossibile leggere il file"));
      r.readAsDataURL(file);
    });
  }

  function setPhotoUI(dataUrl){
    const has = !!dataUrl;
    photoStatus.textContent = has ? "OK" : "Nessuna";
    photoPreview.style.display = has ? "block" : "none";
    photoHint.style.display = has ? "none" : "block";
    if(has){
      photoPreview.src = dataUrl;
      photoFull.src = dataUrl;
    } else {
      photoPreview.removeAttribute("src");
      photoFull.removeAttribute("src");
    }
  }

  btnUploadPhoto.addEventListener("click", ()=> photoInput.click());
  photoInput.addEventListener("change", async ()=>{
    const file = photoInput.files && photoInput.files[0];
    if(!file) return;
    try{
      const dataUrl = await readFileAsDataURL(file);
      state.photoDataUrl = dataUrl;
      save();
      setPhotoUI(dataUrl);
    }catch(e){
      showErr(e.message || String(e));
    }finally{
      photoInput.value = "";
    }
  });
  btnClearPhoto.addEventListener("click", ()=>{
    state.photoDataUrl = "";
    save();
    setPhotoUI("");
  });
  photoPreview.addEventListener("click", ()=>{
    if(!state.photoDataUrl) return;
    photoModal.style.display = "flex";
  });
  btnCloseModal.addEventListener("click", ()=> photoModal.style.display = "none");
  photoModal.addEventListener("click", (e)=>{ if(e.target === photoModal) photoModal.style.display = "none"; });
  setPhotoUI(state.photoDataUrl || "");

  // ---------- REAL MEASUREMENTS (2 photos + credit card) ----------
  const CARD_W_CM = 8.56;   // 85.60 mm
  const CARD_H_CM = 5.398;  // 53.98 mm

  const btnUpFront = document.getElementById("btnUpFront");
  const btnUpSide  = document.getElementById("btnUpSide");
  const fileFront  = document.getElementById("fileFront");
  const fileSide   = document.getElementById("fileSide");
  const frontOk    = document.getElementById("frontOk");
  const sideOk     = document.getElementById("sideOk");
  const btnCalibrate = document.getElementById("btnCalibrate");
  const scaleTxt   = document.getElementById("scaleTxt");

  const btnMShoulders = document.getElementById("btnMShoulders");
  const btnMChestW = document.getElementById("btnMChestW");
  const btnMWaistW = document.getElementById("btnMWaistW");
  const btnMHipsW  = document.getElementById("btnMHipsW");

  const btnMChestD = document.getElementById("btnMChestD");
  const btnMWaistD = document.getElementById("btnMWaistD");
  const btnMHipsD  = document.getElementById("btnMHipsD");

  const btnClearMeasures = document.getElementById("btnClearMeasures");
  const btnCompute = document.getElementById("btnCompute");
  const calcStatus = document.getElementById("calcStatus");
  const tbl = document.getElementById("tbl");

  function refreshMeasBadges(){
    frontOk.textContent = state.meas.frontDataUrl ? "OK" : "NO";
    sideOk.textContent  = state.meas.sideDataUrl ? "OK" : "NO";
    if(state.meas.pxPerCm > 0) scaleTxt.textContent = `${round1(state.meas.pxPerCm)} px/cm`;
    else scaleTxt.textContent = "non calibrata";
  }
  refreshMeasBadges();

  btnUpFront.addEventListener("click", ()=> fileFront.click());
  btnUpSide.addEventListener("click", ()=> fileSide.click());

  fileFront.addEventListener("change", async ()=>{
    const f = fileFront.files && fileFront.files[0];
    if(!f) return;
    try{
      state.meas.frontDataUrl = await readFileAsDataURL(f);
      // reset calibration & front points
      state.meas.pxPerCm = 0;
      state.meas.cardPts = [];
      state.meas.front.shoulders = null;
      state.meas.front.chestW = null;
      state.meas.front.waistW = null;
      state.meas.front.hipsW = null;
      state.meas.results = null;
      save();
      refreshMeasBadges();
      calcStatus.textContent = "Foto frontale caricata";
      renderResultsTable();
    }catch(e){ showErr(e.message || String(e)); }
    finally{ fileFront.value = ""; }
  });

  fileSide.addEventListener("change", async ()=>{
    const f = fileSide.files && fileSide.files[0];
    if(!f) return;
    try{
      state.meas.sideDataUrl = await readFileAsDataURL(f);
      // reset side points
      state.meas.side.chestD = null;
      state.meas.side.waistD = null;
      state.meas.side.hipsD = null;
      state.meas.results = null;
      save();
      refreshMeasBadges();
      calcStatus.textContent = "Foto laterale caricata";
      renderResultsTable();
    }catch(e){ showErr(e.message || String(e)); }
    finally{ fileSide.value = ""; }
  });

  // -------- picker modal logic --------
  const pickModal = document.getElementById("pickModal");
  const pickCanvas = document.getElementById("pickCanvas");
  const pickTitle = document.getElementById("pickTitle");
  const pickHelp = document.getElementById("pickHelp");
  const pickCount = document.getElementById("pickCount");
  const pickTarget = document.getElementById("pickTarget");
  const pickSource = document.getElementById("pickSource");
  const btnPickUndo = document.getElementById("btnPickUndo");
  const btnPickCancel = document.getElementById("btnPickCancel");
  const btnPickDone = document.getElementById("btnPickDone");

  const pctx = pickCanvas.getContext("2d", { willReadFrequently:false });

  let pick = {
    mode: null,          // "card" | "measure"
    source: null,        // "front" | "side"
    targetKey: null,     // e.g. "shoulders" or "chestD"
    need: 0,
    pts: [],
    img: null,
    imgW: 0,
    imgH: 0,
    scale: 1,            // canvas px / image px
    offsetX: 0,
    offsetY: 0
  };

  function openPicker({ mode, source, title, help, targetKey, need }){
    const dataUrl = source === "front" ? state.meas.frontDataUrl : state.meas.sideDataUrl;
    if(!dataUrl){
      showErr("Manca la foto " + (source==="front" ? "FRONTALE" : "LATERALE"));
      return;
    }
    pick.mode = mode;
    pick.source = source;
    pick.targetKey = targetKey;
    pick.need = need;
    pick.pts = [];

    pickTitle.textContent = title;
    pickHelp.textContent = help;
    pickTarget.textContent = targetKey;
    pickSource.textContent = source.toUpperCase();
    pickCount.textContent = "0";

    const img = new Image();
    img.onload = ()=>{
      pick.img = img;
      pick.imgW = img.naturalWidth;
      pick.imgH = img.naturalHeight;

      // fit image to canvas element width
      const maxW = Math.min(window.innerWidth - 20, 980);
      const scale = maxW / pick.imgW;
      const canvasW = Math.round(pick.imgW * scale);
      const canvasH = Math.round(pick.imgH * scale);

      pickCanvas.width = canvasW;
      pickCanvas.height = canvasH;
      pick.scale = scale;
      pick.offsetX = 0;
      pick.offsetY = 0;

      drawPicker();
      pickModal.style.display = "flex";
    };
    img.src = dataUrl;
  }

  function closePicker(){
    pickModal.style.display = "none";
    pick.img = null;
    pick.pts = [];
  }

  function canvasToImagePoint(clientX, clientY){
    const r = pickCanvas.getBoundingClientRect();
    const x = (clientX - r.left) * (pickCanvas.width / r.width);
    const y = (clientY - r.top) * (pickCanvas.height / r.height);
    // convert canvas px to image px
    return { x: x / pick.scale, y: y / pick.scale };
  }

  function drawPicker(){
    if(!pick.img) return;
    pctx.clearRect(0,0,pickCanvas.width, pickCanvas.height);
    pctx.drawImage(pick.img, 0,0, pickCanvas.width, pickCanvas.height);

    // draw points
    for(let i=0;i<pick.pts.length;i++){
      const pt = pick.pts[i];
      const cx = pt.x * pick.scale;
      const cy = pt.y * pick.scale;

      // point
      pctx.beginPath();
      pctx.arc(cx, cy, 7, 0, Math.PI*2);
      pctx.fillStyle = "rgba(255,213,106,.95)";
      pctx.fill();
      pctx.lineWidth = 2;
      pctx.strokeStyle = "rgba(0,0,0,.7)";
      pctx.stroke();

      // number
      pctx.font = "12px system-ui";
      pctx.fillStyle = "rgba(0,0,0,.85)";
      pctx.fillText(String(i+1), cx+10, cy-10);
    }

    // draw line if 2 points for measure
    if(pick.mode === "measure" && pick.pts.length === 2){
      const a = pick.pts[0], b = pick.pts[1];
      pctx.lineWidth = 3;
      pctx.strokeStyle = "rgba(110,255,168,.85)";
      pctx.beginPath();
      pctx.moveTo(a.x*pick.scale, a.y*pick.scale);
      pctx.lineTo(b.x*pick.scale, b.y*pick.scale);
      pctx.stroke();
    }

    // draw rectangle edges if 4 points for card
    if(pick.mode === "card" && pick.pts.length >= 2){
      pctx.lineWidth = 3;
      pctx.strokeStyle = "rgba(110,255,168,.85)";
      pctx.beginPath();
      pctx.moveTo(pick.pts[0].x*pick.scale, pick.pts[0].y*pick.scale);
      for(let i=1;i<pick.pts.length;i++){
        pctx.lineTo(pick.pts[i].x*pick.scale, pick.pts[i].y*pick.scale);
      }
      if(pick.pts.length === 4){
        pctx.lineTo(pick.pts[0].x*pick.scale, pick.pts[0].y*pick.scale);
      }
      pctx.stroke();
    }
  }

  pickCanvas.addEventListener("pointerdown", (e)=>{
    if(!pick.img) return;
    const pt = canvasToImagePoint(e.clientX, e.clientY);
    if(pick.pts.length < pick.need){
      pick.pts.push(pt);
      pickCount.textContent = String(pick.pts.length);
      drawPicker();
    }
  });

  btnPickUndo.addEventListener("click", ()=>{
    if(pick.pts.length>0){
      pick.pts.pop();
      pickCount.textContent = String(pick.pts.length);
      drawPicker();
    }
  });

  btnPickCancel.addEventListener("click", closePicker);

  btnPickDone.addEventListener("click", ()=>{
    if(pick.pts.length !== pick.need){
      showErr(`Servono ${pick.need} punti. Ora: ${pick.pts.length}`);
      return;
    }

    if(pick.mode === "card"){
      // expected 4 points: user clicks corners in order any; we use distances of adjacent edges:
      const pts = pick.pts.slice();
      state.meas.cardPts = pts;

      // Use edges: (1-2) and (3-4) for width, (2-3) and (4-1) for height (assuming user clicks around the card)
      const w1 = dist(pts[0], pts[1]);
      const w2 = dist(pts[2], pts[3]);
      const h1 = dist(pts[1], pts[2]);
      const h2 = dist(pts[3], pts[0]);

      const pxPerCmW = ((w1 + w2)/2) / CARD_W_CM;
      const pxPerCmH = ((h1 + h2)/2) / CARD_H_CM;

      // average
      state.meas.pxPerCm = (pxPerCmW + pxPerCmH)/2;

      save();
      refreshMeasBadges();
      calcStatus.textContent = "Carta calibrata ‚úÖ";
      closePicker();
      return;
    }

    if(pick.mode === "measure"){
      const pts = pick.pts.slice();
      if(pick.source === "front"){
        state.meas.front[pick.targetKey] = pts;
      }else{
        state.meas.side[pick.targetKey] = pts;
      }
      state.meas.results = null;
      save();
      calcStatus.textContent = `Misura salvata: ${pick.targetKey} ‚úÖ`;
      closePicker();
      renderResultsTable();
      return;
    }
  });

  // open pickers
  btnCalibrate.addEventListener("click", ()=>{
    openPicker({
      mode:"card",
      source:"front",
      title:"Calibrazione CARTA (4 angoli)",
      help:"Clicca 4 angoli della carta in ordine (giro completo). Poi premi ‚ÄúFatto‚Äù.",
      targetKey:"card",
      need:4
    });
  });

  function requireScale(){
    if(!(state.meas.pxPerCm>0)){
      showErr("Prima devi calibrare la carta (Calibra carta).");
      return false;
    }
    return true;
  }

  // front width measures
  btnMShoulders.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"front",
      title:"Spalle (FRONTALE)",
      help:"Clicca punto spalla SINISTRA e poi spalla DESTRA (2 click).",
      targetKey:"shoulders",
      need:2
    });
  });
  btnMChestW.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"front",
      title:"Torace LARGHEZZA (FRONTALE)",
      help:"Clicca lato SINISTRO torace e lato DESTRO torace (2 click).",
      targetKey:"chestW",
      need:2
    });
  });
  btnMWaistW.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"front",
      title:"Vita LARGHEZZA (FRONTALE)",
      help:"Clicca lato SINISTRO vita e lato DESTRO vita (2 click).",
      targetKey:"waistW",
      need:2
    });
  });
  btnMHipsW.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"front",
      title:"Fianchi LARGHEZZA (FRONTALE)",
      help:"Clicca lato SINISTRO fianchi e lato DESTRO fianchi (2 click).",
      targetKey:"hipsW",
      need:2
    });
  });

  // side depth measures
  btnMChestD.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"side",
      title:"Torace PROFONDIT√Ä (LATERALE)",
      help:"Clicca punto DAVANTI torace e punto DIETRO torace (2 click).",
      targetKey:"chestD",
      need:2
    });
  });
  btnMWaistD.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"side",
      title:"Vita PROFONDIT√Ä (LATERALE)",
      help:"Clicca punto DAVANTI vita e punto DIETRO vita (2 click).",
      targetKey:"waistD",
      need:2
    });
  });
  btnMHipsD.addEventListener("click", ()=>{
    if(!requireScale()) return;
    openPicker({
      mode:"measure",
      source:"side",
      title:"Fianchi PROFONDIT√Ä (LATERALE)",
      help:"Clicca punto DAVANTI fianchi e punto DIETRO fianchi (2 click).",
      targetKey:"hipsD",
      need:2
    });
  });

  btnClearMeasures.addEventListener("click", ()=>{
    state.meas.pxPerCm = 0;
    state.meas.cardPts = [];
    state.meas.front.shoulders = null;
    state.meas.front.chestW = null;
    state.meas.front.waistW = null;
    state.meas.front.hipsW = null;
    state.meas.side.chestD = null;
    state.meas.side.waistD = null;
    state.meas.side.hipsD = null;
    state.meas.results = null;
    save();
    refreshMeasBadges();
    calcStatus.textContent = "Reset fatto";
    renderResultsTable();
  });

  function measureCm(pair){
    if(!pair || pair.length!==2) return 0;
    if(!(state.meas.pxPerCm>0)) return 0;
    const px = dist(pair[0], pair[1]);
    return px / state.meas.pxPerCm;
  }

  function renderResultsTable(){
    const r = state.meas.results;
    if(!r){
      tbl.innerHTML = `<tr><td colspan="4" class="sub">Carica foto, calibra carta, fai le misure, poi ‚ÄúCalcola‚Äù.</td></tr>`;
      return;
    }
    tbl.innerHTML = `
      <tr>
        <td><b>Spalle</b></td>
        <td>${r.shouldersW>0 ? `${round1(r.shouldersW)} cm` : "‚Äî"}</td>
        <td>‚Äî</td>
        <td>‚Äî</td>
      </tr>
      <tr>
        <td><b>Torace</b></td>
        <td>${r.chestW>0 ? `${round1(r.chestW)} cm` : "‚Äî"}</td>
        <td>${r.chestD>0 ? `${round1(r.chestD)} cm` : "‚Äî"}</td>
        <td>${r.chestC>0 ? `${round1(r.chestC)} cm` : "‚Äî"}</td>
      </tr>
      <tr>
        <td><b>Vita</b></td>
        <td>${r.waistW>0 ? `${round1(r.waistW)} cm` : "‚Äî"}</td>
        <td>${r.waistD>0 ? `${round1(r.waistD)} cm` : "‚Äî"}</td>
        <td>${r.waistC>0 ? `${round1(r.waistC)} cm` : "‚Äî"}</td>
      </tr>
      <tr>
        <td><b>Fianchi</b></td>
        <td>${r.hipsW>0 ? `${round1(r.hipsW)} cm` : "‚Äî"}</td>
        <td>${r.hipsD>0 ? `${round1(r.hipsD)} cm` : "‚Äî"}</td>
        <td>${r.hipsC>0 ? `${round1(r.hipsC)} cm` : "‚Äî"}</td>
      </tr>
    `;
  }

  btnCompute.addEventListener("click", ()=>{
    if(!requireScale()) return;

    const shouldersW = measureCm(state.meas.front.shoulders);
    const chestW = measureCm(state.meas.front.chestW);
    const waistW = measureCm(state.meas.front.waistW);
    const hipsW  = measureCm(state.meas.front.hipsW);

    const chestD = measureCm(state.meas.side.chestD);
    const waistD = measureCm(state.meas.side.waistD);
    const hipsD  = measureCm(state.meas.side.hipsD);

    const chestC = (chestW>0 && chestD>0) ? ellipseCircumference(chestW, chestD) : 0;
    const waistC = (waistW>0 && waistD>0) ? ellipseCircumference(waistW, waistD) : 0;
    const hipsC  = (hipsW>0  && hipsD>0)  ? ellipseCircumference(hipsW,  hipsD)  : 0;

    state.meas.results = { shouldersW, chestW, waistW, hipsW, chestD, waistD, hipsD, chestC, waistC, hipsC };
    save();
    renderResultsTable();

    // update avatar sliders if available
    if(shouldersW>0){
      const sh = clamp(Math.round(shouldersW), 30, 56);
      slShoulders.value = sh;
      state.shoulders = sh;
    }
    if(waistW>0){
      // waistW is width, not circumference -> approximate a bit. We'll map width to slider (reasonable):
      // slider expects waist cm (circumference). If we have waistC use it, else guess from width.
      let waistVal = 0;
      if(waistC>0) waistVal = waistC;
      else waistVal = waistW * 2.8; // rough fallback
      waistVal = clamp(Math.round(waistVal), 45, 120);
      slWaist.value = waistVal;
      state.waist = waistVal;
    }
    save();
    applyFromUI();
    calcSizes();

    calcStatus.textContent = "Calcolato ‚úÖ";
  });

  renderResultsTable();

  // ---------- THREE.JS Avatar ----------
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js";

  const threeWrap = document.getElementById("threeWrap");

  const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:false });
  renderer.setPixelRatio(Math.min(2, window.devicePixelRatio || 1));
  renderer.setSize(threeWrap.clientWidth, threeWrap.clientHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  threeWrap.appendChild(renderer.domElement);

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0b12);

  const camera = new THREE.PerspectiveCamera(45, threeWrap.clientWidth / threeWrap.clientHeight, 0.1, 100);
  camera.position.set(0, 1.55, 4.2);

  const dir = new THREE.DirectionalLight(0xffffff, 1.0); dir.position.set(2,3,2);
  scene.add(dir);
  scene.add(new THREE.AmbientLight(0xffffff, 0.35));

  const floor = new THREE.Mesh(
    new THREE.CircleGeometry(2.0, 64),
    new THREE.MeshStandardMaterial({ color: 0x111118, roughness: 0.9, metalness: 0.1 })
  );
  floor.rotation.x = -Math.PI / 2;
  scene.add(floor);

  function mat(hex, rough=0.8, metal=0.05){
    return new THREE.MeshStandardMaterial({ color: hex, roughness: rough, metalness: metal });
  }

  const avatar = new THREE.Group();
  scene.add(avatar);

  const skinMat   = mat(0xf0c8a8, 0.9, 0.0);
  const baseMat   = mat(0x2a2a3a, 0.85, 0.05);
  const shirtMat  = mat(0x1c2233, 0.9, 0.02);
  const pantsMat  = mat(0x141a2b, 0.92, 0.02);
  const jacketMat = mat(0x2b2320, 0.8, 0.05);

  const head = new THREE.Mesh(new THREE.SphereGeometry(0.22, 32, 32), skinMat); head.position.y = 1.78;
  const neck = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.10, 0.12, 20), skinMat); neck.position.y = 1.6;

  const torso = new THREE.Mesh(new THREE.CylinderGeometry(0.28, 0.34, 0.60, 24), baseMat); torso.position.y = 1.25;
  const pelvis = new THREE.Mesh(new THREE.CylinderGeometry(0.26, 0.30, 0.22, 24), baseMat); pelvis.position.y = 0.92;

  const armL = new THREE.Mesh(new THREE.CylinderGeometry(0.08, 0.10, 0.56, 20), skinMat);
  armL.position.set(-0.46, 1.28, 0); armL.rotation.z = 0.15;
  const armR = armL.clone(); armR.position.x = 0.46; armR.rotation.z = -0.15;

  const legL = new THREE.Mesh(new THREE.CylinderGeometry(0.11, 0.14, 0.78, 20), skinMat); legL.position.set(-0.17, 0.46, 0);
  const legR = legL.clone(); legR.position.x = 0.17;

  const footL = new THREE.Mesh(new THREE.BoxGeometry(0.18, 0.08, 0.34), mat(0x191922, 0.9, 0.05)); footL.position.set(-0.17, 0.06, 0.07);
  const footR = footL.clone(); footR.position.x = 0.17;

  const shirt = new THREE.Mesh(new THREE.CylinderGeometry(0.305, 0.365, 0.62, 24), shirtMat);
  shirt.position.copy(torso.position); shirt.scale.set(1.02,1.02,1.02);

  const pants = new THREE.Mesh(new THREE.CylinderGeometry(0.275, 0.315, 0.28, 24), pantsMat);
  pants.position.copy(pelvis.position); pants.position.y += 0.01; pants.scale.set(1.03,1.03,1.03);

  const jacket = new THREE.Group();
  const jacketBody = new THREE.Mesh(new THREE.CylinderGeometry(0.325, 0.385, 0.66, 24), jacketMat);
  jacketBody.position.copy(torso.position); jacketBody.scale.set(1.03,1.03,1.03);
  const sleeveL = new THREE.Mesh(new THREE.CylinderGeometry(0.10, 0.12, 0.58, 20), jacketMat);
  sleeveL.position.copy(armL.position); sleeveL.rotation.copy(armL.rotation);
  const sleeveR = sleeveL.clone(); sleeveR.position.x *= -1; sleeveR.rotation.z *= -1;
  jacket.add(jacketBody, sleeveL, sleeveR);

  avatar.add(head, neck, torso, pelvis, armL, armR, legL, legR, footL, footR, shirt, pants, jacket);

  // Outfit buttons
  const btnOutfitBase = document.getElementById("btnOutfitBase");
  const btnOutfitCasual = document.getElementById("btnOutfitCasual");
  const btnOutfitJacket = document.getElementById("btnOutfitJacket");
  const btnReset = document.getElementById("btnReset");

  function setOutfit(mode){
    if(mode === "base"){
      shirt.visible = false;
      pants.visible = false;
      jacket.visible = false;
    } else if(mode === "casual"){
      shirt.visible = true;
      pants.visible = true;
      jacket.visible = false;
    } else {
      shirt.visible = true;
      pants.visible = true;
      jacket.visible = true;
    }
  }
  btnOutfitBase.addEventListener("click", ()=> setOutfit("base"));
  btnOutfitCasual.addEventListener("click", ()=> setOutfit("casual"));
  btnOutfitJacket.addEventListener("click", ()=> setOutfit("jacket"));

  // Drag rotate
  let isDown = false, lastX = 0, vel = 0;
  renderer.domElement.addEventListener("pointerdown", (e)=>{
    isDown = true; lastX = e.clientX;
    renderer.domElement.setPointerCapture(e.pointerId);
  });
  renderer.domElement.addEventListener("pointerup", ()=>{ isDown = false; });
  renderer.domElement.addEventListener("pointermove", (e)=>{
    if(!isDown) return;
    const dx = e.clientX - lastX; lastX = e.clientX;
    vel = dx * 0.003;
    avatar.rotation.y += vel;
  });

  function resize(){
    const w = threeWrap.clientWidth, h = threeWrap.clientHeight;
    camera.aspect = w / h; camera.updateProjectionMatrix();
    renderer.setSize(w, h);
  }
  window.addEventListener("resize", resize);

  // Rebuild avatar from sliders + profile proportions
  function rebuild(shouldersCm, waistCm){
    const p = (profile?.value || "uomo");

    let scaleY = 1.0;
    let headScale = 1.0;
    let armScale = 1.0;

    if(p === "donna"){ headScale = 1.02; }
    if(p === "bambino" || p === "bambina"){
      scaleY = 0.82;
      headScale = 1.18;
      armScale = 0.92;
    }

    vShoulders.textContent = shouldersCm;
    vWaist.textContent = waistCm;

    const s = (shouldersCm - 44) / 20;
    const w = (waistCm - 86) / 40;

    const torsoTop = 0.34 * (1 + s*0.55);
    const torsoBot = 0.28 * (1 + w*0.35);

    torso.geometry.dispose();
    torso.geometry = new THREE.CylinderGeometry(torsoBot, torsoTop, 0.60, 24);

    shirt.geometry.dispose();
    shirt.geometry = new THREE.CylinderGeometry(torsoBot*1.08, torsoTop*1.08, 0.62, 24);

    jacketBody.geometry.dispose();
    jacketBody.geometry = new THREE.CylinderGeometry(torsoBot*1.14, torsoTop*1.14, 0.66, 24);

    const pelvisTop = 0.30 * (1 + w*0.35);
    const pelvisBot = 0.26 * (1 + w*0.25);

    pelvis.geometry.dispose();
    pelvis.geometry = new THREE.CylinderGeometry(pelvisBot, pelvisTop, 0.22, 24);

    pants.geometry.dispose();
    pants.geometry = new THREE.CylinderGeometry(pelvisBot*1.06, pelvisTop*1.06, 0.28, 24);

    const armX = 0.46 * (1 + s*0.55);
    armL.position.x = -armX; armR.position.x = armX;
    sleeveL.position.x = armL.position.x;
    sleeveR.position.x = armR.position.x;

    avatar.scale.set(1, scaleY, 1);
    head.scale.set(headScale, headScale, headScale);
    armL.scale.set(1, armScale, 1);
    armR.scale.set(1, armScale, 1);
  }

  function applyFromUI(){
    rebuild(Number(slShoulders.value), Number(slWaist.value));
  }

  btnReset.addEventListener("click", ()=>{
    profile.value = "uomo";
    heightCm.value = "178";
    slShoulders.value = 44;
    slWaist.value = 86;

    state.profile = profile.value;
    state.heightCm = heightCm.value;
    state.shoulders = Number(slShoulders.value);
    state.waist = Number(slWaist.value);
    save();

    applyFromUI();
    calcSizes();
    setOutfit("casual");
  });

  // Init
  applyFromUI();
  calcSizes();
  setOutfit("casual");
  status.textContent = "OK";
  save();

  function animate(){
    requestAnimationFrame(animate);
    avatar.rotation.y += vel * 0.15;
    vel *= 0.88;
    renderer.render(scene, camera);
  }
  animate();
</script>

<!-- PWA: register service worker -->
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(console.error);
    });
  }
</script>
</body>
</html>
