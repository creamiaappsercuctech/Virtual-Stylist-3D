<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SerCucTech ‚Ä¢ Virtual Stylist 2D</title>
  <meta name="theme-color" content="#0b0b12" />

  <style>
    :root{
      --bg:#0b0b12; --txt:#f2f2f5; --muted:#a9a9b6; --line:rgba(255,255,255,.10);
      --card:rgba(255,255,255,.04); --card2:rgba(255,255,255,.02);
      --acc:#ffd56a;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    }
    body{ margin:0; background:var(--bg); color:var(--txt); }
    header{
      position:sticky; top:0; z-index:50;
      background:rgba(11,11,18,.86); backdrop-filter:blur(10px);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{ max-width:1100px; margin:0 auto; padding:14px; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .brand{
      width:40px;height:40px;border-radius:16px;display:grid;place-items:center;
      background:linear-gradient(135deg,rgba(255,213,106,.95),rgba(110,255,168,.35));
      color:#111;font-weight:900;
    }
    .sub{ color:var(--muted); font-size:12px; line-height:1.35; }
    .pill{
      display:inline-flex; gap:8px; align-items:center; padding:6px 10px;
      border-radius:999px; border:1px solid var(--line);
      background:var(--card); color:var(--muted); font-size:12px;
    }
    .pill b{ color:var(--txt); }

    .tabs{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .tab{
      border:1px solid var(--line);
      background:var(--card2);
      color:var(--txt);
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background:rgba(255,213,106,.12);
      border-color:rgba(255,213,106,.25);
    }

    .grid{ display:grid; grid-template-columns: 1.15fr .85fr; gap:14px; }
    @media(max-width:980px){ .grid{ grid-template-columns:1fr; } }

    .card{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:18px;
      overflow:hidden;
    }
    .card h2{
      margin:0; font-size:14px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; justify-content:space-between; align-items:center;
    }
    .card .body{ padding:12px 14px; }

    .btn{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      color:var(--txt);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
    }
    .btn.primary{
      background:rgba(255,213,106,.14);
      border-color:rgba(255,213,106,.25);
    }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    select, input[type="text"]{
      width:100%; box-sizing:border-box;
      padding:10px; border-radius:12px;
      border:1px solid var(--line);
      background:var(--card);
      color:var(--txt);
      outline:none;
    }

    .section{ display:none; }
    .section.active{ display:block; }

    /* STAGE */
    .stageWrap{
      border:1px solid rgba(255,255,255,.10);
      background:#090912;
      border-radius:16px;
      overflow:hidden;
      position:relative;
      height:560px;
    }
    @media(max-width:980px){ .stageWrap{ height:480px; } }

    .stage{
      position:absolute; inset:0;
      display:grid; place-items:center;
      transform-origin:center center;
    }

    /* rotazione */
    .spinOn{ animation: spin 4s linear infinite; }
    @keyframes spin { from{ transform:rotate(0deg); } to{ transform:rotate(360deg); } }

    .canvasArea{
      position:relative;
      width:min(420px, 92vw);
      height:min(520px, 120vw);
      border-radius:16px;
      background:rgba(255,255,255,.03);
      border:1px solid rgba(255,255,255,.08);
      overflow:hidden;
      touch-action:none;
    }

    .layer{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      transform-origin:center center;
      user-select:none;
      -webkit-user-drag:none;
      pointer-events:none;
      max-width:100%;
      max-height:100%;
    }

    /* MODELLO: sempre centrato e ‚Äúa tutta altezza‚Äù */
    #modelImg{
      top:50%;
      transform:translate(-50%,-50%);
      width:92%;
      height:auto;
      opacity:0.98;
    }

    /* overlay outfit */
    #outfitGroup{ position:absolute; inset:0; pointer-events:auto; }

    /* Le immagini vestiti: pi√π piccole + semi trasparenti quando sono placeholder */
    .cloth{
      opacity:0.95;
      width:70%;
      height:auto;
      filter: drop-shadow(0 10px 25px rgba(0,0,0,.45));
    }
    .placeholderCloth{
      opacity:0.25 !important;
      filter:none !important;
    }

    /* posizioni base per tipo */
    .pos-top    { top:33%; }
    .pos-jacket { top:33%; }
    .pos-bottom { top:60%; }
    .pos-skirt  { top:58%; }
    .pos-dress  { top:47%; }
    .pos-shoes  { top:84%; width:55%; }

    .hint{
      position:absolute; left:10px; top:10px; z-index:5;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      color:rgba(255,255,255,.9);
      padding:8px 10px;
      border-radius:12px;
      font-size:12px;
      backdrop-filter: blur(8px);
    }

    /* GUARDAROBA */
    .cards{ display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
    @media(max-width:680px){ .cards{ grid-template-columns:1fr; } }
    .item{
      border:1px solid var(--line);
      background:var(--card2);
      border-radius:16px;
      overflow:hidden;
      display:flex; gap:12px;
      padding:12px;
      cursor:pointer;
    }
    .thumb{
      width:84px; height:84px; border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.03);
      display:grid; place-items:center;
      flex:0 0 auto;
      overflow:hidden;
    }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ flex:1 1 auto; min-width:0; }
    .meta .t{ font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .meta .s{ font-size:12px; color:var(--muted); margin-top:2px; }

    #errBox{
      position:fixed; left:10px; right:10px; bottom:10px; z-index:999;
      border:1px solid rgba(255,110,110,.35);
      background:rgba(255,110,110,.08);
      color:rgba(255,255,255,.95);
      border-radius:14px;
      padding:10px 12px;
      display:none;
      white-space:pre-wrap;
      font-size:12px;
    }

    .mini{
      font-size:12px; color:var(--muted);
      border:1px dashed rgba(255,255,255,.12);
      background:rgba(255,255,255,.02);
      padding:10px;
      border-radius:14px;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="brand">SC</div>
        <div>
          <div style="font-weight:900">SerCucTech ‚Ä¢ Virtual Stylist 2D</div>
          <div class="sub">Persona + vestiti insieme ‚Ä¢ Click capo ‚Üí va addosso ‚Ä¢ Auto-gira</div>
        </div>
      </div>
      <span class="pill">Stato: <b id="status">OK</b></span>
    </div>

    <div class="tabs" role="tablist" aria-label="Sezioni app">
      <div class="tab active" data-tab="studio">Studio</div>
      <div class="tab" data-tab="guardaroba">Guardaroba</div>
      <div class="tab" data-tab="guida">Guida</div>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- STUDIO -->
  <section id="studio" class="section active">
    <div class="grid">

      <div class="card">
        <h2><span>Persona + Outfit</span><span class="sub">drag = sposta ultimo capo</span></h2>
        <div class="body">
          <div class="stageWrap">
            <!-- ROTAZIONE: ruota tutto (persona+vestiti) -->
            <div class="stage" id="spinTarget">
              <div class="canvasArea" id="canvasArea">
                <div class="hint">1) Carica persona ‚Ä¢ 2) Guardaroba ‚Ä¢ 3) Clicca un capo</div>

                <!-- MODELLO -->
                <img id="modelImg" class="layer" alt="modello" />

                <!-- OUTFIT -->
                <div id="outfitGroup">
                  <img id="layerTop"    class="layer cloth pos-top"    alt="top" />
                  <img id="layerJacket" class="layer cloth pos-jacket" alt="jacket" />
                  <img id="layerBottom" class="layer cloth pos-bottom" alt="bottom" />
                  <img id="layerSkirt"  class="layer cloth pos-skirt"  alt="skirt" />
                  <img id="layerDress"  class="layer cloth pos-dress"  alt="dress" />
                  <img id="layerShoes"  class="layer cloth pos-shoes"  alt="shoes" />
                </div>
              </div>
            </div>
          </div>

          <div style="height:10px"></div>

          <div class="row">
            <button class="btn primary" id="btnUploadPerson">üì∑ Carica persona</button>
            <button class="btn" id="btnClearOutfit">üßΩ Svuota outfit</button>
            <button class="btn" id="btnSpin">üîÑ Gira su se stesso: OFF</button>
          </div>

          <div style="height:10px"></div>
          <div class="mini">
            Se vedi scritte tipo ‚ÄúSCARPE‚Äù, sono placeholder: carica un PNG trasparente del capo per avere l‚Äôeffetto realistico.
          </div>
        </div>
      </div>

      <div class="card">
        <h2><span>Carica un vestito nel guardaroba</span><span class="sub">da telefono</span></h2>
        <div class="body">
          <label>Tipo capo</label>
          <select id="uploadType">
            <option value="top">Camicia / Maglia (TOP)</option>
            <option value="jacket">Giacca / Felpa (GIACCA)</option>
            <option value="bottom">Pantalone / Jeans (PANTALONE)</option>
            <option value="skirt">Gonna (GONNA)</option>
            <option value="dress">Vestito / Abito (ABITO)</option>
            <option value="shoes">Scarpe (SCARPE)</option>
          </select>

          <label>Nome capo (facoltativo)</label>
          <input id="uploadName" type="text" placeholder="es. Camicia bianca" />

          <div style="height:10px"></div>
          <button class="btn primary" id="btnUploadCloth">‚¨ÜÔ∏è Aggiungi capo (upload immagine)</button>

          <div style="height:10px"></div>
          <div class="mini">
            Consiglio: PNG con sfondo trasparente (ritaglio). Se usi JPG va lo stesso ma coprir√† la persona.
          </div>

          <div style="height:10px"></div>
          <label>Ultimo capo selezionato (drag)</label>
          <input id="lastType" type="text" readonly value="nessuno" />

          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCenter">üéØ Centra ultimo capo</button>
            <button class="btn" id="btnResetPos">‚Ü©Ô∏è Reset posizioni</button>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- GUARDAROBA -->
  <section id="guardaroba" class="section">
    <div class="card">
      <h2><span>Guardaroba (clicca un capo ‚Üí va addosso)</span><span class="sub">senza link rotti</span></h2>
      <div class="body">
        <div class="row">
          <button class="btn primary" id="btnLoadDefault">üì¶ Carica guardaroba base</button>
          <button class="btn" id="btnClearWard">üßπ Svuota guardaroba</button>
          <span class="pill">Capi: <b id="wardCount">0</b></span>
        </div>

        <label style="margin-top:12px">Filtra per tipo</label>
        <select id="filterType">
          <option value="all">Tutti</option>
          <option value="top">TOP</option>
          <option value="jacket">GIACCA</option>
          <option value="bottom">PANTALONE</option>
          <option value="skirt">GONNA</option>
          <option value="dress">ABITO</option>
          <option value="shoes">SCARPE</option>
        </select>

        <div style="height:12px"></div>
        <div class="cards" id="wardrobe"></div>

        <div style="height:12px"></div>
        <div class="mini">
          Per farlo ‚Äúrealistico‚Äù, carica immagini vestiti: cos√¨ non vedi pi√π scritte giganti.
        </div>
      </div>
    </div>
  </section>

  <!-- GUIDA -->
  <section id="guida" class="section">
    <div class="card">
      <h2><span>Guida</span><span class="sub">passi semplici</span></h2>
      <div class="body">
        <div class="mini">
          <b>1)</b> Studio ‚Üí ‚ÄúCarica persona‚Äù.<br/>
          <b>2)</b> Guardaroba ‚Üí ‚ÄúCarica guardaroba base‚Äù oppure ‚ÄúAggiungi capo (upload)‚Äù.<br/>
          <b>3)</b> Clicca un capo ‚Üí appare addosso nella posizione giusta.<br/>
          <b>4)</b> ‚ÄúGira su se stesso‚Äù ‚Üí ruota persona + outfit insieme.<br/>
          <b>5)</b> Trascina ‚Üí sposta l‚Äôultimo capo aggiunto.
        </div>
      </div>
    </div>
  </section>

</main>

<input id="filePerson" type="file" accept="image/*" style="display:none" />
<input id="fileCloth" type="file" accept="image/*" style="display:none" />

<div id="errBox"></div>

<script>
  const status = document.getElementById("status");
  const errBox = document.getElementById("errBox");
  function showErr(msg){
    errBox.style.display = "block";
    errBox.textContent = "ERRORE:\n" + msg;
    status.textContent = "Errore";
  }
  window.addEventListener("error", (e)=> showErr(e.message || String(e.error||e)));
  window.addEventListener("unhandledrejection", (e)=> showErr(String(e.reason||e)));

  // Tabs
  const tabs = [...document.querySelectorAll(".tab")];
  const sections = {
    studio: document.getElementById("studio"),
    guardaroba: document.getElementById("guardaroba"),
    guida: document.getElementById("guida")
  };
  function setTab(name){
    tabs.forEach(t => t.classList.toggle("active", t.dataset.tab === name));
    Object.entries(sections).forEach(([k, el]) => el.classList.toggle("active", k === name));
    localStorage.setItem("vs2d_tab", name);
  }
  tabs.forEach(t => t.addEventListener("click", ()=> setTab(t.dataset.tab)));
  setTab(localStorage.getItem("vs2d_tab") || "studio");

  // Storage
  const KEY = "sercuctech_vs2d_state_v2";
  const state = JSON.parse(localStorage.getItem(KEY) || "{}");
  state.personDataUrl ??= "";
  state.wardrobe ??= [];
  state.outfit ??= { top:"", jacket:"", bottom:"", skirt:"", dress:"", shoes:"" };
  state.pos ??= {
    top:{x:0,y:0}, jacket:{x:0,y:0}, bottom:{x:0,y:0}, skirt:{x:0,y:0}, dress:{x:0,y:0}, shoes:{x:0,y:0}
  };
  state.lastType ??= "";
  function save(){ localStorage.setItem(KEY, JSON.stringify(state)); }

  // SVG placeholder PI√ô PICCOLO
  function svgData(type, label){
    const map = {
      top:    { t:"TOP",    c:"#ffd56a" },
      jacket: { t:"GIACCA", c:"#ff9a6a" },
      bottom: { t:"PANT",   c:"#6ab7ff" },
      skirt:  { t:"GONNA",  c:"#b86aff" },
      dress:  { t:"ABITO",  c:"#6affb2" },
      shoes:  { t:"SCARPE", c:"#d0d0d0" }
    };
    const x = map[type] || {t:"CAPO", c:"#aaa"};
    const text = label || x.t;
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="700" height="900">
        <rect width="700" height="900" rx="40" fill="rgba(255,255,255,0.06)"/>
        <rect x="26" y="26" width="648" height="848" rx="34" fill="rgba(0,0,0,0.10)" stroke="rgba(255,255,255,0.14)" stroke-width="3"/>
        <text x="50%" y="50%" text-anchor="middle" font-family="system-ui,Segoe UI,Roboto" font-size="70" fill="${x.c}" font-weight="900">${text}</text>
      </svg>`;
    return "data:image/svg+xml;charset=utf-8," + encodeURIComponent(svg);
  }

  // Elements
  const modelImg = document.getElementById("modelImg");
  const layers = {
    top: document.getElementById("layerTop"),
    jacket: document.getElementById("layerJacket"),
    bottom: document.getElementById("layerBottom"),
    skirt: document.getElementById("layerSkirt"),
    dress: document.getElementById("layerDress"),
    shoes: document.getElementById("layerShoes")
  };
  const lastTypeEl = document.getElementById("lastType");
  const wardrobeEl = document.getElementById("wardrobe");
  const wardCount = document.getElementById("wardCount");
  const filterType = document.getElementById("filterType");

  function fileToDataURL(file){
    return new Promise((resolve, reject)=>{
      const r = new FileReader();
      r.onload = ()=> resolve(String(r.result));
      r.onerror = ()=> reject(r.error);
      r.readAsDataURL(file);
    });
  }

  // MODEL
  function renderModel(){
    if(state.personDataUrl){
      modelImg.src = state.personDataUrl;
    }else{
      modelImg.src = svgData("top", "PERSONA");
    }
    modelImg.onerror = ()=>{ modelImg.src = svgData("top","PERSONA"); };
  }

  // placeholder detect: data:image/svg+xml...
  function isPlaceholder(src){
    return !src || String(src).startsWith("data:image/svg+xml");
  }

  function setClothClass(type, src){
    const img = layers[type];
    img.classList.toggle("placeholderCloth", isPlaceholder(src));
  }

  // Apply outfit
  function applyLayer(type, src){
    state.outfit[type] = src || "";
    state.lastType = type;
    lastTypeEl.value = type;

    const img = layers[type];
    const realSrc = src || svgData(type);
    img.src = realSrc;
    img.style.display = "block";
    img.onerror = ()=>{ img.src = svgData(type); setClothClass(type, img.src); };

    setClothClass(type, realSrc);
    applyPos(type);

    save();
  }

  function applyAllOutfit(){
    Object.keys(layers).forEach(type=>{
      const src = state.outfit[type] ? state.outfit[type] : svgData(type);
      layers[type].src = src;
      layers[type].style.display = "block";
      setClothClass(type, src);
      applyPos(type);
      layers[type].onerror = ()=>{ layers[type].src = svgData(type); setClothClass(type, layers[type].src); };
    });
    lastTypeEl.value = state.lastType || "nessuno";
  }

  function applyPos(type){
    const p = state.pos[type] || {x:0,y:0};
    const img = layers[type];

    // mettiamo translateX(-50%) gi√† nel CSS, quindi qui spostiamo con translate
    img.style.transform = `translate(calc(-50% + ${p.x}px), ${p.y}px)`;
  }

  function clearOutfit(){
    state.outfit = { top:"", jacket:"", bottom:"", skirt:"", dress:"", shoes:"" };
    state.lastType = "";
    lastTypeEl.value = "nessuno";
    Object.keys(layers).forEach(type=>{
      layers[type].src = svgData(type);
      layers[type].style.display = "block";
      state.pos[type] = {x:0,y:0};
      setClothClass(type, layers[type].src);
      applyPos(type);
    });
    save();
  }

  // Spin: persona + vestiti
  const spinTarget = document.getElementById("spinTarget");
  const btnSpin = document.getElementById("btnSpin");
  let spinning = false;
  function setSpin(on){
    spinning = !!on;
    spinTarget.classList.toggle("spinOn", spinning);
    btnSpin.textContent = `üîÑ Gira su se stesso: ${spinning ? "ON" : "OFF"}`;
  }
  btnSpin.addEventListener("click", ()=> setSpin(!spinning));

  // Upload person
  const filePerson = document.getElementById("filePerson");
  document.getElementById("btnUploadPerson").addEventListener("click", ()=> filePerson.click());
  filePerson.addEventListener("change", async ()=>{
    const f = filePerson.files && filePerson.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);
    state.personDataUrl = dataUrl;
    save();
    renderModel();
  });

  // Upload cloth
  const fileCloth = document.getElementById("fileCloth");
  const uploadType = document.getElementById("uploadType");
  const uploadName = document.getElementById("uploadName");
  document.getElementById("btnUploadCloth").addEventListener("click", ()=> fileCloth.click());
  fileCloth.addEventListener("change", async ()=>{
    const f = fileCloth.files && fileCloth.files[0];
    if(!f) return;
    const dataUrl = await fileToDataURL(f);

    const type = uploadType.value;
    const title = (uploadName.value || "").trim() || `Capo ${type.toUpperCase()}`;

    state.wardrobe.unshift({
      id: "u_" + Date.now(),
      title,
      type,
      img: dataUrl
    });
    save();
    renderWardrobe();
    setTab("guardaroba");
    uploadName.value = "";
    fileCloth.value = "";
  });

  // Wardrobe default (NO link esterni)
  function defaultWardrobe(){
    return [
      { id:"u_top",    title:"Camicia Uomo",   type:"top",    img: svgData("top","TOP") },
      { id:"u_jacket", title:"Giacca Uomo",    type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"u_bottom", title:"Pantalone Uomo", type:"bottom", img: svgData("bottom","PANT") },
      { id:"u_shoes",  title:"Scarpe Uomo",    type:"shoes",  img: svgData("shoes","SCARPE") },

      { id:"d_top",    title:"Maglia Donna",   type:"top",    img: svgData("top","TOP") },
      { id:"d_jacket", title:"Giacca Donna",   type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"d_skirt",  title:"Gonna Donna",    type:"skirt",  img: svgData("skirt","GONNA") },
      { id:"d_dress",  title:"Vestito Donna",  type:"dress",  img: svgData("dress","ABITO") },

      { id:"b_top",    title:"Maglia Bambino", type:"top",    img: svgData("top","TOP") },
      { id:"b_jacket", title:"Felpa Bambino",  type:"jacket", img: svgData("jacket","GIACCA") },
      { id:"b_bottom", title:"Pantalone Bimbo",type:"bottom", img: svgData("bottom","PANT") },
      { id:"b_shoes",  title:"Scarpe Bimbo",   type:"shoes",  img: svgData("shoes","SCARPE") },

      { id:"bb_top",   title:"Maglia Bambina", type:"top",    img: svgData("top","TOP") },
      { id:"bb_skirt", title:"Gonna Bambina",  type:"skirt",  img: svgData("skirt","GONNA") },
      { id:"bb_dress", title:"Vestito Bimba",  type:"dress",  img: svgData("dress","ABITO") },
      { id:"bb_shoes", title:"Scarpe Bimba",   type:"shoes",  img: svgData("shoes","SCARPE") }
    ];
  }

  document.getElementById("btnLoadDefault").addEventListener("click", ()=>{
    if(!Array.isArray(state.wardrobe) || state.wardrobe.length === 0){
      state.wardrobe = defaultWardrobe();
    }else{
      // aggiunge base senza cancellare
      state.wardrobe = [...defaultWardrobe(), ...state.wardrobe];
    }
    save();
    renderWardrobe();
    setTab("guardaroba");
  });

  document.getElementById("btnClearWard").addEventListener("click", ()=>{
    state.wardrobe = [];
    save();
    renderWardrobe();
  });

  filterType.addEventListener("change", renderWardrobe);

  function renderWardrobe(){
    wardrobeEl.innerHTML = "";
    const list = Array.isArray(state.wardrobe) ? state.wardrobe : [];
    wardCount.textContent = String(list.length);

    const ft = filterType.value;
    const filtered = ft === "all" ? list : list.filter(x => x.type === ft);

    filtered.forEach(item=>{
      const card = document.createElement("div");
      card.className = "item";
      card.title = "Clicca per mettere addosso";

      const thumb = document.createElement("div");
      thumb.className = "thumb";
      const im = document.createElement("img");
      im.src = item.img || svgData(item.type);
      im.onerror = ()=>{ im.src = svgData(item.type); };
      thumb.appendChild(im);

      const meta = document.createElement("div");
      meta.className = "meta";
      const t = document.createElement("div");
      t.className = "t";
      t.textContent = item.title || "Capo";
      const s = document.createElement("div");
      s.className = "s";
      s.textContent = (item.type || "capo").toUpperCase() + " ‚Ä¢ click = addosso";

      meta.appendChild(t);
      meta.appendChild(s);

      card.appendChild(thumb);
      card.appendChild(meta);

      card.addEventListener("click", ()=>{
        applyLayer(item.type, item.img);
        setTab("studio");
      });

      wardrobeEl.appendChild(card);
    });

    if(filtered.length === 0){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.textContent = "Nessun capo in questa categoria. Premi ‚ÄúCarica guardaroba base‚Äù oppure carica un capo tuo.";
      wardrobeEl.appendChild(empty);
    }
  }

  // Outfit buttons
  document.getElementById("btnClearOutfit").addEventListener("click", clearOutfit);

  document.getElementById("btnCenter").addEventListener("click", ()=>{
    const t = state.lastType;
    if(!t) return;
    state.pos[t] = {x:0,y:0};
    applyPos(t);
    save();
  });

  document.getElementById("btnResetPos").addEventListener("click", ()=>{
    Object.keys(state.pos).forEach(k=> state.pos[k] = {x:0,y:0});
    Object.keys(layers).forEach(applyPos);
    save();
  });

  // DRAG: sposta ultimo capo messo
  const outfitGroup = document.getElementById("outfitGroup");
  let dragging = false;
  let startX = 0, startY = 0;
  let baseX = 0, baseY = 0;

  outfitGroup.addEventListener("pointerdown", (ev)=>{
    if(!state.lastType) return;
    dragging = true;
    outfitGroup.setPointerCapture(ev.pointerId);
    startX = ev.clientX; startY = ev.clientY;
    const cur = state.pos[state.lastType] || {x:0,y:0};
    baseX = cur.x; baseY = cur.y;
  });

  outfitGroup.addEventListener("pointermove", (ev)=>{
    if(!dragging || !state.lastType) return;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    state.pos[state.lastType] = { x: Math.round(baseX + dx), y: Math.round(baseY + dy) };
    applyPos(state.lastType);
  });

  outfitGroup.addEventListener("pointerup", ()=>{
    if(!dragging) return;
    dragging = false;
    save();
  });
  outfitGroup.addEventListener("pointercancel", ()=>{
    if(!dragging) return;
    dragging = false;
    save();
  });

  // INIT
  renderModel();
  applyAllOutfit();
  renderWardrobe();
  lastTypeEl.value = state.lastType || "nessuno";
  setSpin(false);
</script>
</body>
</html>
